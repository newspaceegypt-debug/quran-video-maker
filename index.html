<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <title>Ø³ØªÙˆØ¯ÙŠÙˆ Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ - Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ø§Ù„Ù…ÙƒØªÙ…Ù„</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/RecordRTC/5.6.2/RecordRTC.min.js"></script>
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.12.10/dist/umd/ffmpeg.js"></script>
    <script src="https://unpkg.com/@ffmpeg/util@0.12.1/dist/umd/index.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@700&family=Tajawal:wght@500;800&display=swap"
        rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%);
            color: white;
            font-family: 'Tajawal', sans-serif;
            height: 100vh;
            overflow: hidden;
            position: relative;
        }

        /* Ø®Ù„ÙÙŠØ© Ù…ØªØ­Ø±ÙƒØ© */
        body::before {
            content: '';
            position: fixed;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(16, 185, 129, 0.1) 0%, transparent 70%);
            animation: rotate 20s linear infinite;
            z-index: 0;
            pointer-events: none;
        }

        @keyframes rotate {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .editor-grid {
            display: grid;
            grid-template-columns: 380px 1fr 350px;
            height: 100vh;
            position: relative;
            z-index: 10;
        }

        .sidebar {
            background: linear-gradient(180deg, rgba(13, 13, 13, 0.95) 0%, rgba(26, 26, 46, 0.95) 100%);
            backdrop-filter: blur(10px);
            border-left: 1px solid rgba(16, 185, 129, 0.2);
            padding: 15px;
            overflow-y: auto;
            box-shadow: 0 0 30px rgba(16, 185, 129, 0.1);
        }

        .sidebar::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .sidebar::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #10b981, #059669);
            border-radius: 10px;
        }

        .control-group {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.02) 100%);
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(5px);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .control-group::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(16, 185, 129, 0.1), transparent);
            transition: left 0.5s;
        }

        .control-group:hover::before {
            left: 100%;
        }

        .control-group:hover {
            border-color: rgba(16, 185, 129, 0.4);
            box-shadow: 0 5px 20px rgba(16, 185, 129, 0.2);
            transform: translateY(-2px);
        }

        canvas {
            background: #000;
            border-radius: 20px;
            box-shadow:
                0 0 60px rgba(16, 185, 129, 0.3),
                0 0 100px rgba(16, 185, 129, 0.2),
                inset 0 0 20px rgba(0, 0, 0, 0.5);
            max-height: 75vh;
            width: auto;
            border: 3px solid rgba(16, 185, 129, 0.3);
            transition: all 0.3s ease;
        }

        canvas:hover {
            box-shadow:
                0 0 80px rgba(16, 185, 129, 0.4),
                0 0 120px rgba(16, 185, 129, 0.3);
            transform: scale(1.01);
        }

        input[type="range"] {
            accent-color: #10b981;
            width: 100%;
            height: 6px;
            background: linear-gradient(90deg, rgba(16, 185, 129, 0.2), rgba(16, 185, 129, 0.5));
            border-radius: 10px;
            outline: none;
            transition: all 0.3s;
        }

        input[type="range"]:hover {
            background: linear-gradient(90deg, rgba(16, 185, 129, 0.3), rgba(16, 185, 129, 0.6));
        }

        label {
            font-size: 11px;
            color: #aaa;
            margin-top: 8px;
            display: block;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        select,
        input[type="number"] {
            background: #1a1a1a !important;
            border: 1px solid rgba(16, 185, 129, 0.3);
            color: white !important;
            padding: 8px 45px;
            border-radius: 8px;
            width: 100%;
            font-size: 14px;
            transition: all 0.3s;
            font-weight: 600;
            text-align: center;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            position: relative;
        }

        input[type="number"]:focus {
            outline: none;
            border-color: #10b981;
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.3);
            background: #222 !important;
        }

        /* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type="number"] {
            -moz-appearance: textfield;
        }

        /* wrapper Ù„Ù„Ù€ number input */
        .number-input-container {
            position: relative;
            width: 100%;
        }

        /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…Ø¯Ù…Ø¬Ø© */
        .number-input-container .number-btn-inline {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(16, 185, 129, 0.1);
            border: none;
            color: #10b981;
            width: 35px;
            height: calc(100% - 4px);
            border-radius: 6px;
            font-size: 16px;
            font-weight: 900;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }

        .number-input-container .number-btn-inline:hover {
            background: rgba(16, 185, 129, 0.3);
            color: white;
        }

        .number-input-container .number-btn-inline:active {
            background: rgba(16, 185, 129, 0.5);
            transform: translateY(-50%) scale(0.95);
        }

        .number-input-container .btn-plus {
            right: 2px;
        }

        .number-input-container .btn-minus {
            left: 2px;
        }

        select:focus,
        input[type="number"]:focus {
            outline: none;
            border-color: #10b981;
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.3);
            background: #222 !important;
        }

        /* ØªÙ†Ø³ÙŠÙ‚ options Ø¯Ø§Ø®Ù„ select */
        select option {
            background: #1a1a1a !important;
            color: white !important;
            padding: 10px;
            font-size: 13px;
            font-weight: 500;
        }

        select option:hover {
            background: #10b981 !important;
            color: white !important;
        }

        select option:checked {
            background: #10b981 !important;
            color: white !important;
            font-weight: 700;
        }

        /* Ø¥Ø¶Ø§ÙØ© Ø³Ù‡Ù… Ù…Ø®ØµØµ Ù„Ù„Ù€ select */
        select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2310b981' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: left 10px center;
            padding-left: 35px;
        }

        .ayah-card {
            background: linear-gradient(135deg, rgba(24, 24, 24, 0.9), rgba(30, 30, 50, 0.9));
            padding: 12px;
            border-radius: 12px;
            margin-bottom: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .ayah-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(16, 185, 129, 0.2), transparent);
            transition: left 0.5s;
        }

        .ayah-card:hover::before {
            left: 100%;
        }

        .ayah-card:hover {
            transform: translateX(-5px);
            border-color: rgba(16, 185, 129, 0.5);
            box-shadow: 0 5px 20px rgba(16, 185, 129, 0.2);
        }

        .ayah-card.active {
            border-color: #10b981;
            background: linear-gradient(135deg, rgba(13, 33, 26, 0.9), rgba(16, 185, 129, 0.2));
            box-shadow: 0 0 25px rgba(16, 185, 129, 0.4);
            transform: translateX(-5px) scale(1.02);
        }

        button {
            transition: all 0.3s ease;
            font-weight: 700;
            position: relative;
            overflow: hidden;
            border: none;
            cursor: pointer;
            border-radius: 12px;
            padding: 10px 20px;
            font-size: 13px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        button:hover::before {
            width: 300px;
            height: 300px;
        }

        button:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4);
        }

        button:active {
            transform: translateY(-1px) scale(0.98);
        }

        /* Ø£Ø²Ø±Ø§Ø± Ø®Ø§ØµØ© */
        .btn-primary {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4);
            border: 2px solid rgba(16, 185, 129, 0.5);
        }

        .btn-primary:hover {
            box-shadow: 0 12px 30px rgba(16, 185, 129, 0.6);
            border-color: rgba(16, 185, 129, 0.8);
        }

        .btn-secondary {
            background: linear-gradient(135deg, rgba(39, 39, 42, 0.9), rgba(24, 24, 27, 0.9));
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, rgba(50, 50, 55, 0.9), rgba(35, 35, 40, 0.9));
            border-color: rgba(16, 185, 129, 0.3);
        }

        .btn-blue {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4);
            border: 2px solid rgba(59, 130, 246, 0.5);
        }

        .btn-blue:hover {
            box-shadow: 0 12px 30px rgba(59, 130, 246, 0.6);
        }

        #exportBtn {
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
            box-shadow: 0 8px 25px rgba(220, 38, 38, 0.5);
            border: 2px solid rgba(220, 38, 38, 0.6);
            font-size: 18px;
            padding: 16px;
        }

        #exportBtn:hover {
            box-shadow: 0 15px 40px rgba(220, 38, 38, 0.7);
            border-color: rgba(220, 38, 38, 0.9);
        }

        #smartExportBtn {
            background: linear-gradient(135deg, #9333ea 0%, #6b21a8 100%);
            box-shadow: 0 8px 25px rgba(147, 51, 234, 0.5);
            border: 2px solid rgba(147, 51, 234, 0.6);
            font-size: 14px;
            padding: 12px;
        }

        #smartExportBtn:hover {
            box-shadow: 0 15px 40px rgba(147, 51, 234, 0.7);
        }

        h2,
        h3 {
            text-shadow: 0 0 20px rgba(16, 185, 129, 0.5);
        }

        #syncPanel {
            background: linear-gradient(135deg, rgba(39, 39, 42, 0.95), rgba(24, 24, 27, 0.95));
            backdrop-filter: blur(10px);
            border: 2px solid rgba(16, 185, 129, 0.3);
            box-shadow: 0 10px 40px rgba(16, 185, 129, 0.2);
        }

        #syncCounter {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.3), rgba(5, 150, 105, 0.3));
            border: 1px solid rgba(16, 185, 129, 0.5);
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.3);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                box-shadow: 0 0 15px rgba(16, 185, 129, 0.3);
            }

            50% {
                box-shadow: 0 0 25px rgba(16, 185, 129, 0.5);
            }
        }
    </style>
</head>

<body>

    <div class="editor-grid">
        <div class="sidebar">
            <h2 class="text-lg font-black text-emerald-500 mb-4 border-b border-zinc-800 pb-2">ğŸŒ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©
            </h2>

            <div class="control-group">
                <label>Ø£Ø¨Ø¹Ø§Ø¯ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ:</label>
                <div class="grid grid-cols-2 gap-2 mt-1">
                    <button onclick="setMode('portrait')" id="btnP"
                        class="bg-emerald-600 py-2 rounded font-bold text-[10px] border-2 border-white">Ø¹Ù…ÙˆØ¯ÙŠ
                        (Reels)</button>
                    <button onclick="setMode('landscape')" id="btnL"
                        class="bg-zinc-800 py-2 rounded font-bold text-[10px] border-2 border-transparent">Ø£ÙÙ‚ÙŠ
                        (YouTube)</button>
                </div>
            </div>

            <div class="control-group">
                <label>Ø§Ù„Ø³ÙˆØ±Ø© ÙˆØ§Ù„Ù†Ø·Ø§Ù‚:</label>
                <select id="surahSelect" class="mb-2"></select>
                <div class="flex gap-2 mb-3">
                    <div class="flex-1 number-input-container">
                        <button type="button" class="number-btn-inline btn-plus"
                            onclick="document.getElementById('startAyah').stepUp()">+</button>
                        <input type="number" id="startAyah" value="1" min="1">
                        <button type="button" class="number-btn-inline btn-minus"
                            onclick="document.getElementById('startAyah').stepDown()">âˆ’</button>
                    </div>
                    <div class="flex-1 number-input-container">
                        <button type="button" class="number-btn-inline btn-plus"
                            onclick="document.getElementById('endAyah').stepUp()">+</button>
                        <input type="number" id="endAyah" value="3" min="1">
                        <button type="button" class="number-btn-inline btn-minus"
                            onclick="document.getElementById('endAyah').stepDown()">âˆ’</button>
                    </div>
                </div>
                <label>Ø§Ù„Ù‚Ø§Ø±Ø¦ ÙˆØ§Ù„ØªØ±Ø¬Ù…Ø© ÙˆØ§Ù„Ù…Ø¹Ø§Ù†ÙŠ:</label>
                <select id="reciterSelect" class="mb-2">
                    <option value="Alafasy_128kbps">Ù…Ø´Ø§Ø±ÙŠ Ø§Ù„Ø¹ÙØ§Ø³ÙŠ</option>
                    <option value="Abdul_Basit_Murattal_192kbps">Ø¹Ø¨Ø¯ Ø§Ù„Ø¨Ø§Ø³Ø· Ø¹Ø¨Ø¯ Ø§Ù„ØµÙ…Ø¯</option>
                    <option value="Ahmed_ibn_Ali_al-Ajamy_128kbps">Ø£Ø­Ù…Ø¯ Ø§Ù„Ø¹Ø¬Ù…ÙŠ</option>
                    <option value="Fares_Abbad_64kbps">ÙØ§Ø±Ø³ Ø¹Ø¨Ø§Ø¯</option>
                    <option value="Maher_AlMuaiqly_128kbps">Ù…Ø§Ù‡Ø± Ø§Ù„Ù…Ø¹ÙŠÙ‚Ù„ÙŠ</option>
                    <option value="Abdurrahmaan_As-Sudais_192kbps">Ø¹Ø¨Ø¯ Ø§Ù„Ø±Ø­Ù…Ù† Ø§Ù„Ø³Ø¯ÙŠØ³</option>
                    <option value="Abu_Bakr_Ash-Shaatree_128kbps">Ø£Ø¨Ùˆ Ø¨ÙƒØ± Ø§Ù„Ø´Ø§Ø·Ø±ÙŠ</option>
                    <option value="Hani_Rifai_192kbps">Ù‡Ø§Ù†ÙŠ Ø§Ù„Ø±ÙØ§Ø¹ÙŠ</option>
                    <option value="Muhammad_Ayyoub_128kbps">Ù…Ø­Ù…Ø¯ Ø£ÙŠÙˆØ¨</option>
                    <option value="Ghamadi_40kbps">Ø³Ø¹Ø¯ Ø§Ù„ØºØ§Ù…Ø¯ÙŠ</option>
                    <option value="Husary_128kbps">Ù…Ø­Ù…ÙˆØ¯ Ø®Ù„ÙŠÙ„ Ø§Ù„Ø­ØµØ±ÙŠ</option>
                    <option value="Minshawy_Murattal_128kbps">Ù…Ø­Ù…Ø¯ ØµØ¯ÙŠÙ‚ Ø§Ù„Ù…Ù†Ø´Ø§ÙˆÙŠ</option>
                </select>
                <select id="langSelect" class="mb-2">
                    <option value="en.ahmedali">English - Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©</option>
                    <option value="fr.hamidullah">FranÃ§ais - Ø§Ù„ÙØ±Ù†Ø³ÙŠØ©</option>
                    <option value="tr.diyanet">TÃ¼rkÃ§e - Ø§Ù„ØªØ±ÙƒÙŠØ©</option>
                    <option value="ur.jalandhry">Ø§Ø±Ø¯Ùˆ - Urdu</option>
                    <option value="de.bubenheim">Deutsch - Ø§Ù„Ø£Ù„Ù…Ø§Ù†ÙŠØ©</option>
                    <option value="fa.fooladvand">ÙØ§Ø±Ø³ÛŒ - Ø§Ù„ÙØ§Ø±Ø³ÙŠØ©</option>
                    <option value="es.cortes">EspaÃ±ol - Ø§Ù„Ø¥Ø³Ø¨Ø§Ù†ÙŠØ©</option>
                    <option value="ru.kuliev">Ğ ÑƒÑÑĞºĞ¸Ğ¹ - Ø§Ù„Ø±ÙˆØ³ÙŠØ©</option>
                    <option value="id.indonesian">Indonesia - Ø§Ù„Ø¥Ù†Ø¯ÙˆÙ†ÙŠØ³ÙŠØ©</option>
                    <option value="bn.bengali">à¦¬à¦¾à¦‚à¦²à¦¾ - Ø§Ù„Ø¨Ù†ØºØ§Ù„ÙŠØ©</option>
                    <option value="zh.jian">ä¸­æ–‡ - Ø§Ù„ØµÙŠÙ†ÙŠØ©</option>
                    <option value="it.piccardo">Italiano - Ø§Ù„Ø¥ÙŠØ·Ø§Ù„ÙŠØ©</option>
                    <option value="nl.keyzer">Nederlands - Ø§Ù„Ù‡ÙˆÙ„Ù†Ø¯ÙŠØ©</option>
                    <option value="pt.elhayek">PortuguÃªs - Ø§Ù„Ø¨Ø±ØªØºØ§Ù„ÙŠØ©</option>
                    <option value="sw.barwani">Kiswahili - Ø§Ù„Ø³ÙˆØ§Ø­ÙŠÙ„ÙŠØ©</option>
                </select>
                <select id="tafsirSelect" class="mb-2">
                    <option value="ar.muyassar">Ø§Ù„ØªÙØ³ÙŠØ± Ø§Ù„Ù…ÙŠØ³Ø±</option>
                    <option value="ar.saadi">ØªÙØ³ÙŠØ± Ø§Ù„Ø³Ø¹Ø¯ÙŠ</option>
                    <option value="ar.jalalayn">ØªÙØ³ÙŠØ± Ø§Ù„Ø¬Ù„Ø§Ù„ÙŠÙ†</option>
                    <option value="ar.baghawi">ØªÙØ³ÙŠØ± Ø§Ù„Ø¨ØºÙˆÙŠ</option>
                    <option value="ar.qurtubi">ØªÙØ³ÙŠØ± Ø§Ù„Ù‚Ø±Ø·Ø¨ÙŠ</option>
                    <option value="ar.tabari">ØªÙØ³ÙŠØ± Ø§Ù„Ø·Ø¨Ø±ÙŠ</option>
                    <option value="ar.ibnkathir">ØªÙØ³ÙŠØ± Ø§Ø¨Ù† ÙƒØ«ÙŠØ±</option>
                    <option value="ar.waseet">Ø§Ù„ØªÙØ³ÙŠØ± Ø§Ù„ÙˆØ³ÙŠØ·</option>
                    <option value="ar.mukhtasar">Ø§Ù„Ù…Ø®ØªØµØ± ÙÙŠ Ø§Ù„ØªÙØ³ÙŠØ±</option>
                </select>
                <button onclick="importAll()" class="w-full btn-primary py-3 rounded-lg font-bold text-sm mt-2">âœ¨ Ø¬Ù„Ø¨
                    Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
            </div>

            <div class="control-group">
                <h3 class="text-[10px] font-bold text-blue-400 mb-3 uppercase">ğŸµ Ø§Ù„ØµÙˆØª ÙˆØ§Ù„Ø®Ù„ÙÙŠØ©</h3>
                <button onclick="document.getElementById('fullAudioIn').click()"
                    class="w-full btn-blue py-3 rounded-lg text-sm mb-2">ğŸµ Ø±ÙØ¹ ØµÙˆØª Ø§Ù„ØªÙ„Ø§ÙˆØ© Ø§Ù„ÙƒØ§Ù…Ù„</button>
                <p id="audioStatus" class="text-[9px] text-center text-zinc-400 mb-3 font-semibold">Ù„Ù… ÙŠØªÙ… Ø±ÙØ¹ ØµÙˆØª</p>
                <button onclick="document.getElementById('bgIn').click()"
                    class="w-full btn-secondary py-2 rounded-lg text-[11px] mb-2">ğŸ–¼ï¸ Ø±ÙØ¹ Ø®Ù„ÙÙŠØ©</button>
                <button onclick="document.getElementById('logoIn').click()"
                    class="w-full btn-secondary py-2 rounded-lg text-[11px] mb-2">ğŸ›¡ï¸ Ø±ÙØ¹ Ø´Ø¹Ø§Ø±</button>
                <button onclick="document.getElementById('bgAudioIn').click()"
                    class="w-full btn-secondary py-2 rounded-lg text-[11px]">ğŸµ ØµÙˆØª Ø®Ù„ÙÙŠØ©</button>
            </div>

            <div class="control-group">
                <h3 class="text-[10px] font-bold text-emerald-400 mb-2 uppercase">ğŸ¨ Ø§Ù„ØªØ­ÙƒÙ… ÙˆØ§Ù„Ù…Ø¸Ù‡Ø±</h3>
                <label>Ø´ÙØ§ÙÙŠØ© Ø§Ù„Ø®Ù„ÙÙŠØ©:</label>
                <input type="range" id="bgOpacity" min="0" max="1" step="0.05" value="0.7">
                <label>Ø´ÙØ§ÙÙŠØ© Ø§Ù„Ø´Ø¹Ø§Ø±:</label>
                <input type="range" id="logoOpacity" min="0" max="1" step="0.05" value="1">
                <label>ØµÙˆØª Ø§Ù„Ø®Ù„ÙÙŠØ©:</label>
                <input type="range" id="bgVol" min="0" max="1" step="0.05" value="0.2">
            </div>

            <div class="control-group">
                <h3 class="text-[10px] font-bold text-purple-400 mb-2 uppercase">âœ¨ ØªØ£Ø«ÙŠØ±Ø§Øª Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„</h3>
                <label>Ù†ÙˆØ¹ Ø§Ù„ØªØ£Ø«ÙŠØ±:</label>
                <select id="transitionType" class="mb-2">
                    <option value="fade">Fade (ØªÙ„Ø§Ø´ÙŠ)</option>
                    <option value="slide-right">Slide Ù…Ù† Ø§Ù„ÙŠÙ…ÙŠÙ†</option>
                    <option value="slide-left">Slide Ù…Ù† Ø§Ù„ÙŠØ³Ø§Ø±</option>
                    <option value="zoom-in">Zoom In (ØªÙƒØ¨ÙŠØ±)</option>
                    <option value="zoom-out">Zoom Out (ØªØµØºÙŠØ±)</option>
                    <option value="none">Ø¨Ø¯ÙˆÙ† ØªØ£Ø«ÙŠØ±</option>
                </select>
                <label>Ø³Ø±Ø¹Ø© Ø§Ù„ØªØ£Ø«ÙŠØ±:</label>
                <input type="range" id="transitionSpeed" min="0.3" max="2" step="0.1" value="0.8">
                <p class="text-[8px] text-zinc-400 mt-1">Ø§Ù„Ù‚ÙŠÙ…Ø©: <span id="transitionSpeedValue">0.8</span> Ø«Ø§Ù†ÙŠØ©</p>
            </div>

            <div class="control-group">
                <h3 class="text-[10px] font-bold text-yellow-400 mb-2 uppercase">âœï¸ Ù†Øµ Ù…Ø®ØµØµ</h3>
                <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙÙŠØ¯ÙŠÙˆ:</label>
                <input type="text" id="customTitle" placeholder="Ù…Ø«Ø§Ù„: Ø¢ÙŠØ§Øª Ù…Ù† Ø³ÙˆØ±Ø© Ø§Ù„ÙØ§ØªØ­Ø©"
                    class="w-full bg-zinc-900 border border-zinc-700 p-2 rounded text-xs mb-2 text-white">
                <label>Ø§Ø³Ù… Ø§Ù„Ù‚Ù†Ø§Ø©:</label>
                <input type="text" id="channelName" placeholder="Ù…Ø«Ø§Ù„: Ù‚Ù†Ø§Ø© Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ…"
                    class="w-full bg-zinc-900 border border-zinc-700 p-2 rounded text-xs mb-2 text-white">
                <h4 class="text-[9px] font-bold text-zinc-400 mt-3 mb-2">Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¹Ø±Ø¶:</h4>
                <label class="flex items-center gap-2 mt-1">
                    <input type="checkbox" id="showArabicText" checked class="w-4 h-4">
                    <span class="text-[10px]">Ø¹Ø±Ø¶ Ø§Ù„Ù†Øµ Ø§Ù„Ø¹Ø±Ø¨ÙŠ</span>
                </label>
                <label class="flex items-center gap-2 mt-1">
                    <input type="checkbox" id="showMeaning" checked class="w-4 h-4">
                    <span class="text-[10px]">Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¹Ù†Ù‰ (Ø§Ù„ØªÙØ³ÙŠØ±)</span>
                </label>
                <label class="flex items-center gap-2 mt-1">
                    <input type="checkbox" id="showTranslation" checked class="w-4 h-4">
                    <span class="text-[10px]">Ø¹Ø±Ø¶ Ø§Ù„ØªØ±Ø¬Ù…Ø©</span>
                </label>
                <label class="flex items-center gap-2 mt-1">
                    <input type="checkbox" id="showAyahNumber" checked class="w-4 h-4">
                    <span class="text-[10px]">Ø¹Ø±Ø¶ Ø±Ù‚Ù… Ø§Ù„Ø¢ÙŠØ©</span>
                </label>
                <label class="flex items-center gap-2 mt-1">
                    <input type="checkbox" id="showReciterName" checked class="w-4 h-4">
                    <span class="text-[10px]">Ø¹Ø±Ø¶ Ø§Ø³Ù… Ø§Ù„Ù‚Ø§Ø±Ø¦</span>
                </label>
                <label class="flex items-center gap-2 mt-1">
                    <input type="checkbox" id="showDate" class="w-4 h-4">
                    <span class="text-[10px]">Ø¹Ø±Ø¶ Ø§Ù„ØªØ§Ø±ÙŠØ®</span>
                </label>
            </div>

            <div class="control-group">
                <h3 class="text-[10px] font-bold text-cyan-400 mb-2 uppercase">ğŸ¨ Ø®Ù„ÙÙŠØ§Øª Ø¬Ø§Ù‡Ø²Ø©</h3>
                <div class="grid grid-cols-3 gap-2">
                    <div onclick="loadPresetBackground('gradient-green')"
                        class="cursor-pointer rounded-lg overflow-hidden border-2 border-transparent hover:border-emerald-500 transition-all">
                        <div class="h-16 bg-gradient-to-b from-emerald-900 via-emerald-800 to-emerald-700"></div>
                        <p class="text-[8px] text-center py-1 bg-zinc-900">Ø£Ø®Ø¶Ø±</p>
                    </div>
                    <div onclick="loadPresetBackground('gradient-blue')"
                        class="cursor-pointer rounded-lg overflow-hidden border-2 border-transparent hover:border-blue-500 transition-all">
                        <div class="h-16 bg-gradient-to-b from-blue-900 via-blue-800 to-blue-600"></div>
                        <p class="text-[8px] text-center py-1 bg-zinc-900">Ø£Ø²Ø±Ù‚</p>
                    </div>
                    <div onclick="loadPresetBackground('gradient-gold')"
                        class="cursor-pointer rounded-lg overflow-hidden border-2 border-transparent hover:border-yellow-500 transition-all">
                        <div class="h-16 bg-gradient-to-b from-yellow-900 via-yellow-800 to-yellow-700"></div>
                        <p class="text-[8px] text-center py-1 bg-zinc-900">Ø°Ù‡Ø¨ÙŠ</p>
                    </div>
                    <div onclick="loadPresetBackground('gradient-purple')"
                        class="cursor-pointer rounded-lg overflow-hidden border-2 border-transparent hover:border-purple-500 transition-all">
                        <div class="h-16 bg-gradient-to-b from-purple-900 via-purple-800 to-purple-700"></div>
                        <p class="text-[8px] text-center py-1 bg-zinc-900">Ø¨Ù†ÙØ³Ø¬ÙŠ</p>
                    </div>
                    <div onclick="loadPresetBackground('pattern-1')"
                        class="cursor-pointer rounded-lg overflow-hidden border-2 border-transparent hover:border-emerald-500 transition-all">
                        <div class="h-16 bg-slate-900 flex items-center justify-center">
                            <div class="grid grid-cols-3 gap-1">
                                <div class="w-3 h-3 rounded-full border border-emerald-500/30"></div>
                                <div class="w-3 h-3 rounded-full border border-emerald-500/30"></div>
                                <div class="w-3 h-3 rounded-full border border-emerald-500/30"></div>
                            </div>
                        </div>
                        <p class="text-[8px] text-center py-1 bg-zinc-900">Ù†Ù‚ÙˆØ´ 1</p>
                    </div>
                    <div onclick="loadPresetBackground('pattern-2')"
                        class="cursor-pointer rounded-lg overflow-hidden border-2 border-transparent hover:border-blue-500 transition-all">
                        <div class="h-16 bg-slate-950 flex items-center justify-center">
                            <div class="grid grid-cols-4 gap-0.5">
                                <div class="w-2 h-2 border-t border-l border-blue-500/20"></div>
                                <div class="w-2 h-2 border-t border-blue-500/20"></div>
                                <div class="w-2 h-2 border-t border-blue-500/20"></div>
                                <div class="w-2 h-2 border-t border-r border-blue-500/20"></div>
                            </div>
                        </div>
                        <p class="text-[8px] text-center py-1 bg-zinc-900">Ù†Ù‚ÙˆØ´ 2</p>
                    </div>
                    <div onclick="bgMedia = null; alert('âœ… ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø®Ù„ÙÙŠØ©')"
                        class="cursor-pointer rounded-lg overflow-hidden border-2 border-transparent hover:border-red-500 transition-all">
                        <div class="h-16 bg-black flex items-center justify-center">
                            <span class="text-2xl">âŒ</span>
                        </div>
                        <p class="text-[8px] text-center py-1 bg-zinc-900">Ø¨Ø¯ÙˆÙ†</p>
                    </div>
                </div>
                <p class="text-[7px] text-zinc-500 mt-2">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø®Ù„ÙÙŠØ© Ù„Ø§Ø®ØªÙŠØ§Ø±Ù‡Ø§</p>
            </div>

            <div class="control-group">
                <h3 class="text-[10px] font-bold text-pink-400 mb-2 uppercase">ğŸŒ Ø®Ù„ÙÙŠØ§Øª Ù…Ù† Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª</h3>
                <div class="grid grid-cols-2 gap-2 mb-2">
                    <button onclick="fetchRandomBackground('image')" class="btn-secondary py-2 rounded-lg text-[10px]">
                        ğŸ–¼ï¸ ØµÙˆØ±Ø© Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©
                    </button>
                    <button onclick="fetchRandomBackground('video')" class="btn-secondary py-2 rounded-lg text-[10px]">
                        ğŸ¬ ÙÙŠØ¯ÙŠÙˆ Ø¹Ø´ÙˆØ§Ø¦ÙŠ
                    </button>
                </div>
                <div id="randomBgPreview" class="hidden rounded-lg overflow-hidden border-2 border-pink-500 mb-2">
                    <img id="randomBgImg" class="w-full h-24 object-cover" />
                    <div class="bg-zinc-900 p-2 flex gap-2">
                        <button onclick="useRandomBackground()" class="flex-1 bg-emerald-600 py-1 rounded text-[9px]">
                            âœ… Ø§Ø³ØªØ®Ø¯Ø§Ù…
                        </button>
                        <button onclick="fetchRandomBackground(currentBgType)"
                            class="flex-1 bg-blue-600 py-1 rounded text-[9px]">
                            ğŸ”„ Ø¬Ø¯ÙŠØ¯Ø©
                        </button>
                    </div>
                </div>
                <p class="text-[7px] text-zinc-500">Ø®Ù„ÙÙŠØ§Øª Ø¹Ø§Ù„ÙŠØ© Ø§Ù„Ø¬ÙˆØ¯Ø© Ù…Ù† Pexels</p>
            </div>

            <div class="control-group">
                <h3 class="text-[10px] font-bold text-cyan-400 mb-2 uppercase">ğŸµ Ù…ÙˆØ³ÙŠÙ‚Ù‰ Ø¬Ø§Ù‡Ø²Ø©</h3>
                <div class="grid grid-cols-2 gap-2">
                    <div onclick="loadPresetMusic('calm')" id="music-calm"
                        class="cursor-pointer rounded-lg overflow-hidden border-2 border-transparent hover:border-cyan-500 transition-all bg-gradient-to-br from-cyan-900/30 to-cyan-800/30 p-3 text-center">
                        <div class="text-2xl mb-1">ğŸµ</div>
                        <p class="text-[9px] font-bold">Ù‡Ø§Ø¯Ø¦Ø©</p>
                    </div>
                    <div onclick="loadPresetMusic('nature')" id="music-nature"
                        class="cursor-pointer rounded-lg overflow-hidden border-2 border-transparent hover:border-green-500 transition-all bg-gradient-to-br from-green-900/30 to-green-800/30 p-3 text-center">
                        <div class="text-2xl mb-1">ï¿½</div>
                        <p class="text-[9px] font-bold">Ø·Ø¨ÙŠØ¹Ø©</p>
                    </div>
                    <div onclick="loadPresetMusic('ambient')" id="music-ambient"
                        class="cursor-pointer rounded-lg overflow-hidden border-2 border-transparent hover:border-purple-500 transition-all bg-gradient-to-br from-purple-900/30 to-purple-800/30 p-3 text-center">
                        <div class="text-2xl mb-1">ğŸ¼</div>
                        <p class="text-[9px] font-bold">Ù…Ø­ÙŠØ·Ø©</p>
                    </div>
                    <div onclick="loadPresetMusic('')" id="music-none"
                        class="cursor-pointer rounded-lg overflow-hidden border-2 border-emerald-500 hover:border-red-500 transition-all bg-gradient-to-br from-zinc-900/50 to-zinc-800/50 p-3 text-center">
                        <div class="text-2xl mb-1">ğŸ”‡</div>
                        <p class="text-[9px] font-bold">Ø¨Ø¯ÙˆÙ†</p>
                    </div>
                </div>
                <p class="text-[7px] text-zinc-500 mt-2">Ø§Ø¶ØºØ· Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰</p>
            </div>

            <div class="control-group">
                <h3 class="text-[10px] font-bold text-blue-400 mb-2 uppercase">ğŸŒˆ Ø£Ù„ÙˆØ§Ù† Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</h3>
                <label>Ø§Ù„Ø¥Ø¶Ø§Ø¡Ø©:</label> <input type="range" id="fBright" min="50" max="150" value="100">
                <label>Ø§Ù„ØªØ¨Ø§ÙŠÙ†:</label> <input type="range" id="fContrast" min="50" max="150" value="100">
                <label>ØªØºÙŠÙŠØ± Ø§Ù„Ù„ÙˆÙ†:</label> <input type="range" id="fHue" min="0" max="360" value="0">
            </div>

            <div class="control-group">
                <h3 class="text-[10px] font-bold text-red-400 mb-2 uppercase">ğŸ¬ Ø´Ø§Ø´Ø© Ø§Ù„Ø®Ø§ØªÙ…Ø© Ø§Ù„Ù†ØµÙŠØ©</h3>
                <label class="flex items-center gap-2 mb-2">
                    <input type="checkbox" id="enableOutro" class="w-4 h-4">
                    <span class="text-[10px]">ØªÙØ¹ÙŠÙ„ Ø´Ø§Ø´Ø© Ø§Ù„Ø®Ø§ØªÙ…Ø©</span>
                </label>
                <label>Ø§Ù„Ù†Øµ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ:</label>
                <textarea id="outroMainText" placeholder="Ø´ÙƒØ±Ø§Ù‹ Ù„Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©&#10;Ù†Ø³Ø£Ù„ Ø§Ù„Ù„Ù‡ Ø§Ù„Ù‚Ø¨ÙˆÙ„" rows="2"
                    class="w-full bg-zinc-900 border border-zinc-700 p-2 rounded text-xs mb-2 text-white resize-none"></textarea>
                <label>Ø§Ù„Ù†Øµ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ:</label>
                <textarea id="outroSubText" placeholder="Ù„Ø§ ØªÙ†Ø³Ù‰ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ Ø§Ù„Ù‚Ù†Ø§Ø©&#10;ÙˆØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¬Ø±Ø³ ğŸ””" rows="2"
                    class="w-full bg-zinc-900 border border-zinc-700 p-2 rounded text-xs mb-2 text-white resize-none"></textarea>
                <label>Ù†Øµ Ø¥Ø¶Ø§ÙÙŠ:</label>
                <textarea id="outroExtraText" placeholder="Ø¬Ø²Ø§ÙƒÙ… Ø§Ù„Ù„Ù‡ Ø®ÙŠØ±Ø§Ù‹&#10;ÙˆÙ†ÙØ¹ Ø¨ÙƒÙ… Ø§Ù„Ø¥Ø³Ù„Ø§Ù… ÙˆØ§Ù„Ù…Ø³Ù„Ù…ÙŠÙ†" rows="2"
                    class="w-full bg-zinc-900 border border-zinc-700 p-2 rounded text-xs mb-2 text-white resize-none"></textarea>
                <label>Ù…Ø¯Ø© Ø§Ù„Ø¹Ø±Ø¶ (Ø«ÙˆØ§Ù†ÙŠ):</label>
                <div class="number-input-container">
                    <button type="button" class="number-btn-inline btn-plus"
                        onclick="document.getElementById('outroDuration').stepUp()">+</button>
                    <input type="number" id="outroDuration" value="10" min="2" max="20">
                    <button type="button" class="number-btn-inline btn-minus"
                        onclick="document.getElementById('outroDuration').stepDown()">âˆ’</button>
                </div>
                <label class="flex items-center gap-2 mt-3 mb-2">
                    <input type="checkbox" id="useSameBackground" class="w-4 h-4" checked>
                    <span class="text-[10px]">Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù†ÙØ³ Ø®Ù„ÙÙŠØ© Ø§Ù„Ø¹Ø±Ø¶</span>
                </label>
                <label class="mt-2">Ø£Ùˆ Ø§Ø®ØªØ± Ø®Ù„ÙÙŠØ© Ù…Ø®ØµØµØ©:</label>
                <div class="grid grid-cols-3 gap-2 mt-1">
                    <div onclick="selectOutroBackground('gradient-green')" id="outro-bg-green"
                        class="cursor-pointer rounded-lg overflow-hidden border-2 border-emerald-500 hover:border-emerald-400 transition-all">
                        <div class="h-12 bg-gradient-to-b from-emerald-900 via-emerald-800 to-emerald-700"></div>
                        <p class="text-[7px] text-center py-1 bg-zinc-900">Ø£Ø®Ø¶Ø±</p>
                    </div>
                    <div onclick="selectOutroBackground('gradient-blue')" id="outro-bg-blue"
                        class="cursor-pointer rounded-lg overflow-hidden border-2 border-transparent hover:border-blue-400 transition-all">
                        <div class="h-12 bg-gradient-to-b from-blue-900 via-blue-800 to-blue-600"></div>
                        <p class="text-[7px] text-center py-1 bg-zinc-900">Ø£Ø²Ø±Ù‚</p>
                    </div>
                    <div onclick="selectOutroBackground('gradient-purple')" id="outro-bg-purple"
                        class="cursor-pointer rounded-lg overflow-hidden border-2 border-transparent hover:border-purple-400 transition-all">
                        <div class="h-12 bg-gradient-to-b from-purple-900 via-purple-800 to-purple-700"></div>
                        <p class="text-[7px] text-center py-1 bg-zinc-900">Ø¨Ù†ÙØ³Ø¬ÙŠ</p>
                    </div>
                    <div onclick="selectOutroBackground('gradient-gold')" id="outro-bg-gold"
                        class="cursor-pointer rounded-lg overflow-hidden border-2 border-transparent hover:border-yellow-400 transition-all">
                        <div class="h-12 bg-gradient-to-b from-yellow-900 via-yellow-800 to-yellow-700"></div>
                        <p class="text-[7px] text-center py-1 bg-zinc-900">Ø°Ù‡Ø¨ÙŠ</p>
                    </div>
                    <div onclick="selectOutroBackground('dark')" id="outro-bg-dark"
                        class="cursor-pointer rounded-lg overflow-hidden border-2 border-transparent hover:border-zinc-400 transition-all">
                        <div class="h-12 bg-black"></div>
                        <p class="text-[7px] text-center py-1 bg-zinc-900">Ø£Ø³ÙˆØ¯</p>
                    </div>
                </div>
                <button onclick="previewOutroScreen()" class="w-full btn-blue py-2 rounded-lg text-[10px] mt-2">ğŸ‘ï¸
                    Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù†ØµÙˆØµ</button>
            </div>

            <div class="control-group">
                <h3 class="text-[10px] font-bold text-red-400 mb-2 uppercase">ğŸ¬ ÙÙŠØ¯ÙŠÙˆ/ØµÙˆØ±Ø© Ø§Ù„Ø®Ø§ØªÙ…Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</h3>
                <button onclick="document.getElementById('endIn').click()"
                    class="w-full btn-secondary py-3 rounded-lg text-sm border-2 border-dashed border-red-500/30 mb-2 relative">
                    <span id="endBtnText">ğŸ¬ Ø±ÙØ¹ ÙÙŠØ¯ÙŠÙˆ/ØµÙˆØ±Ø© Ø®Ø§ØªÙ…Ø©</span>
                    <span id="endFileName" class="block text-[10px] text-emerald-400 mt-1 hidden"></span>
                </button>
                <button onclick="previewEndMedia()" class="w-full btn-blue py-2 rounded-lg text-[10px]">ğŸ‘ï¸ Ù…Ø¹Ø§ÙŠÙ†Ø©
                    Ø§Ù„ÙÙŠØ¯ÙŠÙˆ/Ø§Ù„ØµÙˆØ±Ø©</button>
            </div>

            <button id="exportBtn" onclick="exportVideo()"
                class="w-full bg-red-600 py-4 rounded-xl font-black text-lg shadow-lg">ğŸš€ ØªØµØ¯ÙŠØ± Ø§Ù„ÙÙŠØ¯ÙŠÙˆ (Ø¬ÙˆØ¯Ø©
                HD)</button>
            <button id="ffmpegExportBtn" onclick="exportWithFFmpeg()"
                class="w-full bg-purple-600 py-4 rounded-xl font-black text-lg shadow-lg mt-2">âš¡ ØªØµØ¯ÙŠØ± Ø³Ø±ÙŠØ¹ FFmpeg (Ø£Ø³Ø±Ø¹
                3x)</button>
            <button id="previewBtn" onclick="previewVideo()"
                class="w-full bg-blue-600 py-3 rounded-xl font-bold text-base shadow-lg mt-2">ğŸ‘ï¸ Ù…Ø¹Ø§ÙŠÙ†Ø©
                Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„ÙƒØ§Ù…Ù„</button>
            <p class="text-[8px] text-center text-zinc-500 mt-2">Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©: ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¨Ø¯ÙˆÙ† ØªØ³Ø¬ÙŠÙ„ | FFmpeg: ØªØµØ¯ÙŠØ± Ø³Ø±ÙŠØ¹
                Ø¨Ø¯ÙˆÙ† ØªØ³Ø¬ÙŠÙ„</p>

            <!-- Ø´Ø±ÙŠØ· ØªÙ‚Ø¯Ù… FFmpeg -->
            <div id="ffmpegProgress" style="display:none;"
                class="w-full mt-4 p-4 bg-zinc-900 rounded-xl border border-purple-500">
                <p id="ffmpegStatus" class="text-center text-white font-bold mb-2">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¶ÙŠØ±...</p>
                <div class="w-full bg-zinc-800 rounded-full h-4 overflow-hidden">
                    <div id="ffmpegProgressBar"
                        class="bg-gradient-to-r from-purple-600 to-pink-600 h-4 transition-all duration-300"
                        style="width: 0%"></div>
                </div>
                <p id="ffmpegDetails" class="text-center text-zinc-400 text-xs mt-2">0%</p>
            </div>
        </div>

        <div class="flex flex-col items-center justify-center p-6 bg-[#030303]">
            <canvas id="mainCanvas" width="720" height="1280" style="max-height: 80vh; max-width: 100%;"></canvas>

            <div id="syncPanel"
                class="mt-4 p-4 bg-zinc-900 rounded-2xl border border-emerald-500/30 flex items-center gap-4 w-full max-w-xl">
                <audio id="player" controls crossorigin="anonymous" class="flex-1"></audio>
                <button onclick="syncNext()"
                    class="btn-primary px-8 py-3 rounded-xl font-bold text-white shadow-lg text-base">â¬‡ï¸ Ø§Ù„Ø¢ÙŠØ©
                    Ø§Ù„ØªØ§Ù„ÙŠØ©</button>
                <button onclick="markEnd()"
                    class="bg-gradient-to-r from-orange-600 to-orange-500 hover:from-orange-500 hover:to-orange-400 px-6 py-3 rounded-xl font-bold text-sm shadow-lg border-2 border-orange-400">ğŸ
                    ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†Ù‡Ø§ÙŠØ©</button>
            </div>

            <audio id="bgMusic" loop crossorigin="anonymous"></audio>
        </div>

        <div class="sidebar border-r border-zinc-800">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-[11px] font-bold text-gray-500 uppercase">ğŸ“‹ ÙƒÙ„ÙŠØ¨Ø§Øª Ø§Ù„Ø¢ÙŠØ§Øª</h3>
                <span id="syncCounter"
                    class="text-[10px] bg-emerald-900/50 px-2 py-1 rounded text-emerald-300">0/0</span>
            </div>
            <div id="clipsList"></div>
        </div>
    </div>

    <input type="file" id="bgIn" accept="image/*,video/*" class="hidden" onchange="loadMedia(this, 'bg')">
    <input type="file" id="logoIn" accept="image/*" class="hidden" onchange="loadMedia(this, 'logo')">
    <input type="file" id="endIn" accept="image/*,video/*" class="hidden" onchange="loadMedia(this, 'end')">
    <input type="file" id="bgAudioIn" accept="audio/*" class="hidden" onchange="loadBgAudio(this)">
    <input type="file" id="singleAudioIn" accept="audio/*" class="hidden" onchange="handleSingleAudio(this)">
    <input type="file" id="fullAudioIn" accept="audio/*" class="hidden" onchange="handleFullAudio(this)">

    <script>
        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d');
        const player = document.getElementById('player');
        const bgMusic = document.getElementById('bgMusic');
        let clips = [], currentIdx = -1, bgMedia = null, logoImg = null, endMedia = null, fade = 0;
        let isEndPhase = false;
        let isOutroPhase = false;

        // Ø¯Ø§Ù„Ø© Ù„Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©/Ø§Ù„ØªØµØ¯ÙŠØ±
        function resetPlayback() {
            currentIdx = -1;
            fade = 0;
            transitionProgress = 0;
            isEndPhase = false;
            isOutroPhase = false;
            outroAnimProgress = 0;
            player.pause();
            player.currentTime = 0;
        }

        // Ù†Ø¸Ø§Ù… Ø§Ù„Ù†Ø¬ÙˆÙ… Ø§Ù„Ù…ØªØ­Ø±ÙƒØ© Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø®Ø§ØªÙ…Ø©
        let outroStars = [];
        function initOutroStars(W, H) {
            outroStars = [];
            // ØªÙ‚Ù„ÙŠÙ„ Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ø¬ÙˆÙ… Ù…Ù† 50 Ø¥Ù„Ù‰ 15 ÙÙ‚Ø·
            for (let i = 0; i < 15; i++) {
                outroStars.push({
                    x: Math.random() * W,
                    y: Math.random() * H,
                    size: Math.random() * 2 + 1,
                    speedX: (Math.random() - 0.5) * 0.3,
                    speedY: (Math.random() - 0.5) * 0.3,
                    opacity: Math.random() * 0.4 + 0.2,
                    twinkle: Math.random() * Math.PI * 2
                });
            }
        }
        let outroStartTime = 0;
        let outroAnimProgress = 0;
        let audioCtx, dest, s1, s2, sEnd;
        let syncPoints = [], videoEndTime = 0;
        let hasFullAudio = false; // Ù…ØªØºÙŠØ± Ù„ØªØªØ¨Ø¹ Ø±ÙØ¹ Ø§Ù„ØµÙˆØª Ø§Ù„ÙƒØ§Ù…Ù„

        // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„ØªØ£Ø«ÙŠØ±Ø§Øª ÙˆØ§Ù„Ù†ØµÙˆØµ
        let transitionProgress = 0;
        let transitionType = 'fade';
        let transitionSpeed = 0.8;
        let customTitle = '';
        let channelName = '';
        let showArabicText = true;
        let showMeaning = true;
        let showTranslation = true;
        let showAyahNumber = true;
        let showReciterName = true;
        let showDate = false;
        let currentReciterName = '';

        // ØªØ­Ø¯ÙŠØ« Ù‚ÙŠÙ…Ø© Ø³Ø±Ø¹Ø© Ø§Ù„ØªØ£Ø«ÙŠØ±
        document.getElementById('transitionSpeed').addEventListener('input', (e) => {
            transitionSpeed = parseFloat(e.target.value);
            document.getElementById('transitionSpeedValue').innerText = transitionSpeed;
        });

        function setMode(mode) {
            canvas.width = (mode === 'portrait') ? 720 : 1280;
            canvas.height = (mode === 'portrait') ? 1280 : 720;
            document.getElementById('btnP').className = mode === 'portrait' ? "bg-emerald-600 py-2 rounded font-bold text-[10px] border-2 border-white" : "bg-zinc-800 py-2 rounded font-bold text-[10px] border-2 border-transparent";
            document.getElementById('btnL').className = mode === 'landscape' ? "bg-emerald-600 py-2 rounded font-bold text-[10px] border-2 border-white" : "bg-zinc-800 py-2 rounded font-bold text-[10px] border-2 border-transparent";
        }

        fetch('https://api.alquran.cloud/v1/surah').then(r => r.json()).then(d => {
            const s = document.getElementById('surahSelect');
            d.data.forEach(item => s.add(new Option(`${item.number}. ${item.name}`, item.number)));
        });

        // Ø¯Ø§Ù„Ø© Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ø³Ù… Ø§Ù„Ù‚Ø§Ø±Ø¦ Ù…Ù† Ø§Ù„ÙƒÙˆØ¯ Ø¥Ù„Ù‰ Ø§Ø³Ù… Ø¹Ø±Ø¨ÙŠ
        function getReciterArabicName(reciterCode) {
            const reciters = {
                'Alafasy_128kbps': 'Ù…Ø´Ø§Ø±ÙŠ Ø§Ù„Ø¹ÙØ§Ø³ÙŠ',
                'Abdul_Basit_Murattal_192kbps': 'Ø¹Ø¨Ø¯ Ø§Ù„Ø¨Ø§Ø³Ø· Ø¹Ø¨Ø¯ Ø§Ù„ØµÙ…Ø¯',
                'Ahmed_ibn_Ali_al-Ajamy_128kbps': 'Ø£Ø­Ù…Ø¯ Ø§Ù„Ø¹Ø¬Ù…ÙŠ',
                'Fares_Abbad_64kbps': 'ÙØ§Ø±Ø³ Ø¹Ø¨Ø§Ø¯',
                'Maher_AlMuaiqly_128kbps': 'Ù…Ø§Ù‡Ø± Ø§Ù„Ù…Ø¹ÙŠÙ‚Ù„ÙŠ',
                'Abdurrahmaan_As-Sudais_192kbps': 'Ø¹Ø¨Ø¯ Ø§Ù„Ø±Ø­Ù…Ù† Ø§Ù„Ø³Ø¯ÙŠØ³',
                'Abu_Bakr_Ash-Shaatree_128kbps': 'Ø£Ø¨Ùˆ Ø¨ÙƒØ± Ø§Ù„Ø´Ø§Ø·Ø±ÙŠ',
                'Hani_Rifai_192kbps': 'Ù‡Ø§Ù†ÙŠ Ø§Ù„Ø±ÙØ§Ø¹ÙŠ',
                'Muhammad_Ayyoub_128kbps': 'Ù…Ø­Ù…Ø¯ Ø£ÙŠÙˆØ¨',
                'Ghamadi_40kbps': 'Ø³Ø¹Ø¯ Ø§Ù„ØºØ§Ù…Ø¯ÙŠ',
                'Husary_128kbps': 'Ù…Ø­Ù…ÙˆØ¯ Ø®Ù„ÙŠÙ„ Ø§Ù„Ø­ØµØ±ÙŠ',
                'Minshawy_Murattal_128kbps': 'Ù…Ø­Ù…Ø¯ ØµØ¯ÙŠÙ‚ Ø§Ù„Ù…Ù†Ø´Ø§ÙˆÙŠ'
            };
            return reciters[reciterCode] || 'Ø§Ù„Ù‚Ø§Ø±Ø¦';
        }

        // Ø¯Ø§Ù„Ø© Ù„ØªØ­ÙˆÙŠÙ„ ÙƒÙˆØ¯ Ø§Ù„Ù‚Ø§Ø±Ø¦ Ø¥Ù„Ù‰ Ù…Ø³Ø§Ø± Ø§Ù„ØµÙˆØª Ø§Ù„ØµØ­ÙŠØ­
        function getReciterAudioPath(reciterCode) {
            // Ø¨Ø¹Ø¶ Ø§Ù„Ù‚Ø±Ø§Ø¡ Ù„Ù‡Ù… Ø£Ø³Ù…Ø§Ø¡ Ù…Ø®ØªÙ„ÙØ© ÙÙŠ everyayah.com
            const audioMapping = {
                'Ahmed_ibn_Ali_al-Ajamy_128kbps': 'Ahmed_ibn_Ali_al-Ajamy_128kbps_ketaballah.net',
                'Maher_AlMuaiqly_128kbps': 'MaherAlMuaiqly128kbps'
            };
            return audioMapping[reciterCode] || reciterCode;
        }

        async function importAll() {
            const sNum = document.getElementById('surahSelect').value;
            const start = parseInt(document.getElementById('startAyah').value);
            const end = parseInt(document.getElementById('endAyah').value);
            const rec = document.getElementById('reciterSelect').value;
            const lang = document.getElementById('langSelect').value;
            const tafsir = document.getElementById('tafsirSelect').value;

            // ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„Ù‚Ø§Ø±Ø¦
            currentReciterName = getReciterArabicName(rec);

            // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø³Ø§Ø± Ø§Ù„ØµÙˆØª Ø§Ù„ØµØ­ÙŠØ­
            const audioPath = getReciterAudioPath(rec);

            const [rAr, rEn, rMa] = await Promise.all([
                fetch(`https://api.alquran.cloud/v1/surah/${sNum}`),
                fetch(`https://api.alquran.cloud/v1/surah/${sNum}/${lang}`),
                fetch(`https://api.alquran.cloud/v1/surah/${sNum}/${tafsir}`)
            ]);
            const dAr = await rAr.json(), dEn = await rEn.json(), dMa = await rMa.json();

            clips = dAr.data.ayahs.slice(start - 1, end).map((a, i) => ({
                ar: a.text,
                trans: dEn.data.ayahs[start - 1 + i].text,
                meaning: dMa.data.ayahs[start - 1 + i].text,
                audio: `https://www.everyayah.com/data/${audioPath}/${String(sNum).padStart(3, '0')}${String(start + i).padStart(3, '0')}.mp3`
            }));
            renderTimeline(); selectClip(0);
        }

        function renderTimeline() {
            document.getElementById('clipsList').innerHTML = clips.map((c, i) => `
                <div class="ayah-card ${i === currentIdx ? 'active' : ''} ${c.syncTime !== undefined ? 'border-emerald-500 bg-emerald-950/30' : ''}" onclick="selectClip(${i})">
                    <div class="flex justify-between items-center mb-1">
                        <p class="text-[10px] font-bold text-emerald-400">Ø¢ÙŠØ© ${i + 1}</p>
                        ${c.syncTime !== undefined ? '<span class="text-emerald-400 text-xs">âœ…</span>' : '<span class="text-zinc-600 text-xs">â±ï¸</span>'}
                    </div>
                    ${c.syncTime !== undefined ? `<p class="text-[8px] text-emerald-300 mb-1">â° ${c.syncTime.toFixed(2)} Ø«Ø§Ù†ÙŠØ©</p>` : ''}
                    <p class="text-[9px] truncate opacity-50" dir="rtl">${c.ar}</p>
                    <button onclick="event.stopPropagation(); currentIdx=${i}; document.getElementById('singleAudioIn').click();" class="text-[8px] bg-zinc-800 py-1 w-full rounded mt-1 border border-zinc-700 hover:bg-emerald-900 text-white">ØªØºÙŠÙŠØ± Ø§Ù„ØµÙˆØª ğŸ”Š</button>
                </div>
            `).join('');

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯
            const synced = clips.filter(c => c.syncTime !== undefined).length;
            document.getElementById('syncCounter').innerText = `${synced}/${clips.length}`;
        }

        function selectClip(idx) {
            isEndPhase = false; currentIdx = idx; renderTimeline(); fade = 0;
            player.src = clips[idx].customAudio || clips[idx].audio;
            player.play().catch(() => { });
        }

        function handleSingleAudio(input) { if (input.files[0]) { clips[currentIdx].customAudio = URL.createObjectURL(input.files[0]); renderTimeline(); selectClip(currentIdx); } }

        function handleFullAudio(input) {
            if (input.files[0]) {
                // Ø¥ÙŠÙ‚Ø§Ù Ø£ÙŠ ØµÙˆØª Ø­Ø§Ù„ÙŠ
                player.pause();
                player.currentTime = 0;

                // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØª Ø§Ù„Ø¬Ø¯ÙŠØ¯
                player.src = URL.createObjectURL(input.files[0]);
                player.load();

                // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„ØµÙˆØª Ø§Ù„ÙƒØ§Ù…Ù„
                hasFullAudio = true;

                // ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª
                player.play().then(() => {
                    document.getElementById('audioStatus').innerText = "âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„ØµÙˆØª ÙˆØ¬Ø§Ø±ÙŠ Ø§Ù„ØªØ´ØºÙŠÙ„";
                    document.getElementById('audioStatus').className = "text-[9px] text-center text-emerald-400 mb-3 font-bold";
                }).catch(err => {
                    console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª:', err);
                    document.getElementById('audioStatus').innerText = "âš ï¸ ØªÙ… Ø§Ù„Ø±ÙØ¹ - Ø§Ø¶ØºØ· ØªØ´ØºÙŠÙ„ ÙŠØ¯ÙˆÙŠØ§Ù‹";
                    document.getElementById('audioStatus').className = "text-[9px] text-center text-yellow-400 mb-3 font-bold";
                });
            }
        }

        // Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
        function syncNext() {
            let nextIdx = clips.findIndex((c, i) => i >= 0 && c.syncTime === undefined);
            if (nextIdx !== -1) {
                clips[nextIdx].syncTime = player.currentTime;
                currentIdx = nextIdx;
                renderTimeline();

                // Ø±Ø³Ø§Ù„Ø© ØªÙˆØ¶ÙŠØ­ÙŠØ©
                const remaining = clips.filter(c => c.syncTime === undefined).length;
                if (remaining > 0) {
                    document.getElementById('exportBtn').innerText = `âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¢ÙŠØ© ${nextIdx + 1} | Ù…ØªØ¨Ù‚ÙŠ: ${remaining} Ø¢ÙŠØ©`;
                } else {
                    document.getElementById('exportBtn').innerText = "ğŸ‰ ØªÙ… Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©! Ø­Ø¯Ø¯ Ø§Ù„Ù†Ù‡Ø§ÙŠØ© Ø«Ù… ØµØ¯Ù‘Ø±";
                }
            } else {
                document.getElementById('exportBtn').innerText = "âœ… ØªÙ… Ù…Ø²Ø§Ù…Ù†Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¢ÙŠØ§Øª";
            }
        }

        function markEnd() {
            videoEndTime = player.currentTime;
            document.getElementById('exportBtn').innerText = "ğŸš€ Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØµØ¯ÙŠØ± (Ø¬ÙˆØ¯Ø© HD)";
        }

        function loadMedia(input, type) {
            if (!input.files || !input.files[0]) return;
            const file = input.files[0];
            const url = URL.createObjectURL(file);
            const fileName = file.name;

            if (file.type.startsWith('video')) {
                const v = document.createElement('video');
                v.src = url;
                v.crossOrigin = "anonymous";
                v.muted = true;
                v.loop = (type === 'bg');
                v.play();
                if (type === 'bg') bgMedia = v;
                else if (type === 'end') {
                    endMedia = v;
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Øµ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø²Ø±
                    document.getElementById('endBtnText').innerText = 'âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ';
                    document.getElementById('endFileName').innerText = fileName;
                    document.getElementById('endFileName').classList.remove('hidden');
                }
            } else if (file.type.startsWith('image')) {
                const img = new Image();
                img.src = url;
                img.crossOrigin = "anonymous";
                img.onload = () => {
                    if (type === 'bg') bgMedia = img;
                    else if (type === 'logo') logoImg = img;
                    else if (type === 'end') {
                        endMedia = img;
                        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Øµ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø²Ø±
                        document.getElementById('endBtnText').innerText = 'âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©';
                        document.getElementById('endFileName').innerText = fileName;
                        document.getElementById('endFileName').classList.remove('hidden');
                    }
                };
            }
        }

        function loadBgAudio(input) { bgMusic.src = URL.createObjectURL(input.files[0]); bgMusic.play(); }

        // Ù…Ø¹Ø§ÙŠÙ†Ø© ÙÙŠØ¯ÙŠÙˆ/ØµÙˆØ±Ø© Ø§Ù„Ø®Ø§ØªÙ…Ø©
        function previewEndMedia() {
            if (!endMedia) {
                alert('âš ï¸ ÙŠØ¬Ø¨ Ø±ÙØ¹ ÙÙŠØ¯ÙŠÙˆ Ø£Ùˆ ØµÙˆØ±Ø© Ø®Ø§ØªÙ…Ø© Ø£ÙˆÙ„Ø§Ù‹!');
                return;
            }

            // ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ø®Ø§ØªÙ…Ø©
            isEndPhase = true;
            player.pause();

            // Ø¥Ø°Ø§ ÙƒØ§Ù† ÙÙŠØ¯ÙŠÙˆØŒ Ø´ØºÙ„Ù‡
            if (endMedia.tagName === 'VIDEO') {
                endMedia.currentTime = 0;
                endMedia.muted = false;
                endMedia.play();

                // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø¹Ù†Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
                endMedia.onended = () => {
                    isEndPhase = false;
                    endMedia.muted = true;
                    alert('âœ… Ø§Ù†ØªÙ‡Øª Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø®Ø§ØªÙ…Ø©');
                };
            } else {
                // Ø¥Ø°Ø§ ÙƒØ§Ù† ØµÙˆØ±Ø©ØŒ Ø§Ø¹Ø±Ø¶Ù‡Ø§ Ù„Ù…Ø¯Ø© 5 Ø«ÙˆØ§Ù†ÙŠ
                alert('âœ… Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ ØµÙˆØ±Ø© Ø§Ù„Ø®Ø§ØªÙ…Ø© Ù„Ù…Ø¯Ø© 5 Ø«ÙˆØ§Ù†ÙŠ');
                setTimeout(() => {
                    isEndPhase = false;
                    alert('âœ… Ø§Ù†ØªÙ‡Øª Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø®Ø§ØªÙ…Ø©');
                }, 5000);
            }
        }

        // ØªØ­Ù…ÙŠÙ„ Ø®Ù„ÙÙŠØ© Ø¬Ø§Ù‡Ø²Ø© (ØªØ¯Ø±Ø¬Ø§Øª ÙˆØ£Ù†Ù…Ø§Ø·)
        function loadPresetBackground(value) {
            if (!value) {
                bgMedia = null;
                return;
            }

            // Ø¥Ù†Ø´Ø§Ø¡ canvas Ù„Ù„Ø®Ù„ÙÙŠØ©
            const bgCanvas = document.createElement('canvas');
            bgCanvas.width = 1280;
            bgCanvas.height = 720;
            const bgCtx = bgCanvas.getContext('2d');

            switch (value) {
                case 'gradient-green':
                    const gradGreen = bgCtx.createLinearGradient(0, 0, 0, 720);
                    gradGreen.addColorStop(0, '#064e3b');
                    gradGreen.addColorStop(0.5, '#065f46');
                    gradGreen.addColorStop(1, '#047857');
                    bgCtx.fillStyle = gradGreen;
                    bgCtx.fillRect(0, 0, 1280, 720);
                    break;

                case 'gradient-blue':
                    const gradBlue = bgCtx.createLinearGradient(0, 0, 0, 720);
                    gradBlue.addColorStop(0, '#1e3a8a');
                    gradBlue.addColorStop(0.5, '#1e40af');
                    gradBlue.addColorStop(1, '#2563eb');
                    bgCtx.fillStyle = gradBlue;
                    bgCtx.fillRect(0, 0, 1280, 720);
                    break;

                case 'gradient-gold':
                    const gradGold = bgCtx.createLinearGradient(0, 0, 0, 720);
                    gradGold.addColorStop(0, '#78350f');
                    gradGold.addColorStop(0.5, '#92400e');
                    gradGold.addColorStop(1, '#b45309');
                    bgCtx.fillStyle = gradGold;
                    bgCtx.fillRect(0, 0, 1280, 720);
                    break;

                case 'gradient-purple':
                    const gradPurple = bgCtx.createLinearGradient(0, 0, 0, 720);
                    gradPurple.addColorStop(0, '#581c87');
                    gradPurple.addColorStop(0.5, '#6b21a8');
                    gradPurple.addColorStop(1, '#7e22ce');
                    bgCtx.fillStyle = gradPurple;
                    bgCtx.fillRect(0, 0, 1280, 720);
                    break;

                case 'pattern-1':
                    // Ø®Ù„ÙÙŠØ© Ø¨Ù†Ù‚ÙˆØ´ Ù‡Ù†Ø¯Ø³ÙŠØ©
                    bgCtx.fillStyle = '#1a1a2e';
                    bgCtx.fillRect(0, 0, 1280, 720);
                    bgCtx.strokeStyle = 'rgba(16, 185, 129, 0.2)';
                    bgCtx.lineWidth = 2;
                    for (let i = 0; i < 1280; i += 40) {
                        for (let j = 0; j < 720; j += 40) {
                            bgCtx.beginPath();
                            bgCtx.arc(i, j, 15, 0, Math.PI * 2);
                            bgCtx.stroke();
                        }
                    }
                    break;

                case 'pattern-2':
                    // Ø®Ù„ÙÙŠØ© Ø¨Ø®Ø·ÙˆØ· Ù…ØªÙ‚Ø§Ø·Ø¹Ø©
                    bgCtx.fillStyle = '#0f172a';
                    bgCtx.fillRect(0, 0, 1280, 720);
                    bgCtx.strokeStyle = 'rgba(59, 130, 246, 0.15)';
                    bgCtx.lineWidth = 1;
                    for (let i = 0; i < 1280; i += 30) {
                        bgCtx.beginPath();
                        bgCtx.moveTo(i, 0);
                        bgCtx.lineTo(i, 720);
                        bgCtx.stroke();
                    }
                    for (let j = 0; j < 720; j += 30) {
                        bgCtx.beginPath();
                        bgCtx.moveTo(0, j);
                        bgCtx.lineTo(1280, j);
                        bgCtx.stroke();
                    }
                    break;
            }

            // ØªØ­ÙˆÙŠÙ„ Canvas Ø¥Ù„Ù‰ ØµÙˆØ±Ø©
            const img = new Image();
            img.onload = () => {
                bgMedia = img;
                console.log(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ù„ÙÙŠØ©: ${value}`);
            };
            img.src = bgCanvas.toDataURL();
        }

        // Ù…ØªØºÙŠØ±Ø§Øª Ù„Ø¬Ù„Ø¨ Ø§Ù„Ø®Ù„ÙÙŠØ§Øª Ø§Ù„Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©
        let currentBgType = 'image';
        let currentRandomBgUrl = null;

        // Ø¬Ù„Ø¨ Ø®Ù„ÙÙŠØ© Ø¹Ø´ÙˆØ§Ø¦ÙŠØ© Ù…Ù† Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª
        async function fetchRandomBackground(type) {
            currentBgType = type;
            const preview = document.getElementById('randomBgPreview');
            const img = document.getElementById('randomBgImg');

            preview.classList.remove('hidden');
            img.src = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="100" height="100"%3E%3Ctext x="50%25" y="50%25" text-anchor="middle" dy=".3em" fill="%23666"%3Eâ³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...%3C/text%3E%3C/svg%3E';

            try {
                let url;
                if (type === 'image') {
                    // Ø§Ø³ØªØ®Ø¯Ø§Ù… Unsplash Source API (Ù…Ø¬Ø§Ù†ÙŠ Ø¨Ø¯ÙˆÙ† Ù…ÙØªØ§Ø­)
                    const topics = ['nature', 'landscape', 'sky', 'ocean', 'mountain', 'forest', 'sunset'];
                    const randomTopic = topics[Math.floor(Math.random() * topics.length)];
                    url = `https://source.unsplash.com/1920x1080/?${randomTopic}&${Date.now()}`;

                    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©
                    const testImg = new Image();
                    testImg.crossOrigin = 'anonymous';
                    testImg.onload = () => {
                        currentRandomBgUrl = url;
                        img.src = url;
                        console.log('âœ… ØªÙ… Ø¬Ù„Ø¨ ØµÙˆØ±Ø© Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©');
                    };
                    testImg.onerror = () => {
                        alert('âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
                        preview.classList.add('hidden');
                    };
                    testImg.src = url;
                } else {
                    // Ù„Ù„ÙÙŠØ¯ÙŠÙˆ: Ø§Ø³ØªØ®Ø¯Ø§Ù… Pexels API
                    if (PEXELS_API_KEY === 'YOUR_API_KEY_HERE') {
                        alert('âš ï¸ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§ØªØŒ ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© Ù…ÙØªØ§Ø­ Pexels API\n\n1. Ø³Ø¬Ù„ Ù…Ø¬Ø§Ù†Ø§Ù‹ Ø¹Ù„Ù‰: pexels.com/api\n2. Ø§Ù†Ø³Ø® Ø§Ù„Ù…ÙØªØ§Ø­\n3. Ø¶Ø¹Ù‡ ÙÙŠ Ø§Ù„Ù…ØªØºÙŠØ± PEXELS_API_KEY');
                        preview.classList.add('hidden');
                        return;
                    }

                    const response = await fetch('https://api.pexels.com/videos/search?query=nature&per_page=15', {
                        headers: { 'Authorization': PEXELS_API_KEY }
                    });
                    const data = await response.json();

                    if (data.videos && data.videos.length > 0) {
                        const randomVideo = data.videos[Math.floor(Math.random() * data.videos.length)];
                        const videoFile = randomVideo.video_files.find(f => f.quality === 'hd' || f.quality === 'sd');

                        if (videoFile) {
                            currentRandomBgUrl = videoFile.link;
                            img.src = randomVideo.image; // Ø¹Ø±Ø¶ ØµÙˆØ±Ø© Ù…ØµØºØ±Ø©
                            console.log('âœ… ØªÙ… Ø¬Ù„Ø¨ ÙÙŠØ¯ÙŠÙˆ Ø¹Ø´ÙˆØ§Ø¦ÙŠ');
                        }
                    }
                }
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø®Ù„ÙÙŠØ©:', error);
                alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø®Ù„ÙÙŠØ©. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.');
                preview.classList.add('hidden');
            }
        }

        // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø¹Ø´ÙˆØ§Ø¦ÙŠØ© Ø§Ù„Ù…Ø­Ù…Ù„Ø©
        function useRandomBackground() {
            if (!currentRandomBgUrl) {
                alert('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø®Ù„ÙÙŠØ© Ù…Ø­Ù…Ù„Ø©!');
                return;
            }

            if (currentBgType === 'image') {
                const img = new Image();
                img.crossOrigin = 'anonymous';
                img.onload = () => {
                    bgMedia = img;
                    alert('âœ… ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø®Ù„ÙÙŠØ©!');
                    console.log('âœ… ØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©');
                };
                img.onerror = () => {
                    alert('âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
                };
                img.src = currentRandomBgUrl;
            } else {
                const video = document.createElement('video');
                video.src = currentRandomBgUrl;
                video.crossOrigin = 'anonymous';
                video.muted = true;
                video.loop = true;
                video.play();
                bgMedia = video;
                alert('âœ… ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ!');
                console.log('âœ… ØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø¹Ø´ÙˆØ§Ø¦ÙŠ');
            }
        }

        // ØªØ­Ù…ÙŠÙ„ Ù…ÙˆØ³ÙŠÙ‚Ù‰ Ø¬Ø§Ù‡Ø²Ø©
        function loadPresetMusic(value) {
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø±Ø¨Ø¹Ø§Øª
            document.querySelectorAll('[id^="music-"]').forEach(el => {
                el.classList.remove('border-emerald-500');
                el.classList.add('border-transparent');
            });

            // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø±Ø¨Ø¹ Ø§Ù„Ù…Ø®ØªØ§Ø±
            if (value) {
                const selectedBox = document.getElementById(`music-${value}`);
                if (selectedBox) {
                    selectedBox.classList.remove('border-transparent');
                    selectedBox.classList.add('border-emerald-500');
                }
            } else {
                const noneBox = document.getElementById('music-none');
                if (noneBox) {
                    noneBox.classList.remove('border-transparent');
                    noneBox.classList.add('border-emerald-500');
                }
            }

            if (!value) {
                bgMusic.pause();
                bgMusic.src = '';
                return;
            }

            // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ù„ÙØ§Øª ØµÙˆØªÙŠØ© Ù…Ù† Ù…ØµØ§Ø¯Ø± Ù…ÙˆØ«ÙˆÙ‚Ø©
            const presetUrls = {
                'calm': 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3',
                'nature': 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3',
                'ambient': 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3'
            };

            if (presetUrls[value]) {
                bgMusic.pause();
                bgMusic.src = presetUrls[value];
                bgMusic.loop = true;
                bgMusic.volume = 0.2;

                bgMusic.load();

                bgMusic.play().then(() => {
                    console.log(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰: ${value}`);
                }).catch(err => {
                    console.error(`âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰: ${value}`, err);
                    alert('âš ï¸ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰. ØªØ£ÙƒØ¯ Ù…Ù† Ø§ØªØµØ§Ù„Ùƒ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª Ø£Ùˆ Ø§Ø±ÙØ¹ Ù…Ù„Ù ØµÙˆØªÙŠ Ù…Ù† Ø¬Ù‡Ø§Ø²Ùƒ.');
                });
            }
        }

        // Ø§Ø®ØªÙŠØ§Ø± Ø®Ù„ÙÙŠØ© Ø´Ø§Ø´Ø© Ø§Ù„Ø®Ø§ØªÙ…Ø©
        let selectedOutroBg = 'gradient-green';
        function selectOutroBackground(value) {
            selectedOutroBg = value;

            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø±Ø¨Ø¹Ø§Øª
            document.querySelectorAll('[id^="outro-bg-"]').forEach(el => {
                el.classList.remove('border-emerald-500', 'border-blue-500', 'border-purple-500', 'border-yellow-500', 'border-zinc-500');
                el.classList.add('border-transparent');
            });

            // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø±Ø¨Ø¹ Ø§Ù„Ù…Ø®ØªØ§Ø±
            const selectedBox = document.getElementById(`outro-bg-${value.replace('gradient-', '')}`);
            if (selectedBox) {
                selectedBox.classList.remove('border-transparent');
                if (value.includes('green')) selectedBox.classList.add('border-emerald-500');
                else if (value.includes('blue')) selectedBox.classList.add('border-blue-500');
                else if (value.includes('purple')) selectedBox.classList.add('border-purple-500');
                else if (value.includes('gold')) selectedBox.classList.add('border-yellow-500');
                else selectedBox.classList.add('border-zinc-500');
            }
        }

        // Ø¯Ø§Ù„Ø© Ù„Ø±Ø³Ù… Ø§Ù„Ø®Ù„ÙÙŠØ© (Ù…Ø´ØªØ±ÙƒØ© Ø¨ÙŠÙ† Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ÙˆØ§Ù„Ø®Ø§ØªÙ…Ø©)
        function drawBackground(ctx, W, H) {
            if (bgMedia) {
                ctx.globalAlpha = document.getElementById('bgOpacity').value;
                ctx.drawImage(bgMedia, 0, 0, W, H);
                ctx.globalAlpha = 1;
            }
        }

        // Ù…Ø¹Ø§ÙŠÙ†Ø© Ø´Ø§Ø´Ø© Ø§Ù„Ø®Ø§ØªÙ…Ø©
        function previewOutroScreen() {
            const enableOutro = document.getElementById('enableOutro').checked;
            if (!enableOutro) {
                alert('âš ï¸ ÙŠØ¬Ø¨ ØªÙØ¹ÙŠÙ„ Ø´Ø§Ø´Ø© Ø§Ù„Ø®Ø§ØªÙ…Ø© Ø£ÙˆÙ„Ø§Ù‹');
                return;
            }

            const duration = parseInt(document.getElementById('outroDuration').value) || 10;

            // ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø´Ø§Ø´Ø© Ø§Ù„Ø®Ø§ØªÙ…Ø©
            isOutroPhase = true;
            outroAnimProgress = 0;

            // Ø¥ÙŠÙ‚Ø§Ù Ø£ÙŠ ØµÙˆØª ÙŠØ¹Ù…Ù„
            player.pause();

            // Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
            alert(`âœ… Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ø´Ø§Ø´Ø© Ø§Ù„Ø®Ø§ØªÙ…Ø© Ù„Ù…Ø¯Ø© ${duration} Ø«Ø§Ù†ÙŠØ©`);

            // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
            setTimeout(() => {
                isOutroPhase = false;
                outroAnimProgress = 0;
                alert('âœ… Ø§Ù†ØªÙ‡Øª Ù…Ø¹Ø§ÙŠÙ†Ø© Ø´Ø§Ø´Ø© Ø§Ù„Ø®Ø§ØªÙ…Ø©');
            }, duration * 1000);
        }

        // Ø±Ø³Ù… Ø®Ù„ÙÙŠØ© Ø´Ø§Ø´Ø© Ø§Ù„Ø®Ø§ØªÙ…Ø©
        function drawOutroBackground(bgType) {
            const W = canvas.width, H = canvas.height;

            switch (bgType) {
                case 'gradient-green':
                    const gradGreen = ctx.createLinearGradient(0, 0, 0, H);
                    gradGreen.addColorStop(0, '#064e3b');
                    gradGreen.addColorStop(0.5, '#065f46');
                    gradGreen.addColorStop(1, '#047857');
                    ctx.fillStyle = gradGreen;
                    ctx.fillRect(0, 0, W, H);
                    break;
                case 'gradient-blue':
                    const gradBlue = ctx.createLinearGradient(0, 0, 0, H);
                    gradBlue.addColorStop(0, '#1e3a8a');
                    gradBlue.addColorStop(0.5, '#1e40af');
                    gradBlue.addColorStop(1, '#2563eb');
                    ctx.fillStyle = gradBlue;
                    ctx.fillRect(0, 0, W, H);
                    break;
                case 'gradient-purple':
                    const gradPurple = ctx.createLinearGradient(0, 0, 0, H);
                    gradPurple.addColorStop(0, '#581c87');
                    gradPurple.addColorStop(0.5, '#6b21a8');
                    gradPurple.addColorStop(1, '#7e22ce');
                    ctx.fillStyle = gradPurple;
                    ctx.fillRect(0, 0, W, H);
                    break;
                case 'gradient-gold':
                    const gradGold = ctx.createLinearGradient(0, 0, 0, H);
                    gradGold.addColorStop(0, '#78350f');
                    gradGold.addColorStop(0.5, '#92400e');
                    gradGold.addColorStop(1, '#b45309');
                    ctx.fillStyle = gradGold;
                    ctx.fillRect(0, 0, W, H);
                    break;
                case 'dark':
                    ctx.fillStyle = '#000';
                    ctx.fillRect(0, 0, W, H);
                    break;
            }
        }

        // Ø±Ø³Ù… Ø®Ù„ÙÙŠØ© Ù…Ø®ØµØµØ© Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø®Ø§ØªÙ…Ø©
        function drawOutroCustomBackground(ctx, W, H, bgType) {
            switch (bgType) {
                case 'gradient-green':
                    const gradGreen = ctx.createLinearGradient(0, 0, 0, H);
                    gradGreen.addColorStop(0, '#064e3b');
                    gradGreen.addColorStop(0.5, '#065f46');
                    gradGreen.addColorStop(1, '#047857');
                    ctx.fillStyle = gradGreen;
                    ctx.fillRect(0, 0, W, H);
                    break;
                case 'gradient-blue':
                    const gradBlue = ctx.createLinearGradient(0, 0, 0, H);
                    gradBlue.addColorStop(0, '#1e3a8a');
                    gradBlue.addColorStop(0.5, '#1e40af');
                    gradBlue.addColorStop(1, '#2563eb');
                    ctx.fillStyle = gradBlue;
                    ctx.fillRect(0, 0, W, H);
                    break;
                case 'gradient-purple':
                    const gradPurple = ctx.createLinearGradient(0, 0, 0, H);
                    gradPurple.addColorStop(0, '#581c87');
                    gradPurple.addColorStop(0.5, '#6b21a8');
                    gradPurple.addColorStop(1, '#7e22ce');
                    ctx.fillStyle = gradPurple;
                    ctx.fillRect(0, 0, W, H);
                    break;
                case 'gradient-gold':
                    const gradGold = ctx.createLinearGradient(0, 0, 0, H);
                    gradGold.addColorStop(0, '#78350f');
                    gradGold.addColorStop(0.5, '#92400e');
                    gradGold.addColorStop(1, '#b45309');
                    ctx.fillStyle = gradGold;
                    ctx.fillRect(0, 0, W, H);
                    break;
                case 'dark':
                    ctx.fillStyle = '#000';
                    ctx.fillRect(0, 0, W, H);
                    break;
            }
        }

        function draw() {
            const W = canvas.width, H = canvas.height;
            bgMusic.volume = document.getElementById('bgVol').value;

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ£Ø«ÙŠØ±Ø§Øª Ù…Ù† Ø§Ù„Ù€ UI
            transitionType = document.getElementById('transitionType').value;
            transitionSpeed = parseFloat(document.getElementById('transitionSpeed').value);
            customTitle = document.getElementById('customTitle').value;
            channelName = document.getElementById('channelName').value;
            showArabicText = document.getElementById('showArabicText').checked;
            showMeaning = document.getElementById('showMeaning').checked;
            showTranslation = document.getElementById('showTranslation').checked;
            showAyahNumber = document.getElementById('showAyahNumber').checked;
            showReciterName = document.getElementById('showReciterName').checked;
            showDate = document.getElementById('showDate').checked;

            // ØªØ­Ø¯ÙŠØ« ØªÙ‚Ø¯Ù… Ø§Ù„ØªØ£Ø«ÙŠØ±
            if (fade < 1) {
                fade += 0.08;
                transitionProgress = fade;
            }

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¢ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ ÙˆÙ‚Øª Ø§Ù„ØªØ´ØºÙŠÙ„
            if (player && !player.paused && clips.length > 0) {
                const currentTime = player.currentTime;
                let newIdx = -1;

                for (let i = clips.length - 1; i >= 0; i--) {
                    if (clips[i].syncTime !== undefined && currentTime >= clips[i].syncTime) {
                        newIdx = i;
                        break;
                    }
                }

                if (newIdx !== -1 && newIdx !== currentIdx) {
                    currentIdx = newIdx;
                    fade = 0;
                    transitionProgress = 0;
                }
            }

            ctx.filter = `brightness(${document.getElementById('fBright').value}%) contrast(${document.getElementById('fContrast').value}%) hue-rotate(${document.getElementById('fHue').value}deg)`;
            ctx.fillStyle = "#000";
            ctx.fillRect(0, 0, W, H);

            if (isOutroPhase) {
                // Ø¹Ø±Ø¶ Ø´Ø§Ø´Ø© Ø§Ù„Ø®Ø§ØªÙ…Ø© Ø§Ù„Ù†ØµÙŠØ©
                drawOutroScreen(ctx, W, H);
            } else if (isEndPhase && endMedia) {
                ctx.drawImage(endMedia, 0, 0, W, H);
            } else {
                // Ø±Ø³Ù… Ø§Ù„Ø®Ù„ÙÙŠØ©
                if (bgMedia) {
                    ctx.globalAlpha = document.getElementById('bgOpacity').value;
                    ctx.drawImage(bgMedia, 0, 0, W, H);
                    ctx.globalAlpha = 1;
                }

                ctx.filter = "none";

                // Ø±Ø³Ù… Ø§Ù„Ø´Ø¹Ø§Ø±
                if (logoImg) {
                    ctx.globalAlpha = document.getElementById('logoOpacity').value;
                    ctx.drawImage(logoImg, W - 140, 40, 100, 100);
                    ctx.globalAlpha = 1;
                }

                // Ø±Ø³Ù… Ø§Ù„Ø¢ÙŠØ© Ù…Ø¹ Ø§Ù„ØªØ£Ø«ÙŠØ±Ø§Øª
                if (currentIdx !== -1 && clips[currentIdx]) {
                    ctx.save();

                    // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ£Ø«ÙŠØ± Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ÙŠ
                    if (transitionType !== 'none') {
                        applyTransition(ctx, W, H, transitionProgress);
                    }

                    ctx.globalAlpha = fade;

                    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø±Ø¦ÙŠØ©
                    // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø£ØµØºØ± Ù‚ÙŠÙ…Ø© Ø¨ÙŠÙ† Ø§Ù„Ø¹Ø±Ø¶ ÙˆØ§Ù„Ø§Ø±ØªÙØ§Ø¹ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø³Ø§ÙØ§Øª Ù…ØªÙ†Ø§Ø³Ù‚Ø©
                    const minDimension = Math.min(W, H);
                    let baseY = H / 4.5; // Ø¨Ø¯Ø§ÙŠØ© Ø£Ø¹Ù„Ù‰

                    // Ø§Ù„Ù†Øµ Ø§Ù„Ø¹Ø±Ø¨ÙŠ
                    if (showArabicText) {
                        ctx.fillStyle = "white";
                        ctx.textAlign = "center";
                        ctx.font = `bold ${minDimension / 14}px 'Amiri'`;
                        const arabicLineHeight = minDimension / 11;
                        const arabicLines = wrapText(ctx, clips[currentIdx].ar, W / 2, baseY, W * 0.85, arabicLineHeight);
                        baseY += arabicLines * arabicLineHeight + (H * 0.05); // Ù…Ø³Ø§ÙØ© Ø¨Ø¹Ø¯ Ø§Ù„Ù†Øµ Ø§Ù„Ø¹Ø±Ø¨ÙŠ
                    }

                    // Ø§Ù„Ù…Ø¹Ù†Ù‰ (Ø§Ù„ØªÙØ³ÙŠØ±)
                    if (showMeaning) {
                        ctx.fillStyle = "#FFD700";
                        ctx.font = `bold ${minDimension / 28}px 'Tajawal'`;
                        const meaningLineHeight = minDimension / 22;
                        const meaningLines = wrapText(ctx, "Ø§Ù„Ù…Ø¹Ù†Ù‰: " + clips[currentIdx].meaning, W / 2, baseY, W * 0.85, meaningLineHeight);
                        baseY += meaningLines * meaningLineHeight + (H * 0.04); // Ù…Ø³Ø§ÙØ© Ø¨Ø¹Ø¯ Ø§Ù„ØªÙØ³ÙŠØ±
                    }

                    // Ø§Ù„ØªØ±Ø¬Ù…Ø©
                    if (showTranslation) {
                        ctx.fillStyle = "rgba(255,255,255,0.85)";
                        ctx.font = `${minDimension / 32}px 'Tajawal'`;
                        const transLineHeight = minDimension / 28;
                        wrapText(ctx, clips[currentIdx].trans, W / 2, baseY, W * 0.85, transLineHeight);
                    }

                    ctx.restore();
                }

                // Ø±Ø³Ù… Ø§Ù„Ù†ØµÙˆØµ Ø§Ù„Ù…Ø®ØµØµØ©
                drawCustomTexts(ctx, W, H);
            }

            requestAnimationFrame(draw);
        }

        // Ø¯Ø§Ù„Ø© ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ£Ø«ÙŠØ±Ø§Øª Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ÙŠØ©
        function applyTransition(ctx, W, H, progress) {
            const easedProgress = easeInOutCubic(progress);

            switch (transitionType) {
                case 'fade':
                    // Ø§Ù„ØªÙ„Ø§Ø´ÙŠ - ÙŠØªÙ… Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ù‡ Ø¹Ø¨Ø± globalAlpha ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
                    break;

                case 'slide-right':
                    // Ø§Ù†Ø²Ù„Ø§Ù‚ Ù…Ù† Ø§Ù„ÙŠÙ…ÙŠÙ†
                    const slideX = W * (1 - easedProgress);
                    ctx.translate(slideX, 0);
                    break;

                case 'slide-left':
                    // Ø§Ù†Ø²Ù„Ø§Ù‚ Ù…Ù† Ø§Ù„ÙŠØ³Ø§Ø±
                    const slideXLeft = -W * (1 - easedProgress);
                    ctx.translate(slideXLeft, 0);
                    break;

                case 'zoom-in':
                    // ØªÙƒØ¨ÙŠØ±
                    const scale = 0.5 + (easedProgress * 0.5);
                    ctx.translate(W / 2, H / 2);
                    ctx.scale(scale, scale);
                    ctx.translate(-W / 2, -H / 2);
                    break;

                case 'zoom-out':
                    // ØªØµØºÙŠØ±
                    const scaleOut = 1.5 - (easedProgress * 0.5);
                    ctx.translate(W / 2, H / 2);
                    ctx.scale(scaleOut, scaleOut);
                    ctx.translate(-W / 2, -H / 2);
                    break;
            }
        }

        // Ø¯Ø§Ù„Ø© Ø§Ù„Ø­Ø±ÙƒØ© Ø§Ù„Ø³Ù„Ø³Ø©
        function easeInOutCubic(t) {
            return t < 0.5 ? 4 * t * t * t : 1 - Math.pow(-2 * t + 2, 3) / 2;
        }

        // Ø¯Ø§Ù„Ø© Ø±Ø³Ù… Ø§Ù„Ù†ØµÙˆØµ Ø§Ù„Ù…Ø®ØµØµØ©
        function drawCustomTexts(ctx, W, H) {
            ctx.save();
            ctx.globalAlpha = 0.9;

            // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø£ØµØºØ± Ù‚ÙŠÙ…Ø© Ø¨ÙŠÙ† Ø§Ù„Ø¹Ø±Ø¶ ÙˆØ§Ù„Ø§Ø±ØªÙØ§Ø¹ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø£Ø­Ø¬Ø§Ù… Ø®Ø·ÙˆØ· Ù…ØªÙ†Ø§Ø³Ù‚Ø©
            const minDimension = Math.min(W, H);

            // Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰
            if (customTitle) {
                ctx.fillStyle = "rgba(16, 185, 129, 0.9)";
                ctx.font = `bold ${minDimension / 25}px 'Tajawal'`;
                ctx.textAlign = "center";
                ctx.fillText(customTitle, W / 2, 50);
            }

            // Ø§Ø³Ù… Ø§Ù„Ù‚Ù†Ø§Ø© ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„
            if (channelName) {
                ctx.fillStyle = "rgba(255, 255, 255, 0.8)";
                ctx.font = `${minDimension / 30}px 'Tajawal'`;
                ctx.textAlign = "center";
                ctx.fillText(channelName, W / 2, H - 40);
            }

            // Ø±Ù‚Ù… Ø§Ù„Ø¢ÙŠØ© ÙˆØ§Ø³Ù… Ø§Ù„Ù‚Ø§Ø±Ø¦ ÙÙŠ Ù†ÙØ³ Ø§Ù„Ø³Ø·Ø±
            const bottomY = H - 40;

            // Ø±Ù‚Ù… Ø§Ù„Ø¢ÙŠØ© (ÙŠÙ…ÙŠÙ†)
            if (showAyahNumber && currentIdx !== -1) {
                ctx.fillStyle = "rgba(255, 215, 0, 0.9)";
                ctx.font = `bold ${minDimension / 35}px 'Tajawal'`;
                ctx.textAlign = "right";
                ctx.shadowColor = 'rgba(0, 0, 0, 0.5)';
                ctx.shadowBlur = 5;
                ctx.fillText(`Ø§Ù„Ø¢ÙŠØ© ${currentIdx + 1}`, W - 30, bottomY);
                ctx.shadowBlur = 0;
            }

            // Ø§Ø³Ù… Ø§Ù„Ù‚Ø§Ø±Ø¦ (ÙŠØ³Ø§Ø±)
            if (showReciterName && currentReciterName) {
                ctx.fillStyle = "rgba(16, 185, 129, 0.9)";
                ctx.font = `bold ${minDimension / 40}px 'Tajawal'`;
                ctx.textAlign = "left";
                ctx.shadowColor = 'rgba(0, 0, 0, 0.5)';
                ctx.shadowBlur = 5;
                ctx.fillText(`ğŸ™ï¸ ${currentReciterName}`, 30, bottomY);
                ctx.shadowBlur = 0;
            }

            // Ø§Ù„ØªØ§Ø±ÙŠØ® (ÙˆØ³Ø· Ø£Ø³ÙÙ„)
            if (showDate) {
                const today = new Date();
                const dateStr = today.toLocaleDateString('ar-EG', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                ctx.fillStyle = "rgba(255, 255, 255, 0.6)";
                ctx.font = `${minDimension / 45}px 'Tajawal'`;
                ctx.textAlign = "center";
                ctx.shadowColor = 'rgba(0, 0, 0, 0.5)';
                ctx.shadowBlur = 5;
                ctx.fillText(dateStr, W / 2, bottomY);
                ctx.shadowBlur = 0;
            }

            ctx.restore();
        }

        // Ø¯Ø§Ù„Ø© Ø±Ø³Ù… Ø´Ø§Ø´Ø© Ø§Ù„Ø®Ø§ØªÙ…Ø© Ø§Ù„Ù†ØµÙŠØ©
        function drawOutroScreen(ctx, W, H) {
            // Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù†ØµÙˆØµ Ù…Ù† textarea
            let outroMainText = document.getElementById('outroMainText').value.trim();
            let outroSubText = document.getElementById('outroSubText').value.trim();
            let outroExtraText = document.getElementById('outroExtraText').value.trim();

            // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù†ØµÙˆØµ Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª ÙØ§Ø±ØºØ©
            if (!outroMainText) outroMainText = 'Ø´ÙƒØ±Ø§Ù‹ Ù„Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©\nÙ†Ø³Ø£Ù„ Ø§Ù„Ù„Ù‡ Ø§Ù„Ù‚Ø¨ÙˆÙ„';
            if (!outroSubText) outroSubText = 'Ù„Ø§ ØªÙ†Ø³Ù‰ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ Ø§Ù„Ù‚Ù†Ø§Ø©\nÙˆØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¬Ø±Ø³ ğŸ””';
            if (!outroExtraText) outroExtraText = 'Ø¬Ø²Ø§ÙƒÙ… Ø§Ù„Ù„Ù‡ Ø®ÙŠØ±Ø§Ù‹\nÙˆÙ†ÙØ¹ Ø¨ÙƒÙ… Ø§Ù„Ø¥Ø³Ù„Ø§Ù… ÙˆØ§Ù„Ù…Ø³Ù„Ù…ÙŠÙ†';

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù†ÙØ³ Ø®Ù„ÙÙŠØ© Ø§Ù„Ø¹Ø±Ø¶
            const useSameBackground = document.getElementById('useSameBackground').checked;

            if (useSameBackground) {
                drawBackground(ctx, W, H);
            } else {
                const bgType = selectedOutroBg;
                drawOutroCustomBackground(ctx, W, H, bgType);
            }

            // Ø·Ø¨Ù‚Ø© ØªØ¹ØªÙŠÙ… Ø£Ù†ÙŠÙ‚Ø©
            ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
            ctx.fillRect(0, 0, W, H);

            // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¬ÙˆÙ… Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©
            if (outroStars.length === 0) {
                initOutroStars(W, H);
            }

            // Ø±Ø³Ù… Ø§Ù„Ù†Ø¬ÙˆÙ… Ø§Ù„Ù…ØªÙ„Ø£Ù„Ø¦Ø©
            outroStars.forEach(star => {
                star.x += star.speedX;
                star.y += star.speedY;
                star.twinkle += 0.08;

                if (star.x < 0) star.x = W;
                if (star.x > W) star.x = 0;
                if (star.y < 0) star.y = H;
                if (star.y > H) star.y = 0;

                const twinkleOpacity = star.opacity * (0.3 + Math.sin(star.twinkle) * 0.7);

                // Ù†Ø¬Ù…Ø© Ù…Ø¹ Ù‡Ø§Ù„Ø©
                ctx.shadowBlur = 8;
                ctx.shadowColor = `rgba(255, 255, 255, ${twinkleOpacity})`;
                ctx.fillStyle = `rgba(255, 255, 255, ${twinkleOpacity})`;
                ctx.beginPath();
                ctx.arc(star.x, star.y, star.size, 0, Math.PI * 2);
                ctx.fill();
                ctx.shadowBlur = 0;
            });

            // ØªØ­Ø¯ÙŠØ« ØªÙ‚Ø¯Ù… Ø§Ù„Ø£Ù†ÙŠÙ…ÙŠØ´Ù† (Ø£Ø¨Ø·Ø£ Ù„Ù„Ø¢Ù„Ø© Ø§Ù„ÙƒØ§ØªØ¨Ø©)
            if (outroAnimProgress < 1) {
                outroAnimProgress += 0.015; // Ø£Ø¨Ø·Ø£ Ù…Ù† Ù‚Ø¨Ù„
            }

            ctx.save();

            // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø£ØµØºØ± Ù‚ÙŠÙ…Ø© Ù„Ù„Ø®Ø·ÙˆØ·
            const minDimension = Math.min(W, H);

            // Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø­Ø±Ù Ø§Ù„Ù…Ø±Ø¦ÙŠØ© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ØªÙ‚Ø¯Ù…
            const mainLines = outroMainText.split('\n');
            const subLines = outroSubText.split('\n');
            const extraLines = outroExtraText.split('\n');

            const totalMainChars = mainLines.join('').length;
            const totalSubChars = subLines.join('').length;
            const totalExtraChars = extraLines.join('').length;
            const totalChars = totalMainChars + totalSubChars + totalExtraChars;

            const visibleChars = Math.floor(outroAnimProgress * totalChars);

            let charCount = 0;
            let currentY = H / 2 - 150;

            // Ø±Ø³Ù… Ø§Ù„Ù†Øµ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ø¨ØªØ£Ø«ÙŠØ± Ø§Ù„Ø¢Ù„Ø© Ø§Ù„ÙƒØ§ØªØ¨Ø©
            ctx.shadowBlur = 30;
            ctx.shadowColor = 'rgba(16, 185, 129, 0.8)';
            ctx.fillStyle = '#ffffff';
            ctx.font = `bold ${minDimension / 11}px 'Amiri'`;
            ctx.textAlign = 'center';

            mainLines.forEach((line, lineIndex) => {
                let visibleText = '';
                for (let i = 0; i < line.length; i++) {
                    if (charCount < visibleChars) {
                        visibleText += line[i];
                        charCount++;
                    }
                }
                if (visibleText) {
                    ctx.fillText(visibleText, W / 2, currentY);

                    // Ø±Ø³Ù… Ø§Ù„Ù…Ø¤Ø´Ø± Ø§Ù„ÙˆØ§Ù…Ø¶ (cursor) ÙÙŠ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ
                    if (charCount === visibleChars && lineIndex === mainLines.length - 1) {
                        const cursorBlink = Math.sin(Date.now() / 200) > 0;
                        if (cursorBlink) {
                            const textWidth = ctx.measureText(visibleText).width;
                            ctx.fillRect(W / 2 + textWidth / 2 + 5, currentY - minDimension / 14, 3, minDimension / 11);
                        }
                    }
                }
                currentY += (minDimension / 11) * 1.4;
            });

            // Ø®Ø· ÙØ§ØµÙ„ (ÙŠØ¸Ù‡Ø± Ø¨Ø¹Ø¯ Ø§Ù„Ù†Øµ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ)
            if (charCount >= totalMainChars) {
                currentY += 20;
                const lineProgress = Math.min((charCount - totalMainChars) / 5, 1);
                const lineWidth = W * 0.25 * lineProgress;

                const lineGrad = ctx.createLinearGradient(W / 2 - lineWidth / 2, currentY, W / 2 + lineWidth / 2, currentY);
                lineGrad.addColorStop(0, 'rgba(16, 185, 129, 0)');
                lineGrad.addColorStop(0.5, 'rgba(16, 185, 129, 0.7)');
                lineGrad.addColorStop(1, 'rgba(16, 185, 129, 0)');

                ctx.strokeStyle = lineGrad;
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(W / 2 - lineWidth / 2, currentY);
                ctx.lineTo(W / 2 + lineWidth / 2, currentY);
                ctx.stroke();

                currentY += 40;
            }

            // Ø±Ø³Ù… Ø§Ù„Ù†Øµ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ Ø¨ØªØ£Ø«ÙŠØ± Ø§Ù„Ø¢Ù„Ø© Ø§Ù„ÙƒØ§ØªØ¨Ø©
            if (charCount >= totalMainChars) {
                ctx.shadowBlur = 20;
                ctx.shadowColor = 'rgba(16, 185, 129, 0.6)';
                ctx.fillStyle = '#10b981';
                ctx.font = `bold ${minDimension / 18}px 'Tajawal'`;

                subLines.forEach((line, lineIndex) => {
                    let visibleText = '';
                    for (let i = 0; i < line.length; i++) {
                        if (charCount < visibleChars) {
                            visibleText += line[i];
                            charCount++;
                        }
                    }
                    if (visibleText) {
                        ctx.fillText(visibleText, W / 2, currentY);

                        // Ø±Ø³Ù… Ø§Ù„Ù…Ø¤Ø´Ø± Ø§Ù„ÙˆØ§Ù…Ø¶
                        if (charCount === visibleChars && lineIndex === subLines.length - 1) {
                            const cursorBlink = Math.sin(Date.now() / 200) > 0;
                            if (cursorBlink) {
                                const textWidth = ctx.measureText(visibleText).width;
                                ctx.fillRect(W / 2 + textWidth / 2 + 5, currentY - minDimension / 20, 3, minDimension / 18);
                            }
                        }
                    }
                    currentY += (minDimension / 18) * 1.5;
                });

                currentY += 30;
            }

            // Ø±Ø³Ù… Ø§Ù„Ù†Øµ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ Ø¨ØªØ£Ø«ÙŠØ± Ø§Ù„Ø¢Ù„Ø© Ø§Ù„ÙƒØ§ØªØ¨Ø©
            if (charCount >= totalMainChars + totalSubChars) {
                ctx.shadowBlur = 15;
                ctx.shadowColor = 'rgba(255, 215, 0, 0.7)';
                ctx.fillStyle = '#ffd700';
                ctx.font = `${minDimension / 22}px 'Tajawal'`;

                extraLines.forEach((line, lineIndex) => {
                    let visibleText = '';
                    for (let i = 0; i < line.length; i++) {
                        if (charCount < visibleChars) {
                            visibleText += line[i];
                            charCount++;
                        }
                    }
                    if (visibleText) {
                        ctx.fillText(visibleText, W / 2, currentY);

                        // Ø±Ø³Ù… Ø§Ù„Ù…Ø¤Ø´Ø± Ø§Ù„ÙˆØ§Ù…Ø¶
                        if (charCount === visibleChars && lineIndex === extraLines.length - 1) {
                            const cursorBlink = Math.sin(Date.now() / 200) > 0;
                            if (cursorBlink) {
                                const textWidth = ctx.measureText(visibleText).width;
                                ctx.fillRect(W / 2 + textWidth / 2 + 5, currentY - minDimension / 24, 3, minDimension / 22);
                            }
                        }
                    }
                    currentY += (minDimension / 22) * 1.6;
                });
            }

            ctx.restore();
        }

        // Ø¯Ø§Ù„Ø© Ø±Ø³Ù… Ø§Ù„Ù†Øµ Ø¨ØªØ£Ø«ÙŠØ± Ø§Ù„ÙƒØªØ§Ø¨Ø© Ø§Ù„ÙŠØ¯ÙˆÙŠØ©
        function drawHandwrittenText(ctx, text, x, y, font, color, progress, maxWidth) {
            ctx.save();
            ctx.font = font;
            ctx.textAlign = 'center';
            ctx.fillStyle = color;

            // ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ù†Øµ Ø¥Ù„Ù‰ Ø£Ø³Ø·Ø±
            const lines = text.split('\n');
            const lineHeight = parseInt(font) * 1.5;

            // Ø­Ø³Ø§Ø¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø­Ø±Ù
            const totalChars = text.replace(/\n/g, '').length;
            const visibleChars = Math.floor(totalChars * progress);

            let charCount = 0;
            let lastVisibleLine = -1;
            let lastLineVisibleChars = 0;

            // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ø£Ø®ÙŠØ± Ø§Ù„Ù…Ø±Ø¦ÙŠ ÙˆØ¹Ø¯Ø¯ Ø£Ø­Ø±ÙÙ‡
            for (let i = 0; i < lines.length; i++) {
                if (charCount + lines[i].length <= visibleChars) {
                    lastVisibleLine = i;
                    lastLineVisibleChars = lines[i].length;
                    charCount += lines[i].length;
                } else {
                    lastVisibleLine = i;
                    lastLineVisibleChars = visibleChars - charCount;
                    break;
                }
            }

            // Ø±Ø³Ù… ÙƒÙ„ Ø³Ø·Ø±
            let currentY = y - ((lines.length - 1) * lineHeight / 2);
            for (let i = 0; i <= lastVisibleLine && i < lines.length; i++) {
                const lineText = i === lastVisibleLine
                    ? lines[i].substring(0, lastLineVisibleChars)
                    : lines[i];

                if (lineText.length > 0) {
                    // ØªØ£Ø«ÙŠØ± Ø§Ù„Ø¸Ù„ Ù„Ù„Ù†Øµ - Ø£Ù‚ÙˆÙ‰ ÙˆØ£ÙˆØ¶Ø­
                    ctx.shadowColor = 'rgba(0, 0, 0, 0.8)';
                    ctx.shadowBlur = 15;
                    ctx.shadowOffsetX = 3;
                    ctx.shadowOffsetY = 3;

                    // Ø±Ø³Ù… Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø±Ø¦ÙŠ Ø¨ÙˆØ¶ÙˆØ­ ÙƒØ§Ù…Ù„
                    ctx.globalAlpha = 1;

                    // Ø±Ø³Ù… Ø§Ù„Ù†Øµ Ù…Ø±ØªÙŠÙ† Ù„Ø²ÙŠØ§Ø¯Ø© Ø§Ù„ÙˆØ¶ÙˆØ­
                    ctx.fillText(lineText, x, currentY);
                    ctx.shadowBlur = 0;
                    ctx.fillText(lineText, x, currentY);
                }

                currentY += lineHeight;
            }

            // Ø¥Ø¶Ø§ÙØ© "Ù‚Ù„Ù…" Ù…ØªØ­Ø±Ùƒ ÙÙŠ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù†Øµ (cursor effect)
            if (progress < 1 && lastVisibleLine >= 0 && lastLineVisibleChars > 0) {
                const lastLine = lines[lastVisibleLine].substring(0, lastLineVisibleChars);
                const lastLineY = y - ((lines.length - 1) * lineHeight / 2) + (lastVisibleLine * lineHeight);

                // Ø­Ø³Ø§Ø¨ Ù…ÙˆÙ‚Ø¹ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù†Øµ
                const textMetrics = ctx.measureText(lastLine);
                const textWidth = textMetrics.width;

                // Ø±Ø³Ù… Ø®Ø· ÙˆØ§Ù…Ø¶ ÙŠØ­Ø§ÙƒÙŠ Ø§Ù„Ù‚Ù„Ù… - Ø£ÙƒØ«Ø± ÙˆØ¶ÙˆØ­Ø§Ù‹
                const cursorAlpha = (Math.sin(Date.now() / 100) + 1) / 2; // ÙˆÙ…ÙŠØ¶
                ctx.globalAlpha = cursorAlpha;
                ctx.strokeStyle = color;
                ctx.lineWidth = 4;
                ctx.lineCap = 'round';

                // Ø®Ø· Ø¹Ù…ÙˆØ¯ÙŠ ØµØºÙŠØ±
                const cursorX = x + textWidth / 2 + 8;
                ctx.beginPath();
                ctx.moveTo(cursorX, lastLineY - 15);
                ctx.lineTo(cursorX, lastLineY + 8);
                ctx.stroke();

                // Ù†Ù‚Ø·Ø© ÙÙŠ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù‚Ù„Ù… - Ø£ÙƒØ¨Ø± ÙˆØ£ÙˆØ¶Ø­
                ctx.fillStyle = color;
                ctx.globalAlpha = cursorAlpha;
                ctx.beginPath();
                ctx.arc(cursorX, lastLineY + 8, 5, 0, Math.PI * 2);
                ctx.fill();
            }

            ctx.restore();
        }

        function wrapText(c, t, x, y, mw, lh) {
            let words = t.split(' '), line = '';
            let lineCount = 0;
            for (let n = 0; n < words.length; n++) {
                let test = line + words[n] + ' ';
                if (c.measureText(test).width > mw && n > 0) {
                    c.fillText(line, x, y);
                    line = words[n] + ' ';
                    y += lh;
                    lineCount++;
                }
                else line = test;
            }
            c.fillText(line, x, y);
            lineCount++;
            return lineCount; // Ø¥Ø±Ø¬Ø§Ø¹ Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±
        }

        // Ø¯Ø§Ù„Ø© Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ (Ø¨Ø¯ÙˆÙ† ØªØ³Ø¬ÙŠÙ„)
        async function previewVideo() {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¢ÙŠØ§Øª
            if (clips.length === 0) {
                alert("âš ï¸ ÙŠØ¬Ø¨ Ø¬Ù„Ø¨ Ø§Ù„Ø¢ÙŠØ§Øª Ø£ÙˆÙ„Ø§Ù‹!");
                return;
            }

            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
            resetPlayback();

            const btn = document.getElementById('previewBtn');
            const originalText = btn.innerText;
            btn.disabled = true;
            btn.innerText = "â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©...";

            try {
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØµÙˆØª ÙƒØ§Ù…Ù„ Ù…Ø±ÙÙˆØ¹
                if (hasFullAudio) {
                    // Ù…Ø¹Ø§ÙŠÙ†Ø© Ù…Ø¹ Ø§Ù„ØµÙˆØª Ø§Ù„ÙƒØ§Ù…Ù„
                    const lastClipIndex = clips.length - 1;
                    const hasSync = clips.some(c => c.syncTime !== undefined);

                    if (hasSync && clips[lastClipIndex].syncTime !== undefined) {
                        const lastAyahStartTime = clips[lastClipIndex].syncTime;
                        let estimatedDuration = 5;

                        if (lastClipIndex > 0 && clips[lastClipIndex - 1].syncTime !== undefined) {
                            let totalDuration = 0;
                            let count = 0;
                            for (let i = 1; i < clips.length; i++) {
                                if (clips[i].syncTime !== undefined && clips[i - 1].syncTime !== undefined) {
                                    totalDuration += clips[i].syncTime - clips[i - 1].syncTime;
                                    count++;
                                }
                            }
                            if (count > 0) {
                                estimatedDuration = totalDuration / count;
                            }
                        }

                        const endTime = lastAyahStartTime + estimatedDuration;

                        // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¢ÙŠØ© Ø§Ù„Ø£ÙˆÙ„Ù‰ ÙˆØ¥Ø¸Ù‡Ø§Ø±Ù‡Ø§
                        currentIdx = 0;
                        fade = 1;

                        player.currentTime = 0;
                        await player.play();

                        // Ø¥ÙŠÙ‚Ø§Ù Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‡Ø§ÙŠØ©
                        const checkTime = setInterval(() => {
                            if (player.currentTime >= endTime || player.ended) {
                                clearInterval(checkTime);
                                player.pause();

                                // Ù…Ø¹Ø§ÙŠÙ†Ø© Ø´Ø§Ø´Ø© Ø§Ù„Ø®Ø§ØªÙ…Ø© Ø¥Ø°Ø§ Ù…ÙØ¹Ù„Ø©
                                const enableOutro = document.getElementById('enableOutro').checked;
                                if (enableOutro) {
                                    isOutroPhase = true;
                                    outroAnimProgress = 0;
                                    const outroDuration = parseInt(document.getElementById('outroDuration').value) || 10;
                                    setTimeout(() => {
                                        isOutroPhase = false;

                                        // Ù…Ø¹Ø§ÙŠÙ†Ø© ÙÙŠØ¯ÙŠÙˆ/ØµÙˆØ±Ø© Ø§Ù„Ø®Ø§ØªÙ…Ø© Ø¥Ø°Ø§ Ù…ÙˆØ¬ÙˆØ¯Ø©
                                        if (endMedia) {
                                            isEndPhase = true;
                                            btn.innerText = "â³ Ù…Ø¹Ø§ÙŠÙ†Ø© ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø®Ø§ØªÙ…Ø©...";

                                            if (endMedia.tagName === 'VIDEO') {
                                                endMedia.currentTime = 0;
                                                endMedia.muted = false;
                                                endMedia.play();
                                                endMedia.onended = () => {
                                                    isEndPhase = false;
                                                    endMedia.muted = true;
                                                    btn.disabled = false;
                                                    btn.innerText = originalText;
                                                    alert("âœ… Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©!");
                                                };
                                            } else {
                                                // ØµÙˆØ±Ø© - Ø¹Ø±Ø¶ Ù„Ù…Ø¯Ø© 5 Ø«ÙˆØ§Ù†ÙŠ
                                                setTimeout(() => {
                                                    isEndPhase = false;
                                                    btn.disabled = false;
                                                    btn.innerText = originalText;
                                                    alert("âœ… Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©!");
                                                }, 5000);
                                            }
                                        } else {
                                            btn.disabled = false;
                                            btn.innerText = originalText;
                                            alert("âœ… Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©!");
                                        }
                                    }, outroDuration * 1000);
                                } else {
                                    // Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ø´Ø§Ø´Ø© Ø§Ù„Ø®Ø§ØªÙ…Ø© Ù…ÙØ¹Ù„Ø©ØŒ ØªØ­Ù‚Ù‚ Ù…Ù† ÙÙŠØ¯ÙŠÙˆ/ØµÙˆØ±Ø© Ø§Ù„Ø®Ø§ØªÙ…Ø©
                                    if (endMedia) {
                                        isEndPhase = true;
                                        btn.innerText = "â³ Ù…Ø¹Ø§ÙŠÙ†Ø© ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø®Ø§ØªÙ…Ø©...";

                                        if (endMedia.tagName === 'VIDEO') {
                                            endMedia.currentTime = 0;
                                            endMedia.muted = false;
                                            endMedia.play();
                                            endMedia.onended = () => {
                                                isEndPhase = false;
                                                endMedia.muted = true;
                                                btn.disabled = false;
                                                btn.innerText = originalText;
                                                alert("âœ… Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©!");
                                            };
                                        } else {
                                            // ØµÙˆØ±Ø© - Ø¹Ø±Ø¶ Ù„Ù…Ø¯Ø© 5 Ø«ÙˆØ§Ù†ÙŠ
                                            setTimeout(() => {
                                                isEndPhase = false;
                                                btn.disabled = false;
                                                btn.innerText = originalText;
                                                alert("âœ… Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©!");
                                            }, 5000);
                                        }
                                    } else {
                                        btn.disabled = false;
                                        btn.innerText = originalText;
                                        alert("âœ… Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©!");
                                    }
                                }
                            }
                        }, 100);
                    } else {
                        alert("âš ï¸ ÙŠØ¬Ø¨ ØªØ­Ø¯ÙŠØ¯ Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø£ÙˆÙ„Ø§Ù‹!");
                        btn.disabled = false;
                        btn.innerText = originalText;
                    }
                } else {
                    // Ù…Ø¹Ø§ÙŠÙ†Ø© Ù…Ø¹ ØªØ´ØºÙŠÙ„ ÙƒÙ„ Ø¢ÙŠØ©
                    for (let i = 0; i < clips.length; i++) {
                        btn.innerText = `â³ Ù…Ø¹Ø§ÙŠÙ†Ø©... (${i + 1}/${clips.length})`;
                        currentIdx = i; // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¢ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
                        fade = 1; // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¢ÙŠØ© Ù…Ø¨Ø§Ø´Ø±Ø©
                        selectClip(i);
                        await new Promise(r => {
                            player.onended = r;
                            setTimeout(r, 30000);
                        });
                        await new Promise(r => setTimeout(r, 500));
                    }

                    // Ù…Ø¹Ø§ÙŠÙ†Ø© Ø´Ø§Ø´Ø© Ø§Ù„Ø®Ø§ØªÙ…Ø©
                    const enableOutro = document.getElementById('enableOutro').checked;
                    if (enableOutro) {
                        isOutroPhase = true;
                        outroAnimProgress = 0;
                        btn.innerText = "â³ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø®Ø§ØªÙ…Ø© Ø§Ù„Ù†ØµÙŠØ©...";
                        const outroDuration = parseInt(document.getElementById('outroDuration').value) || 10;
                        await new Promise(r => setTimeout(r, outroDuration * 1000));
                        isOutroPhase = false;
                    }

                    // Ù…Ø¹Ø§ÙŠÙ†Ø© ÙÙŠØ¯ÙŠÙˆ/ØµÙˆØ±Ø© Ø§Ù„Ø®Ø§ØªÙ…Ø© Ø¥Ø°Ø§ Ù…ÙˆØ¬ÙˆØ¯Ø©
                    if (endMedia) {
                        isEndPhase = true;
                        btn.innerText = "â³ Ù…Ø¹Ø§ÙŠÙ†Ø© ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø®Ø§ØªÙ…Ø©...";

                        if (endMedia.tagName === 'VIDEO') {
                            endMedia.currentTime = 0;
                            endMedia.muted = false;
                            endMedia.play();
                            await new Promise(resolve => {
                                endMedia.onended = resolve;
                            });
                            endMedia.muted = true;
                            isEndPhase = false;
                        } else {
                            // ØµÙˆØ±Ø© - Ø¹Ø±Ø¶ Ù„Ù…Ø¯Ø© 5 Ø«ÙˆØ§Ù†ÙŠ
                            await new Promise(r => setTimeout(r, 5000));
                            isEndPhase = false;
                        }
                    }

                    btn.disabled = false;
                    btn.innerText = originalText;
                    alert("âœ… Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©!");
                }
            } catch (error) {
                console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©:", error);
                btn.disabled = false;
                btn.innerText = originalText;
                alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©");
            }
        }

        async function exportVideo() {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¢ÙŠØ§Øª
            if (clips.length === 0) {
                alert("âš ï¸ ÙŠØ¬Ø¨ Ø¬Ù„Ø¨ Ø§Ù„Ø¢ÙŠØ§Øª Ø£ÙˆÙ„Ø§Ù‹!");
                return;
            }

            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
            resetPlayback();

            const btn = document.getElementById('exportBtn');
            btn.disabled = true;
            btn.innerText = "ğŸ”´ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØµØ¯ÙŠØ±...";

            if (!audioCtx) {
                audioCtx = new AudioContext();
                dest = audioCtx.createMediaStreamDestination();
                s1 = audioCtx.createMediaElementSource(player);
                s2 = audioCtx.createMediaElementSource(bgMusic);
                s1.connect(dest); s1.connect(audioCtx.destination);
                s2.connect(dest); s2.connect(audioCtx.destination);
            }

            const stream = canvas.captureStream(60);
            const recorder = new RecordRTC(new MediaStream([...stream.getTracks(), ...dest.stream.getTracks()]), {
                type: 'video',
                mimeType: 'video/webm;codecs=vp9',
                videoBitsPerSecond: 15000000
            });

            recorder.startRecording();

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØµÙˆØª ÙƒØ§Ù…Ù„ Ù…Ø±ÙÙˆØ¹
            if (hasFullAudio) {
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØµÙˆØª Ø§Ù„ÙƒØ§Ù…Ù„ Ø§Ù„Ù…Ø±ÙÙˆØ¹
                console.log("ğŸ¬ Ø¨Ø¯Ø¡ Ø§Ù„ØªØµØ¯ÙŠØ± - Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØµÙˆØª Ø§Ù„ÙƒØ§Ù…Ù„ Ø§Ù„Ù…Ø±ÙÙˆØ¹");

                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ø²Ø§Ù…Ù†Ø© Ù„Ù„Ø¢ÙŠØ§Øª
                const lastClipIndex = clips.length - 1;
                const hasSync = clips.some(c => c.syncTime !== undefined);

                if (hasSync && clips[lastClipIndex].syncTime !== undefined) {
                    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ù…Ø²Ø§Ù…Ù†Ø©ØŒ Ù†Ø­Ø³Ø¨ ÙˆÙ‚Øª Ø§Ù„Ù†Ù‡Ø§ÙŠØ©
                    const lastAyahStartTime = clips[lastClipIndex].syncTime;

                    // ØªÙ‚Ø¯ÙŠØ± Ù…Ø¯Ø© Ø§Ù„Ø¢ÙŠØ© Ø§Ù„Ø£Ø®ÙŠØ±Ø© (5 Ø«ÙˆØ§Ù†ÙŠ ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰ Ø£Ùˆ Ø­ØªÙ‰ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ØµÙˆØª)
                    let estimatedDuration = 5;
                    if (lastClipIndex > 0 && clips[lastClipIndex - 1].syncTime !== undefined) {
                        // Ø­Ø³Ø§Ø¨ Ù…ØªÙˆØ³Ø· Ù…Ø¯Ø© Ø§Ù„Ø¢ÙŠØ§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
                        let totalDuration = 0;
                        let count = 0;
                        for (let i = 1; i < clips.length; i++) {
                            if (clips[i].syncTime !== undefined && clips[i - 1].syncTime !== undefined) {
                                totalDuration += clips[i].syncTime - clips[i - 1].syncTime;
                                count++;
                            }
                        }
                        if (count > 0) {
                            estimatedDuration = totalDuration / count;
                        }
                    }

                    const endTime = lastAyahStartTime + estimatedDuration;

                    btn.innerText = `ğŸ”´ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØµØ¯ÙŠØ±... (${clips.length} Ø¢ÙŠØ§Øª)`;

                    // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¢ÙŠØ© Ø§Ù„Ø£ÙˆÙ„Ù‰ ÙˆØ¥Ø¸Ù‡Ø§Ø±Ù‡Ø§
                    currentIdx = 0;
                    fade = 1;

                    // ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª Ù…Ù† Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
                    player.currentTime = 0;
                    await player.play();

                    // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ÙˆÙ‚Øª ÙˆØ¥ÙŠÙ‚Ø§Ù Ø§Ù„ØµÙˆØª Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
                    await new Promise(resolve => {
                        const checkTime = setInterval(() => {
                            if (player.currentTime >= endTime || player.ended) {
                                clearInterval(checkTime);
                                player.pause();
                                resolve();
                            }
                        }, 100);

                        // timeout Ø§Ø­ØªÙŠØ§Ø·ÙŠ
                        setTimeout(() => {
                            clearInterval(checkTime);
                            player.pause();
                            resolve();
                        }, (endTime + 2) * 1000);
                    });

                    console.log(`âœ… Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ØªØµØ¯ÙŠØ± Ø¹Ù†Ø¯ ${endTime.toFixed(2)} Ø«Ø§Ù†ÙŠØ©`);
                } else {
                    // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ù…Ø²Ø§Ù…Ù†Ø©ØŒ Ù†Ø¨Ù„Øº Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                    alert("âš ï¸ ÙŠØ¬Ø¨ ØªØ­Ø¯ÙŠØ¯ Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø£ÙˆÙ„Ø§Ù‹!\n\n1. Ø´ØºÙ‘Ù„ Ø§Ù„ØµÙˆØª\n2. Ø§Ø¶ØºØ· 'Ø§Ù„Ø¢ÙŠØ© Ø§Ù„ØªØ§Ù„ÙŠØ©' Ø¹Ù†Ø¯ Ø¨Ø¯Ø§ÙŠØ© ÙƒÙ„ Ø¢ÙŠØ©\n3. Ø§Ø¶ØºØ· 'ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†Ù‡Ø§ÙŠØ©' Ø¹Ù†Ø¯ Ù†Ù‡Ø§ÙŠØ© Ø¢Ø®Ø± Ø¢ÙŠØ©");
                    btn.disabled = false;
                    btn.innerText = "ğŸš€ ØªØµØ¯ÙŠØ± Ø§Ù„ÙÙŠØ¯ÙŠÙˆ (Ø¬ÙˆØ¯Ø© HD)";
                    return;
                }
            } else {
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ© (ØªØ´ØºÙŠÙ„ ÙƒÙ„ Ø¢ÙŠØ© Ù„ÙˆØ­Ø¯Ù‡Ø§)
                console.log("ğŸ¬ Ø¨Ø¯Ø¡ Ø§Ù„ØªØµØ¯ÙŠØ± - ØªØ´ØºÙŠÙ„ ÙƒÙ„ Ø¢ÙŠØ© Ù„ÙˆØ­Ø¯Ù‡Ø§");
                for (let i = 0; i < clips.length; i++) {
                    console.log(`ğŸ“– ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¢ÙŠØ© ${i + 1}/${clips.length}`);
                    btn.innerText = `ğŸ”´ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØµØ¯ÙŠØ±... (${i + 1}/${clips.length})`;
                    currentIdx = i; // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¢ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
                    fade = 1; // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¢ÙŠØ© Ù…Ø¨Ø§Ø´Ø±Ø©
                    selectClip(i);
                    await new Promise(r => {
                        player.onended = r;
                        setTimeout(r, 30000); // timeout 30 Ø«Ø§Ù†ÙŠØ© max
                    });
                    await new Promise(r => setTimeout(r, 500));
                }
                console.log("âœ… Ø§Ù†ØªÙ‡Ù‰ ØªØ´ØºÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¢ÙŠØ§Øª");
            }

            // Ø´Ø§Ø´Ø© Ø§Ù„Ø®Ø§ØªÙ…Ø© Ø§Ù„Ù†ØµÙŠØ©
            const enableOutro = document.getElementById('enableOutro').checked;
            if (enableOutro) {
                isOutroPhase = true;
                outroAnimProgress = 0; // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØªÙ‚Ø¯Ù…
                btn.innerText = "â³ ØªØ³Ø¬ÙŠÙ„ Ø´Ø§Ø´Ø© Ø§Ù„Ø®Ø§ØªÙ…Ø© Ø§Ù„Ù†ØµÙŠØ©...";
                const outroDuration = parseInt(document.getElementById('outroDuration').value) || 10;

                // Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© + Ø«Ø§Ù†ÙŠØ© Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„ØªØ£ÙƒØ¯
                await new Promise(r => setTimeout(r, (outroDuration + 1) * 1000));

                isOutroPhase = false;
            }

            // ÙÙŠØ¯ÙŠÙˆ/ØµÙˆØ±Ø© Ø§Ù„Ø®Ø§ØªÙ…Ø©
            if (endMedia) {
                isEndPhase = true;
                btn.innerText = "â³ ØªØ³Ø¬ÙŠÙ„ ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø®Ø§ØªÙ…Ø©...";
                if (endMedia.tagName === 'VIDEO') {
                    if (!sEnd) {
                        sEnd = audioCtx.createMediaElementSource(endMedia);
                        sEnd.connect(dest);
                        sEnd.connect(audioCtx.destination);
                    }
                    endMedia.muted = false;
                    endMedia.currentTime = 0;
                    await endMedia.play();
                    await new Promise(r => {
                        endMedia.onended = r;
                        setTimeout(r, (endMedia.duration * 1000) + 1000);
                    });
                } else {
                    // ØµÙˆØ±Ø© - Ø¹Ø±Ø¶ Ù„Ù…Ø¯Ø© 5 Ø«ÙˆØ§Ù†ÙŠ
                    await new Promise(r => setTimeout(r, 5000));
                }
                isEndPhase = false;
            }

            recorder.stopRecording(() => {
                const a = document.createElement('a');
                a.href = URL.createObjectURL(recorder.getBlob());
                a.download = `Quran_HD_Final.webm`;
                a.click();
                btn.disabled = false;
                btn.innerText = "ğŸš€ ØªØµØ¯ÙŠØ± Ø§Ù„ÙÙŠØ¯ÙŠÙˆ (Ø¬ÙˆØ¯Ø© HD)";
                isEndPhase = false;
                isOutroPhase = false;
            });
        }

        // âš¡ FFmpeg Export - ØªØµØ¯ÙŠØ± Ø³Ø±ÙŠØ¹ Ø¨Ø¯ÙˆÙ† ØªØ³Ø¬ÙŠÙ„
        let ffmpegInstance = null;
        let ffmpegLoaded = false;

        async function loadFFmpeg() {
            if (ffmpegLoaded && ffmpegInstance) {
                return ffmpegInstance;
            }

            try {
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… FFmpeg 0.12.x API Ø§Ù„Ø¬Ø¯ÙŠØ¯
                const { FFmpeg } = FFmpegWASM;
                const { toBlobURL } = FFmpegUtil;

                ffmpegInstance = new FFmpeg();

                updateFFmpegProgress('loading', 10, 'â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ FFmpeg...');

                const baseURL = 'https://unpkg.com/@ffmpeg/core@0.12.6/dist/umd';
                await ffmpegInstance.load({
                    coreURL: await toBlobURL(`${baseURL}/ffmpeg-core.js`, 'text/javascript'),
                    wasmURL: await toBlobURL(`${baseURL}/ffmpeg-core.wasm`, 'application/wasm'),
                });

                ffmpegLoaded = true;
                updateFFmpegProgress('loading', 30, 'âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ FFmpeg Ø¨Ù†Ø¬Ø§Ø­');

                return ffmpegInstance;
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ FFmpeg:', error);
                throw new Error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ FFmpeg: ' + error.message);
            }
        }

        function updateFFmpegProgress(status, percent, message) {
            const btn = document.getElementById('ffmpegExportBtn');
            const progressDiv = document.getElementById('ffmpegProgress');
            const statusText = document.getElementById('ffmpegStatus');
            const progressBar = document.getElementById('ffmpegProgressBar');
            const detailsText = document.getElementById('ffmpegDetails');

            if (btn) {
                btn.innerText = `${message} (${percent}%)`;
            }

            if (progressDiv) {
                progressDiv.style.display = 'block';
            }

            if (statusText) {
                statusText.innerText = message;
            }

            if (progressBar) {
                progressBar.style.width = `${percent}%`;
            }

            if (detailsText) {
                detailsText.innerText = `${percent}%`;
            }

            console.log(`[FFmpeg] ${message} - ${percent}%`);
        }

        async function exportWithFFmpeg() {
            if (clips.length === 0) {
                alert("âš ï¸ ÙŠØ¬Ø¨ Ø¬Ù„Ø¨ Ø§Ù„Ø¢ÙŠØ§Øª Ø£ÙˆÙ„Ø§Ù‹!");
                return;
            }

            const btn = document.getElementById('ffmpegExportBtn');
            btn.disabled = true;
            btn.innerText = "âš¡ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¶ÙŠØ±...";

            try {
                // ØªØ­Ù…ÙŠÙ„ FFmpeg
                updateFFmpegProgress('loading', 5, 'â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ FFmpeg');
                const ffmpeg = await loadFFmpeg();

                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
                resetPlayback();

                // Ø­Ø³Ø§Ø¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯Ø©
                let totalDuration = 0;
                if (hasFullAudio && clips.some(c => c.syncTime !== undefined)) {
                    const lastClipIndex = clips.length - 1;
                    const lastAyahStartTime = clips[lastClipIndex].syncTime;
                    let estimatedDuration = 5;

                    if (lastClipIndex > 0 && clips[lastClipIndex - 1].syncTime !== undefined) {
                        let totalDur = 0;
                        let count = 0;
                        for (let i = 1; i < clips.length; i++) {
                            if (clips[i].syncTime !== undefined && clips[i - 1].syncTime !== undefined) {
                                totalDur += clips[i].syncTime - clips[i - 1].syncTime;
                                count++;
                            }
                        }
                        if (count > 0) {
                            estimatedDuration = totalDur / count;
                        }
                    }
                    totalDuration = lastAyahStartTime + estimatedDuration;
                } else {
                    totalDuration = clips.length * 5; // ØªÙ‚Ø¯ÙŠØ± 5 Ø«ÙˆØ§Ù†ÙŠ Ù„ÙƒÙ„ Ø¢ÙŠØ©
                }

                const fps = 30;
                const totalFrames = Math.ceil(totalDuration * fps);

                updateFFmpegProgress('rendering', 35, `â³ Ø¬Ø§Ø±ÙŠ Ø±Ø³Ù… ${totalFrames} Ø¥Ø·Ø§Ø±`);

                // Ø±Ø³Ù… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø·Ø§Ø±Ø§Øª
                const frames = [];
                for (let frameNum = 0; frameNum < totalFrames; frameNum++) {
                    const currentTime = frameNum / fps;

                    // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¢ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ÙˆÙ‚Øª
                    if (hasFullAudio && clips.some(c => c.syncTime !== undefined)) {
                        for (let i = clips.length - 1; i >= 0; i--) {
                            if (clips[i].syncTime !== undefined && currentTime >= clips[i].syncTime) {
                                currentIdx = i;
                                break;
                            }
                        }
                    } else {
                        currentIdx = Math.floor(currentTime / 5) % clips.length;
                    }

                    fade = 1; // Ø¥Ø¸Ù‡Ø§Ø± ÙƒØ§Ù…Ù„

                    // Ø±Ø³Ù… Ø§Ù„Ø¥Ø·Ø§Ø±
                    draw();

                    // ØªØ­ÙˆÙŠÙ„ Canvas Ø¥Ù„Ù‰ Blob
                    const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.95));
                    frames.push(blob);

                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ‚Ø¯Ù…
                    if (frameNum % 30 === 0) {
                        const progress = 35 + Math.floor((frameNum / totalFrames) * 30);
                        updateFFmpegProgress('rendering', progress, `â³ Ø±Ø³Ù… Ø§Ù„Ø¥Ø·Ø§Ø±Ø§Øª: ${frameNum}/${totalFrames}`);
                    }
                }

                updateFFmpegProgress('processing', 65, 'â³ Ø¬Ø§Ø±ÙŠ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø¥Ø·Ø§Ø±Ø§Øª Ø¥Ù„Ù‰ FFmpeg');

                // ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø¥Ø·Ø§Ø±Ø§Øª Ø¥Ù„Ù‰ FFmpeg (API 0.12.x)
                const { fetchFile } = FFmpegUtil;
                for (let i = 0; i < frames.length; i++) {
                    const frameData = await fetchFile(frames[i]);
                    await ffmpeg.writeFile(`frame${String(i).padStart(6, '0')}.jpg`, frameData);

                    if (i % 30 === 0) {
                        const progress = 65 + Math.floor((i / frames.length) * 10);
                        updateFFmpegProgress('processing', progress, `â³ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø¥Ø·Ø§Ø±Ø§Øª: ${i}/${frames.length}`);
                    }
                }

                updateFFmpegProgress('processing', 75, 'â³ Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØª');

                // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØª
                let audioFileName = null;
                if (hasFullAudio && player.src) {
                    try {
                        const audioBlob = await fetch(player.src).then(r => r.blob());
                        const audioData = await fetchFile(audioBlob);
                        audioFileName = 'audio.mp3';
                        await ffmpeg.writeFile(audioFileName, audioData);
                    } catch (error) {
                        console.warn('ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØª:', error);
                    }
                }

                updateFFmpegProgress('encoding', 80, 'â³ Ø¬Ø§Ø±ÙŠ Ø¯Ù…Ø¬ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ (Ù‚Ø¯ ÙŠØ³ØªØºØ±Ù‚ Ø¯Ù‚Ø§Ø¦Ù‚)');

                // Ø¯Ù…Ø¬ Ø§Ù„Ø¥Ø·Ø§Ø±Ø§Øª ÙˆØ§Ù„ØµÙˆØª
                const outputFileName = 'output.mp4';
                const ffmpegArgs = [
                    '-framerate', String(fps),
                    '-i', 'frame%06d.jpg',
                ];

                if (audioFileName) {
                    ffmpegArgs.push('-i', audioFileName);
                    ffmpegArgs.push('-c:a', 'aac');
                    ffmpegArgs.push('-b:a', '192k');
                    ffmpegArgs.push('-shortest');
                }

                ffmpegArgs.push(
                    '-c:v', 'libx264',
                    '-preset', 'medium',
                    '-crf', '23',
                    '-pix_fmt', 'yuv420p',
                    '-movflags', '+faststart',
                    outputFileName
                );

                await ffmpeg.exec(ffmpegArgs);

                updateFFmpegProgress('downloading', 95, 'â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ');

                // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
                const data = await ffmpeg.readFile(outputFileName);
                const videoBlob = new Blob([data.buffer], { type: 'video/mp4' });
                const url = URL.createObjectURL(videoBlob);

                const a = document.createElement('a');
                a.href = url;
                a.download = 'Quran_FFmpeg_Export.mp4';
                a.click();

                updateFFmpegProgress('done', 100, 'âœ… ØªÙ… Ø§Ù„ØªØµØ¯ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­!');

                // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ù„ÙØ§Øª
                setTimeout(async () => {
                    try {
                        for (let i = 0; i < frames.length; i++) {
                            await ffmpeg.deleteFile(`frame${String(i).padStart(6, '0')}.jpg`);
                        }
                        if (audioFileName) {
                            await ffmpeg.deleteFile(audioFileName);
                        }
                        await ffmpeg.deleteFile(outputFileName);
                    } catch (e) {
                        console.warn('ØªØ¹Ø°Ø± ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ù„ÙØ§Øª:', e);
                    }
                }, 1000);

                setTimeout(() => {
                    btn.disabled = false;
                    btn.innerText = "âš¡ ØªØµØ¯ÙŠØ± Ø³Ø±ÙŠØ¹ FFmpeg (Ø£Ø³Ø±Ø¹ 3x)";
                    const progressDiv = document.getElementById('ffmpegProgress');
                    if (progressDiv) {
                        progressDiv.style.display = 'none';
                    }
                }, 3000);

            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØµØ¯ÙŠØ±:', error);
                alert(`âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØµØ¯ÙŠØ±:\n${error.message}\n\nØªØ£ÙƒØ¯ Ù…Ù†:\n1. Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù Ø¹Ù„Ù‰ Ø®Ø§Ø¯Ù… (GitHub Pages)\n2. Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…ØªØµÙØ­ Ø­Ø¯ÙŠØ« (Chrome/Edge)`);
                btn.disabled = false;
                btn.innerText = "âš¡ ØªØµØ¯ÙŠØ± Ø³Ø±ÙŠØ¹ FFmpeg (Ø£Ø³Ø±Ø¹ 3x)";
                const progressDiv = document.getElementById('ffmpegProgress');
                if (progressDiv) {
                    progressDiv.style.display = 'none';
                }
            }
        }

        // ğŸ¤– Ø§Ù„ØªØµØ¯ÙŠØ± Ø§Ù„Ø°ÙƒÙŠ - Ù…Ø²Ø§Ù…Ù†Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ø¨Ø§Ù„Ù€ AI
        async function smartExport() {
            if (clips.length === 0) {
                alert("âš ï¸ ÙŠØ¬Ø¨ Ø¬Ù„Ø¨ Ø§Ù„Ø¢ÙŠØ§Øª Ø£ÙˆÙ„Ø§Ù‹!");
                return;
            }

            const btn = document.getElementById('smartExportBtn');
            btn.disabled = true;
            btn.innerText = "ğŸ¤– Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø°ÙƒÙŠØ©...";

            try {
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¯Ø¹Ù… Web Speech API
                if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                    alert("âš ï¸ Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØª. Ø§Ø³ØªØ®Ø¯Ù… Chrome Ø£Ùˆ Edge");
                    btn.disabled = false;
                    btn.innerText = "ğŸ¤– ØªØµØ¯ÙŠØ± Ø°ÙƒÙŠ (Ù…Ø²Ø§Ù…Ù†Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ©)";
                    return;
                }

                // Ù…Ø³Ø­ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
                clips.forEach(c => c.syncTime = undefined);
                videoEndTime = 0;

                // Ø¥Ù†Ø´Ø§Ø¡ Speech Recognition
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                const recognition = new SpeechRecognition();
                recognition.lang = 'ar-SA';
                recognition.continuous = true;
                recognition.interimResults = true;

                let currentClipIndex = 0;
                let recognizedText = '';

                recognition.onresult = (event) => {
                    const transcript = Array.from(event.results)
                        .map(result => result[0].transcript)
                        .join('');

                    recognizedText = transcript;
                    console.log("ğŸ¤ Ø³Ù…Ø¹Øª:", transcript);

                    // Ù…Ù‚Ø§Ø±Ù†Ø© Ù…Ø¹ Ù†Øµ Ø§Ù„Ø¢ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
                    if (currentClipIndex < clips.length) {
                        const currentAyah = clips[currentClipIndex].ar;
                        const similarity = calculateSimilarity(transcript, currentAyah);

                        console.log(`ğŸ“Š Ø§Ù„ØªØ´Ø§Ø¨Ù‡ Ù…Ø¹ Ø§Ù„Ø¢ÙŠØ© ${currentClipIndex + 1}: ${similarity}%`);

                        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ØªØ´Ø§Ø¨Ù‡ Ø£ÙƒØ«Ø± Ù…Ù† 30%ØŒ Ø³Ø¬Ù„ Ø§Ù„ÙˆÙ‚Øª
                        if (similarity > 30 && clips[currentClipIndex].syncTime === undefined) {
                            clips[currentClipIndex].syncTime = player.currentTime;
                            console.log(`âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¢ÙŠØ© ${currentClipIndex + 1} Ø¹Ù†Ø¯ ${player.currentTime.toFixed(2)} Ø«Ø§Ù†ÙŠØ©`);
                            currentClipIndex++;
                            renderTimeline();

                            if (currentClipIndex >= clips.length) {
                                recognition.stop();
                            }
                        }
                    }
                };

                recognition.onerror = (event) => {
                    console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØª:", event.error);
                };

                recognition.onend = () => {
                    console.log("ğŸ¤ Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØª");
                };

                // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„ ÙˆØ§Ù„ØªØ¹Ø±Ù
                btn.innerText = "ğŸ¤ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹...";
                player.currentTime = 0;
                await player.play();
                recognition.start();

                // Ø§Ù†ØªØ¸Ø± Ø­ØªÙ‰ ÙŠÙ†ØªÙ‡ÙŠ Ø§Ù„ØµÙˆØª Ø£Ùˆ ÙŠØªÙ… Ù…Ø²Ø§Ù…Ù†Ø© ÙƒÙ„ Ø§Ù„Ø¢ÙŠØ§Øª
                await new Promise((resolve) => {
                    const checker = setInterval(() => {
                        if (player.ended || currentClipIndex >= clips.length) {
                            clearInterval(checker);
                            recognition.stop();
                            videoEndTime = player.currentTime;
                            resolve();
                        }
                    }, 500);
                });

                player.pause();
                btn.innerText = "âœ… ØªÙ…Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©! Ø§Ø¶ØºØ· ØªØµØ¯ÙŠØ±";
                btn.disabled = false;

                // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
                const syncedCount = clips.filter(c => c.syncTime !== undefined).length;
                alert(`ğŸ‰ ØªÙ…Øª Ù…Ø²Ø§Ù…Ù†Ø© ${syncedCount} Ù…Ù† ${clips.length} Ø¢ÙŠØ©!\n\nÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ "ØªØµØ¯ÙŠØ± Ø³Ø±ÙŠØ¹"`);

            } catch (error) {
                console.error("âŒ Ø®Ø·Ø£:", error);
                alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø°ÙƒÙŠØ©");
                btn.disabled = false;
                btn.innerText = "ğŸ¤– ØªØµØ¯ÙŠØ± Ø°ÙƒÙŠ (Ù…Ø²Ø§Ù…Ù†Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ©)";
            }
        }

        // Ø¯Ø§Ù„Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„ØªØ´Ø§Ø¨Ù‡ Ø¨ÙŠÙ† Ù†ØµÙŠÙ†
        function calculateSimilarity(text1, text2) {
            // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù†ØµÙˆØµ
            const clean1 = text1.replace(/[^\u0600-\u06FF\s]/g, '').trim().toLowerCase();
            const clean2 = text2.replace(/[^\u0600-\u06FF\s]/g, '').trim().toLowerCase();

            const words1 = clean1.split(/\s+/);
            const words2 = clean2.split(/\s+/);

            // Ø­Ø³Ø§Ø¨ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø´ØªØ±ÙƒØ©
            let matches = 0;
            words1.forEach(word => {
                if (words2.some(w => w.includes(word) || word.includes(w))) {
                    matches++;
                }
            });

            return Math.round((matches / Math.max(words1.length, words2.length)) * 100);
        }

        // ğŸ”„ ØªØ¨Ø³ÙŠØ· Ø§Ù„ØªØµØ¯ÙŠØ± Ø§Ù„Ø°ÙƒÙŠ - Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ø²Ø§Ù…Ù†Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ø¨Ø³ÙŠØ·Ø©
        smartExport = async function () {
            if (clips.length === 0) {
                alert("âš ï¸ ÙŠØ¬Ø¨ Ø¬Ù„Ø¨ Ø§Ù„Ø¢ÙŠØ§Øª Ø£ÙˆÙ„Ø§Ù‹!");
                return;
            }

            const btn = document.getElementById('smartExportBtn');
            btn.disabled = true;
            btn.innerText = "â±ï¸ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©...";

            try {
                clips.forEach(c => c.syncTime = undefined);
                player.currentTime = 0;
                await player.play();

                await new Promise(resolve => {
                    player.onended = resolve;
                    setTimeout(resolve, (player.duration || 60) * 1000 + 2000);
                });

                const totalDuration = player.duration || player.currentTime;
                const avgDuration = totalDuration / clips.length;
                let currentTime = 0;

                clips.forEach((clip, i) => {
                    clip.syncTime = currentTime;
                    currentTime += avgDuration;
                });

                videoEndTime = totalDuration;
                renderTimeline();
                btn.innerText = "âœ… ØªÙ…Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©!";
                btn.disabled = false;

                alert(`ğŸ‰ ØªÙ…Øª Ù…Ø²Ø§Ù…Ù†Ø© ${clips.length} Ø¢ÙŠØ©!\n\nÙ…Ø¯Ø© ÙƒÙ„ Ø¢ÙŠØ©: ${avgDuration.toFixed(1)} Ø«Ø§Ù†ÙŠØ©\n\nØ§Ø¶ØºØ· "ØªØµØ¯ÙŠØ± Ø³Ø±ÙŠØ¹"`);
            } catch (error) {
                alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£");
                btn.disabled = false;
                btn.innerText = "ğŸ¤– ØªØµØ¯ÙŠØ± Ø°ÙƒÙŠ";
            }
        };

        draw();
    </script>
</body>

</html>
