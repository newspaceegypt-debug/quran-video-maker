<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <title>ستوديو القرآن الاحترافي - الإصدار النهائي المكتمل</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/RecordRTC/5.6.2/RecordRTC.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@700&family=Tajawal:wght@500;800&display=swap"
        rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%);
            color: white;
            font-family: 'Tajawal', sans-serif;
            height: 100vh;
            overflow: hidden;
            position: relative;
        }

        /* خلفية متحركة */
        body::before {
            content: '';
            position: fixed;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(16, 185, 129, 0.1) 0%, transparent 70%);
            animation: rotate 20s linear infinite;
            z-index: 0;
            pointer-events: none;
        }

        @keyframes rotate {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .editor-grid {
            display: grid;
            grid-template-columns: 380px 1fr 350px;
            height: 100vh;
            position: relative;
            z-index: 10;
        }

        .sidebar {
            background: linear-gradient(180deg, rgba(13, 13, 13, 0.95) 0%, rgba(26, 26, 46, 0.95) 100%);
            backdrop-filter: blur(10px);
            border-left: 1px solid rgba(16, 185, 129, 0.2);
            padding: 15px;
            overflow-y: auto;
            box-shadow: 0 0 30px rgba(16, 185, 129, 0.1);
        }

        .sidebar::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .sidebar::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #10b981, #059669);
            border-radius: 10px;
        }

        .control-group {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.02) 100%);
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(5px);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .control-group::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(16, 185, 129, 0.1), transparent);
            transition: left 0.5s;
        }

        .control-group:hover::before {
            left: 100%;
        }

        .control-group:hover {
            border-color: rgba(16, 185, 129, 0.4);
            box-shadow: 0 5px 20px rgba(16, 185, 129, 0.2);
            transform: translateY(-2px);
        }

        canvas {
            background: #000;
            border-radius: 20px;
            box-shadow:
                0 0 60px rgba(16, 185, 129, 0.3),
                0 0 100px rgba(16, 185, 129, 0.2),
                inset 0 0 20px rgba(0, 0, 0, 0.5);
            max-height: 75vh;
            width: auto;
            border: 3px solid rgba(16, 185, 129, 0.3);
            transition: all 0.3s ease;
        }

        canvas:hover {
            box-shadow:
                0 0 80px rgba(16, 185, 129, 0.4),
                0 0 120px rgba(16, 185, 129, 0.3);
            transform: scale(1.01);
        }

        input[type="range"] {
            accent-color: #10b981;
            width: 100%;
            height: 6px;
            background: linear-gradient(90deg, rgba(16, 185, 129, 0.2), rgba(16, 185, 129, 0.5));
            border-radius: 10px;
            outline: none;
            transition: all 0.3s;
        }

        input[type="range"]:hover {
            background: linear-gradient(90deg, rgba(16, 185, 129, 0.3), rgba(16, 185, 129, 0.6));
        }

        label {
            font-size: 11px;
            color: #aaa;
            margin-top: 8px;
            display: block;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        select,
        input[type="number"] {
            background: #1a1a1a !important;
            border: 1px solid rgba(16, 185, 129, 0.3);
            color: white !important;
            padding: 8px 45px;
            border-radius: 8px;
            width: 100%;
            font-size: 14px;
            transition: all 0.3s;
            font-weight: 600;
            text-align: center;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            position: relative;
        }

        input[type="number"]:focus {
            outline: none;
            border-color: #10b981;
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.3);
            background: #222 !important;
        }

        /* إخفاء الأزرار الافتراضية */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type="number"] {
            -moz-appearance: textfield;
        }

        /* wrapper للـ number input */
        .number-input-container {
            position: relative;
            width: 100%;
        }

        /* الأزرار المدمجة */
        .number-input-container .number-btn-inline {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(16, 185, 129, 0.1);
            border: none;
            color: #10b981;
            width: 35px;
            height: calc(100% - 4px);
            border-radius: 6px;
            font-size: 16px;
            font-weight: 900;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }

        .number-input-container .number-btn-inline:hover {
            background: rgba(16, 185, 129, 0.3);
            color: white;
        }

        .number-input-container .number-btn-inline:active {
            background: rgba(16, 185, 129, 0.5);
            transform: translateY(-50%) scale(0.95);
        }

        .number-input-container .btn-plus {
            right: 2px;
        }

        .number-input-container .btn-minus {
            left: 2px;
        }

        select:focus,
        input[type="number"]:focus {
            outline: none;
            border-color: #10b981;
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.3);
            background: #222 !important;
        }

        /* تنسيق options داخل select */
        select option {
            background: #1a1a1a !important;
            color: white !important;
            padding: 10px;
            font-size: 13px;
            font-weight: 500;
        }

        select option:hover {
            background: #10b981 !important;
            color: white !important;
        }

        select option:checked {
            background: #10b981 !important;
            color: white !important;
            font-weight: 700;
        }

        /* إضافة سهم مخصص للـ select */
        select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2310b981' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: left 10px center;
            padding-left: 35px;
        }

        .ayah-card {
            background: linear-gradient(135deg, rgba(24, 24, 24, 0.9), rgba(30, 30, 50, 0.9));
            padding: 12px;
            border-radius: 12px;
            margin-bottom: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .ayah-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(16, 185, 129, 0.2), transparent);
            transition: left 0.5s;
        }

        .ayah-card:hover::before {
            left: 100%;
        }

        .ayah-card:hover {
            transform: translateX(-5px);
            border-color: rgba(16, 185, 129, 0.5);
            box-shadow: 0 5px 20px rgba(16, 185, 129, 0.2);
        }

        .ayah-card.active {
            border-color: #10b981;
            background: linear-gradient(135deg, rgba(13, 33, 26, 0.9), rgba(16, 185, 129, 0.2));
            box-shadow: 0 0 25px rgba(16, 185, 129, 0.4);
            transform: translateX(-5px) scale(1.02);
        }

        button {
            transition: all 0.3s ease;
            font-weight: 700;
            position: relative;
            overflow: hidden;
            border: none;
            cursor: pointer;
            border-radius: 12px;
            padding: 10px 20px;
            font-size: 13px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        button:hover::before {
            width: 300px;
            height: 300px;
        }

        button:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4);
        }

        button:active {
            transform: translateY(-1px) scale(0.98);
        }

        /* أزرار خاصة */
        .btn-primary {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4);
            border: 2px solid rgba(16, 185, 129, 0.5);
        }

        .btn-primary:hover {
            box-shadow: 0 12px 30px rgba(16, 185, 129, 0.6);
            border-color: rgba(16, 185, 129, 0.8);
        }

        .btn-secondary {
            background: linear-gradient(135deg, rgba(39, 39, 42, 0.9), rgba(24, 24, 27, 0.9));
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, rgba(50, 50, 55, 0.9), rgba(35, 35, 40, 0.9));
            border-color: rgba(16, 185, 129, 0.3);
        }

        .btn-blue {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4);
            border: 2px solid rgba(59, 130, 246, 0.5);
        }

        .btn-blue:hover {
            box-shadow: 0 12px 30px rgba(59, 130, 246, 0.6);
        }

        #exportBtn {
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
            box-shadow: 0 8px 25px rgba(220, 38, 38, 0.5);
            border: 2px solid rgba(220, 38, 38, 0.6);
            font-size: 18px;
            padding: 16px;
        }

        #exportBtn:hover {
            box-shadow: 0 15px 40px rgba(220, 38, 38, 0.7);
            border-color: rgba(220, 38, 38, 0.9);
        }

        #smartExportBtn {
            background: linear-gradient(135deg, #9333ea 0%, #6b21a8 100%);
            box-shadow: 0 8px 25px rgba(147, 51, 234, 0.5);
            border: 2px solid rgba(147, 51, 234, 0.6);
            font-size: 14px;
            padding: 12px;
        }

        #smartExportBtn:hover {
            box-shadow: 0 15px 40px rgba(147, 51, 234, 0.7);
        }

        h2,
        h3 {
            text-shadow: 0 0 20px rgba(16, 185, 129, 0.5);
        }

        #syncPanel {
            background: linear-gradient(135deg, rgba(39, 39, 42, 0.95), rgba(24, 24, 27, 0.95));
            backdrop-filter: blur(10px);
            border: 2px solid rgba(16, 185, 129, 0.3);
            box-shadow: 0 10px 40px rgba(16, 185, 129, 0.2);
        }

        #syncCounter {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.3), rgba(5, 150, 105, 0.3));
            border: 1px solid rgba(16, 185, 129, 0.5);
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.3);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                box-shadow: 0 0 15px rgba(16, 185, 129, 0.3);
            }

            50% {
                box-shadow: 0 0 25px rgba(16, 185, 129, 0.5);
            }
        }
    </style>
</head>

<body>

    <div class="editor-grid">
        <div class="sidebar">
            <h2 class="text-lg font-black text-emerald-500 mb-4 border-b border-zinc-800 pb-2">🌍 الإعدادات المتقدمة
            </h2>

            <div class="control-group">
                <label>أبعاد الفيديو:</label>
                <div class="grid grid-cols-2 gap-2 mt-1">
                    <button onclick="setMode('portrait')" id="btnP"
                        class="bg-emerald-600 py-2 rounded font-bold text-[10px] border-2 border-white">عمودي
                        (Reels)</button>
                    <button onclick="setMode('landscape')" id="btnL"
                        class="bg-zinc-800 py-2 rounded font-bold text-[10px] border-2 border-transparent">أفقي
                        (YouTube)</button>
                </div>
            </div>

            <div class="control-group">
                <label>السورة والنطاق:</label>
                <select id="surahSelect" class="mb-2"></select>
                <div class="flex gap-2 mb-3">
                    <div class="flex-1 number-input-container">
                        <button type="button" class="number-btn-inline btn-plus"
                            onclick="document.getElementById('startAyah').stepUp()">+</button>
                        <input type="number" id="startAyah" value="1" min="1">
                        <button type="button" class="number-btn-inline btn-minus"
                            onclick="document.getElementById('startAyah').stepDown()">−</button>
                    </div>
                    <div class="flex-1 number-input-container">
                        <button type="button" class="number-btn-inline btn-plus"
                            onclick="document.getElementById('endAyah').stepUp()">+</button>
                        <input type="number" id="endAyah" value="3" min="1">
                        <button type="button" class="number-btn-inline btn-minus"
                            onclick="document.getElementById('endAyah').stepDown()">−</button>
                    </div>
                </div>
                <label>القارئ والترجمة والمعاني:</label>
                <select id="reciterSelect" class="mb-2">
                    <option value="Alafasy_128kbps">مشاري العفاسي</option>
                    <option value="Abdul_Basit_Murattal_192kbps">عبد الباسط عبد الصمد</option>
                    <option value="Ahmed_ibn_Ali_al-Ajamy_128kbps">أحمد العجمي</option>
                    <option value="Fares_Abbad_64kbps">فارس عباد</option>
                    <option value="Maher_AlMuaiqly_128kbps">ماهر المعيقلي</option>
                    <option value="Abdurrahmaan_As-Sudais_192kbps">عبد الرحمن السديس</option>
                    <option value="Abu_Bakr_Ash-Shaatree_128kbps">أبو بكر الشاطري</option>
                    <option value="Hani_Rifai_192kbps">هاني الرفاعي</option>
                    <option value="Muhammad_Ayyoub_128kbps">محمد أيوب</option>
                    <option value="Ghamadi_40kbps">سعد الغامدي</option>
                    <option value="Husary_128kbps">محمود خليل الحصري</option>
                    <option value="Minshawy_Murattal_128kbps">محمد صديق المنشاوي</option>
                </select>
                <select id="langSelect" class="mb-2">
                    <option value="en.ahmedali">English - الإنجليزية</option>
                    <option value="fr.hamidullah">Français - الفرنسية</option>
                    <option value="tr.diyanet">Türkçe - التركية</option>
                    <option value="ur.jalandhry">اردو - Urdu</option>
                    <option value="de.bubenheim">Deutsch - الألمانية</option>
                    <option value="fa.fooladvand">فارسی - الفارسية</option>
                    <option value="es.cortes">Español - الإسبانية</option>
                    <option value="ru.kuliev">Русский - الروسية</option>
                    <option value="id.indonesian">Indonesia - الإندونيسية</option>
                    <option value="bn.bengali">বাংলা - البنغالية</option>
                    <option value="zh.jian">中文 - الصينية</option>
                    <option value="it.piccardo">Italiano - الإيطالية</option>
                    <option value="nl.keyzer">Nederlands - الهولندية</option>
                    <option value="pt.elhayek">Português - البرتغالية</option>
                    <option value="sw.barwani">Kiswahili - السواحيلية</option>
                </select>
                <select id="tafsirSelect" class="mb-2">
                    <option value="ar.muyassar">التفسير الميسر</option>
                    <option value="ar.saadi">تفسير السعدي</option>
                    <option value="ar.jalalayn">تفسير الجلالين</option>
                    <option value="ar.baghawi">تفسير البغوي</option>
                    <option value="ar.qurtubi">تفسير القرطبي</option>
                    <option value="ar.tabari">تفسير الطبري</option>
                    <option value="ar.ibnkathir">تفسير ابن كثير</option>
                    <option value="ar.waseet">التفسير الوسيط</option>
                    <option value="ar.mukhtasar">المختصر في التفسير</option>
                </select>
                <button onclick="importAll()" class="w-full btn-primary py-3 rounded-lg font-bold text-sm mt-2">✨ جلب
                    البيانات</button>
            </div>

            <div class="control-group">
                <h3 class="text-[10px] font-bold text-blue-400 mb-3 uppercase">🎵 الصوت والخلفية</h3>
                <button onclick="document.getElementById('fullAudioIn').click()"
                    class="w-full btn-blue py-3 rounded-lg text-sm mb-2">🎵 رفع صوت التلاوة الكامل</button>
                <p id="audioStatus" class="text-[9px] text-center text-zinc-400 mb-3 font-semibold">لم يتم رفع صوت</p>
                <button onclick="document.getElementById('bgIn').click()"
                    class="w-full btn-secondary py-2 rounded-lg text-[11px] mb-2">🖼️ رفع خلفية</button>
                <button onclick="document.getElementById('logoIn').click()"
                    class="w-full btn-secondary py-2 rounded-lg text-[11px] mb-2">🛡️ رفع شعار</button>
                <button onclick="document.getElementById('bgAudioIn').click()"
                    class="w-full btn-secondary py-2 rounded-lg text-[11px]">🎵 صوت خلفية</button>
            </div>

            <div class="control-group">
                <h3 class="text-[10px] font-bold text-emerald-400 mb-2 uppercase">🎨 التحكم والمظهر</h3>
                <label>شفافية الخلفية:</label>
                <input type="range" id="bgOpacity" min="0" max="1" step="0.05" value="0.7">
                <label>شفافية الشعار:</label>
                <input type="range" id="logoOpacity" min="0" max="1" step="0.05" value="1">
                <label>صوت الخلفية:</label>
                <input type="range" id="bgVol" min="0" max="1" step="0.05" value="0.2">
            </div>

            <div class="control-group">
                <h3 class="text-[10px] font-bold text-purple-400 mb-2 uppercase">✨ تأثيرات الانتقال</h3>
                <label>نوع التأثير:</label>
                <select id="transitionType" class="mb-2">
                    <option value="fade">Fade (تلاشي)</option>
                    <option value="slide-right">Slide من اليمين</option>
                    <option value="slide-left">Slide من اليسار</option>
                    <option value="zoom-in">Zoom In (تكبير)</option>
                    <option value="zoom-out">Zoom Out (تصغير)</option>
                    <option value="none">بدون تأثير</option>
                </select>
                <label>سرعة التأثير:</label>
                <input type="range" id="transitionSpeed" min="0.3" max="2" step="0.1" value="0.8">
                <p class="text-[8px] text-zinc-400 mt-1">القيمة: <span id="transitionSpeedValue">0.8</span> ثانية</p>
            </div>

            <div class="control-group">
                <h3 class="text-[10px] font-bold text-yellow-400 mb-2 uppercase">✍️ نص مخصص</h3>
                <label>عنوان الفيديو:</label>
                <input type="text" id="customTitle" placeholder="مثال: آيات من سورة الفاتحة"
                    class="w-full bg-zinc-900 border border-zinc-700 p-2 rounded text-xs mb-2 text-white">
                <label>اسم القناة:</label>
                <input type="text" id="channelName" placeholder="مثال: قناة القرآن الكريم"
                    class="w-full bg-zinc-900 border border-zinc-700 p-2 rounded text-xs mb-2 text-white">
                <h4 class="text-[9px] font-bold text-zinc-400 mt-3 mb-2">عناصر العرض:</h4>
                <label class="flex items-center gap-2 mt-1">
                    <input type="checkbox" id="showArabicText" checked class="w-4 h-4">
                    <span class="text-[10px]">عرض النص العربي</span>
                </label>
                <label class="flex items-center gap-2 mt-1">
                    <input type="checkbox" id="showMeaning" checked class="w-4 h-4">
                    <span class="text-[10px]">عرض المعنى (التفسير)</span>
                </label>
                <label class="flex items-center gap-2 mt-1">
                    <input type="checkbox" id="showTranslation" checked class="w-4 h-4">
                    <span class="text-[10px]">عرض الترجمة</span>
                </label>
                <label class="flex items-center gap-2 mt-1">
                    <input type="checkbox" id="showAyahNumber" checked class="w-4 h-4">
                    <span class="text-[10px]">عرض رقم الآية</span>
                </label>
                <label class="flex items-center gap-2 mt-1">
                    <input type="checkbox" id="showReciterName" checked class="w-4 h-4">
                    <span class="text-[10px]">عرض اسم القارئ</span>
                </label>
                <label class="flex items-center gap-2 mt-1">
                    <input type="checkbox" id="showDate" class="w-4 h-4">
                    <span class="text-[10px]">عرض التاريخ</span>
                </label>
            </div>

            <div class="control-group">
                <h3 class="text-[10px] font-bold text-cyan-400 mb-2 uppercase">🎨 خلفيات جاهزة</h3>
                <div class="grid grid-cols-3 gap-2">
                    <div onclick="loadPresetBackground('gradient-green')"
                        class="cursor-pointer rounded-lg overflow-hidden border-2 border-transparent hover:border-emerald-500 transition-all">
                        <div class="h-16 bg-gradient-to-b from-emerald-900 via-emerald-800 to-emerald-700"></div>
                        <p class="text-[8px] text-center py-1 bg-zinc-900">أخضر</p>
                    </div>
                    <div onclick="loadPresetBackground('gradient-blue')"
                        class="cursor-pointer rounded-lg overflow-hidden border-2 border-transparent hover:border-blue-500 transition-all">
                        <div class="h-16 bg-gradient-to-b from-blue-900 via-blue-800 to-blue-600"></div>
                        <p class="text-[8px] text-center py-1 bg-zinc-900">أزرق</p>
                    </div>
                    <div onclick="loadPresetBackground('gradient-gold')"
                        class="cursor-pointer rounded-lg overflow-hidden border-2 border-transparent hover:border-yellow-500 transition-all">
                        <div class="h-16 bg-gradient-to-b from-yellow-900 via-yellow-800 to-yellow-700"></div>
                        <p class="text-[8px] text-center py-1 bg-zinc-900">ذهبي</p>
                    </div>
                    <div onclick="loadPresetBackground('gradient-purple')"
                        class="cursor-pointer rounded-lg overflow-hidden border-2 border-transparent hover:border-purple-500 transition-all">
                        <div class="h-16 bg-gradient-to-b from-purple-900 via-purple-800 to-purple-700"></div>
                        <p class="text-[8px] text-center py-1 bg-zinc-900">بنفسجي</p>
                    </div>
                    <div onclick="loadPresetBackground('pattern-1')"
                        class="cursor-pointer rounded-lg overflow-hidden border-2 border-transparent hover:border-emerald-500 transition-all">
                        <div class="h-16 bg-slate-900 flex items-center justify-center">
                            <div class="grid grid-cols-3 gap-1">
                                <div class="w-3 h-3 rounded-full border border-emerald-500/30"></div>
                                <div class="w-3 h-3 rounded-full border border-emerald-500/30"></div>
                                <div class="w-3 h-3 rounded-full border border-emerald-500/30"></div>
                            </div>
                        </div>
                        <p class="text-[8px] text-center py-1 bg-zinc-900">نقوش 1</p>
                    </div>
                    <div onclick="loadPresetBackground('pattern-2')"
                        class="cursor-pointer rounded-lg overflow-hidden border-2 border-transparent hover:border-blue-500 transition-all">
                        <div class="h-16 bg-slate-950 flex items-center justify-center">
                            <div class="grid grid-cols-4 gap-0.5">
                                <div class="w-2 h-2 border-t border-l border-blue-500/20"></div>
                                <div class="w-2 h-2 border-t border-blue-500/20"></div>
                                <div class="w-2 h-2 border-t border-blue-500/20"></div>
                                <div class="w-2 h-2 border-t border-r border-blue-500/20"></div>
                            </div>
                        </div>
                        <p class="text-[8px] text-center py-1 bg-zinc-900">نقوش 2</p>
                    </div>
                    <div onclick="bgMedia = null; alert('✅ تم إزالة الخلفية')"
                        class="cursor-pointer rounded-lg overflow-hidden border-2 border-transparent hover:border-red-500 transition-all">
                        <div class="h-16 bg-black flex items-center justify-center">
                            <span class="text-2xl">❌</span>
                        </div>
                        <p class="text-[8px] text-center py-1 bg-zinc-900">بدون</p>
                    </div>
                </div>
                <p class="text-[7px] text-zinc-500 mt-2">اضغط على الخلفية لاختيارها</p>
            </div>

            <div class="control-group">
                <h3 class="text-[10px] font-bold text-pink-400 mb-2 uppercase">🌐 خلفيات من الإنترنت</h3>
                <div class="grid grid-cols-2 gap-2 mb-2">
                    <button onclick="fetchRandomBackground('image')" class="btn-secondary py-2 rounded-lg text-[10px]">
                        🖼️ صورة عشوائية
                    </button>
                    <button onclick="fetchRandomBackground('video')" class="btn-secondary py-2 rounded-lg text-[10px]">
                        🎬 فيديو عشوائي
                    </button>
                </div>
                <div id="randomBgPreview" class="hidden rounded-lg overflow-hidden border-2 border-pink-500 mb-2">
                    <img id="randomBgImg" class="w-full h-24 object-cover" />
                    <div class="bg-zinc-900 p-2 flex gap-2">
                        <button onclick="useRandomBackground()" class="flex-1 bg-emerald-600 py-1 rounded text-[9px]">
                            ✅ استخدام
                        </button>
                        <button onclick="fetchRandomBackground(currentBgType)"
                            class="flex-1 bg-blue-600 py-1 rounded text-[9px]">
                            🔄 جديدة
                        </button>
                    </div>
                </div>
                <p class="text-[7px] text-zinc-500">خلفيات عالية الجودة من Pexels</p>
            </div>

            <div class="control-group">
                <h3 class="text-[10px] font-bold text-cyan-400 mb-2 uppercase">🎵 موسيقى جاهزة</h3>
                <div class="grid grid-cols-2 gap-2">
                    <div onclick="loadPresetMusic('calm')" id="music-calm"
                        class="cursor-pointer rounded-lg overflow-hidden border-2 border-transparent hover:border-cyan-500 transition-all bg-gradient-to-br from-cyan-900/30 to-cyan-800/30 p-3 text-center">
                        <div class="text-2xl mb-1">🎵</div>
                        <p class="text-[9px] font-bold">هادئة</p>
                    </div>
                    <div onclick="loadPresetMusic('nature')" id="music-nature"
                        class="cursor-pointer rounded-lg overflow-hidden border-2 border-transparent hover:border-green-500 transition-all bg-gradient-to-br from-green-900/30 to-green-800/30 p-3 text-center">
                        <div class="text-2xl mb-1">�</div>
                        <p class="text-[9px] font-bold">طبيعة</p>
                    </div>
                    <div onclick="loadPresetMusic('ambient')" id="music-ambient"
                        class="cursor-pointer rounded-lg overflow-hidden border-2 border-transparent hover:border-purple-500 transition-all bg-gradient-to-br from-purple-900/30 to-purple-800/30 p-3 text-center">
                        <div class="text-2xl mb-1">🎼</div>
                        <p class="text-[9px] font-bold">محيطة</p>
                    </div>
                    <div onclick="loadPresetMusic('')" id="music-none"
                        class="cursor-pointer rounded-lg overflow-hidden border-2 border-emerald-500 hover:border-red-500 transition-all bg-gradient-to-br from-zinc-900/50 to-zinc-800/50 p-3 text-center">
                        <div class="text-2xl mb-1">🔇</div>
                        <p class="text-[9px] font-bold">بدون</p>
                    </div>
                </div>
                <p class="text-[7px] text-zinc-500 mt-2">اضغط لاختيار الموسيقى</p>
            </div>

            <div class="control-group">
                <h3 class="text-[10px] font-bold text-blue-400 mb-2 uppercase">🌈 ألوان الفيديو</h3>
                <label>الإضاءة:</label> <input type="range" id="fBright" min="50" max="150" value="100">
                <label>التباين:</label> <input type="range" id="fContrast" min="50" max="150" value="100">
                <label>تغيير اللون:</label> <input type="range" id="fHue" min="0" max="360" value="0">
            </div>

            <div class="control-group">
                <h3 class="text-[10px] font-bold text-red-400 mb-2 uppercase">🎬 شاشة الخاتمة النصية</h3>
                <label class="flex items-center gap-2 mb-2">
                    <input type="checkbox" id="enableOutro" class="w-4 h-4">
                    <span class="text-[10px]">تفعيل شاشة الخاتمة</span>
                </label>
                <label>النص الرئيسي:</label>
                <textarea id="outroMainText" placeholder="شكراً للمشاهدة&#10;نسأل الله القبول" rows="2"
                    class="w-full bg-zinc-900 border border-zinc-700 p-2 rounded text-xs mb-2 text-white resize-none"></textarea>
                <label>النص الثانوي:</label>
                <textarea id="outroSubText" placeholder="لا تنسى الاشتراك في القناة&#10;وتفعيل الجرس 🔔" rows="2"
                    class="w-full bg-zinc-900 border border-zinc-700 p-2 rounded text-xs mb-2 text-white resize-none"></textarea>
                <label>نص إضافي:</label>
                <textarea id="outroExtraText" placeholder="جزاكم الله خيراً&#10;ونفع بكم الإسلام والمسلمين" rows="2"
                    class="w-full bg-zinc-900 border border-zinc-700 p-2 rounded text-xs mb-2 text-white resize-none"></textarea>
                <label>مدة العرض (ثواني):</label>
                <div class="number-input-container">
                    <button type="button" class="number-btn-inline btn-plus"
                        onclick="document.getElementById('outroDuration').stepUp()">+</button>
                    <input type="number" id="outroDuration" value="10" min="2" max="20">
                    <button type="button" class="number-btn-inline btn-minus"
                        onclick="document.getElementById('outroDuration').stepDown()">−</button>
                </div>
                <label class="flex items-center gap-2 mt-3 mb-2">
                    <input type="checkbox" id="useSameBackground" class="w-4 h-4" checked>
                    <span class="text-[10px]">استخدام نفس خلفية العرض</span>
                </label>
                <label class="mt-2">أو اختر خلفية مخصصة:</label>
                <div class="grid grid-cols-3 gap-2 mt-1">
                    <div onclick="selectOutroBackground('gradient-green')" id="outro-bg-green"
                        class="cursor-pointer rounded-lg overflow-hidden border-2 border-emerald-500 hover:border-emerald-400 transition-all">
                        <div class="h-12 bg-gradient-to-b from-emerald-900 via-emerald-800 to-emerald-700"></div>
                        <p class="text-[7px] text-center py-1 bg-zinc-900">أخضر</p>
                    </div>
                    <div onclick="selectOutroBackground('gradient-blue')" id="outro-bg-blue"
                        class="cursor-pointer rounded-lg overflow-hidden border-2 border-transparent hover:border-blue-400 transition-all">
                        <div class="h-12 bg-gradient-to-b from-blue-900 via-blue-800 to-blue-600"></div>
                        <p class="text-[7px] text-center py-1 bg-zinc-900">أزرق</p>
                    </div>
                    <div onclick="selectOutroBackground('gradient-purple')" id="outro-bg-purple"
                        class="cursor-pointer rounded-lg overflow-hidden border-2 border-transparent hover:border-purple-400 transition-all">
                        <div class="h-12 bg-gradient-to-b from-purple-900 via-purple-800 to-purple-700"></div>
                        <p class="text-[7px] text-center py-1 bg-zinc-900">بنفسجي</p>
                    </div>
                    <div onclick="selectOutroBackground('gradient-gold')" id="outro-bg-gold"
                        class="cursor-pointer rounded-lg overflow-hidden border-2 border-transparent hover:border-yellow-400 transition-all">
                        <div class="h-12 bg-gradient-to-b from-yellow-900 via-yellow-800 to-yellow-700"></div>
                        <p class="text-[7px] text-center py-1 bg-zinc-900">ذهبي</p>
                    </div>
                    <div onclick="selectOutroBackground('dark')" id="outro-bg-dark"
                        class="cursor-pointer rounded-lg overflow-hidden border-2 border-transparent hover:border-zinc-400 transition-all">
                        <div class="h-12 bg-black"></div>
                        <p class="text-[7px] text-center py-1 bg-zinc-900">أسود</p>
                    </div>
                </div>
                <button onclick="previewOutroScreen()" class="w-full btn-blue py-2 rounded-lg text-[10px] mt-2">👁️
                    معاينة النصوص</button>
            </div>

            <div class="control-group">
                <h3 class="text-[10px] font-bold text-red-400 mb-2 uppercase">🎬 فيديو/صورة الخاتمة (اختياري)</h3>
                <button onclick="document.getElementById('endIn').click()"
                    class="w-full btn-secondary py-3 rounded-lg text-sm border-2 border-dashed border-red-500/30 mb-2 relative">
                    <span id="endBtnText">🎬 رفع فيديو/صورة خاتمة</span>
                    <span id="endFileName" class="block text-[10px] text-emerald-400 mt-1 hidden"></span>
                </button>
                <button onclick="previewEndMedia()" class="w-full btn-blue py-2 rounded-lg text-[10px]">👁️ معاينة
                    الفيديو/الصورة</button>
            </div>

            <button id="exportBtn" onclick="exportVideo()"
                class="w-full bg-red-600 py-4 rounded-xl font-black text-lg shadow-lg">🚀 تصدير الفيديو (جودة
                HD)</button>
            <button id="previewBtn" onclick="previewVideo()"
                class="w-full bg-blue-600 py-3 rounded-xl font-bold text-base shadow-lg mt-2">👁️ معاينة
                الفيديو الكامل</button>
            <p class="text-[8px] text-center text-zinc-500 mt-2">المعاينة: تشغيل الفيديو بدون تسجيل</p>
        </div>

        <div class="flex flex-col items-center justify-center p-6 bg-[#030303]">
            <canvas id="mainCanvas" width="720" height="1280" style="max-height: 80vh; max-width: 100%;"></canvas>

            <div id="syncPanel"
                class="mt-4 p-4 bg-zinc-900 rounded-2xl border border-emerald-500/30 flex items-center gap-4 w-full max-w-xl">
                <audio id="player" controls crossorigin="anonymous" class="flex-1"></audio>
                <button onclick="syncNext()"
                    class="btn-primary px-8 py-3 rounded-xl font-bold text-white shadow-lg text-base">⬇️ الآية
                    التالية</button>
                <button onclick="markEnd()"
                    class="bg-gradient-to-r from-orange-600 to-orange-500 hover:from-orange-500 hover:to-orange-400 px-6 py-3 rounded-xl font-bold text-sm shadow-lg border-2 border-orange-400">🏁
                    تحديد النهاية</button>
            </div>

            <audio id="bgMusic" loop crossorigin="anonymous"></audio>
        </div>

        <div class="sidebar border-r border-zinc-800">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-[11px] font-bold text-gray-500 uppercase">📋 كليبات الآيات</h3>
                <span id="syncCounter"
                    class="text-[10px] bg-emerald-900/50 px-2 py-1 rounded text-emerald-300">0/0</span>
            </div>
            <div id="clipsList"></div>
        </div>
    </div>

    <input type="file" id="bgIn" accept="image/*,video/*" class="hidden" onchange="loadMedia(this, 'bg')">
    <input type="file" id="logoIn" accept="image/*" class="hidden" onchange="loadMedia(this, 'logo')">
    <input type="file" id="endIn" accept="image/*,video/*" class="hidden" onchange="loadMedia(this, 'end')">
    <input type="file" id="bgAudioIn" accept="audio/*" class="hidden" onchange="loadBgAudio(this)">
    <input type="file" id="singleAudioIn" accept="audio/*" class="hidden" onchange="handleSingleAudio(this)">
    <input type="file" id="fullAudioIn" accept="audio/*" class="hidden" onchange="handleFullAudio(this)">

    <script>
        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d');
        const player = document.getElementById('player');
        const bgMusic = document.getElementById('bgMusic');
        let clips = [], currentIdx = -1, bgMedia = null, logoImg = null, endMedia = null, fade = 0;
        let isEndPhase = false;
        let isOutroPhase = false;

        // دالة لإعادة تعيين المتغيرات قبل المعاينة/التصدير
        function resetPlayback() {
            currentIdx = -1;
            fade = 0;
            transitionProgress = 0;
            isEndPhase = false;
            isOutroPhase = false;
            outroAnimProgress = 0;
            player.pause();
            player.currentTime = 0;
        }

        // نظام النجوم المتحركة لشاشة الخاتمة
        let outroStars = [];
        function initOutroStars(W, H) {
            outroStars = [];
            // تقليل عدد النجوم من 50 إلى 15 فقط
            for (let i = 0; i < 15; i++) {
                outroStars.push({
                    x: Math.random() * W,
                    y: Math.random() * H,
                    size: Math.random() * 2 + 1,
                    speedX: (Math.random() - 0.5) * 0.3,
                    speedY: (Math.random() - 0.5) * 0.3,
                    opacity: Math.random() * 0.4 + 0.2,
                    twinkle: Math.random() * Math.PI * 2
                });
            }
        }
        let outroStartTime = 0;
        let outroAnimProgress = 0;
        let audioCtx, dest, s1, s2, sEnd;
        let syncPoints = [], videoEndTime = 0;
        let hasFullAudio = false; // متغير لتتبع رفع الصوت الكامل

        // متغيرات التأثيرات والنصوص
        let transitionProgress = 0;
        let transitionType = 'fade';
        let transitionSpeed = 0.8;
        let customTitle = '';
        let channelName = '';
        let showArabicText = true;
        let showMeaning = true;
        let showTranslation = true;
        let showAyahNumber = true;
        let showReciterName = true;
        let showDate = false;
        let currentReciterName = '';

        // تحديث قيمة سرعة التأثير
        document.getElementById('transitionSpeed').addEventListener('input', (e) => {
            transitionSpeed = parseFloat(e.target.value);
            document.getElementById('transitionSpeedValue').innerText = transitionSpeed;
        });

        function setMode(mode) {
            canvas.width = (mode === 'portrait') ? 720 : 1280;
            canvas.height = (mode === 'portrait') ? 1280 : 720;
            document.getElementById('btnP').className = mode === 'portrait' ? "bg-emerald-600 py-2 rounded font-bold text-[10px] border-2 border-white" : "bg-zinc-800 py-2 rounded font-bold text-[10px] border-2 border-transparent";
            document.getElementById('btnL').className = mode === 'landscape' ? "bg-emerald-600 py-2 rounded font-bold text-[10px] border-2 border-white" : "bg-zinc-800 py-2 rounded font-bold text-[10px] border-2 border-transparent";
        }

        fetch('https://api.alquran.cloud/v1/surah').then(r => r.json()).then(d => {
            const s = document.getElementById('surahSelect');
            d.data.forEach(item => s.add(new Option(`${item.number}. ${item.name}`, item.number)));
        });

        // دالة لتحويل اسم القارئ من الكود إلى اسم عربي
        function getReciterArabicName(reciterCode) {
            const reciters = {
                'Alafasy_128kbps': 'مشاري العفاسي',
                'Abdul_Basit_Murattal_192kbps': 'عبد الباسط عبد الصمد',
                'Ahmed_ibn_Ali_al-Ajamy_128kbps': 'أحمد العجمي',
                'Fares_Abbad_64kbps': 'فارس عباد',
                'Maher_AlMuaiqly_128kbps': 'ماهر المعيقلي',
                'Abdurrahmaan_As-Sudais_192kbps': 'عبد الرحمن السديس',
                'Abu_Bakr_Ash-Shaatree_128kbps': 'أبو بكر الشاطري',
                'Hani_Rifai_192kbps': 'هاني الرفاعي',
                'Muhammad_Ayyoub_128kbps': 'محمد أيوب',
                'Ghamadi_40kbps': 'سعد الغامدي',
                'Husary_128kbps': 'محمود خليل الحصري',
                'Minshawy_Murattal_128kbps': 'محمد صديق المنشاوي'
            };
            return reciters[reciterCode] || 'القارئ';
        }

        // دالة لتحويل كود القارئ إلى مسار الصوت الصحيح
        function getReciterAudioPath(reciterCode) {
            // بعض القراء لهم أسماء مختلفة في everyayah.com
            const audioMapping = {
                'Ahmed_ibn_Ali_al-Ajamy_128kbps': 'Ahmed_ibn_Ali_al-Ajamy_128kbps_ketaballah.net',
                'Maher_AlMuaiqly_128kbps': 'MaherAlMuaiqly128kbps'
            };
            return audioMapping[reciterCode] || reciterCode;
        }

        async function importAll() {
            const sNum = document.getElementById('surahSelect').value;
            const start = parseInt(document.getElementById('startAyah').value);
            const end = parseInt(document.getElementById('endAyah').value);
            const rec = document.getElementById('reciterSelect').value;
            const lang = document.getElementById('langSelect').value;
            const tafsir = document.getElementById('tafsirSelect').value;

            // تحديث اسم القارئ
            currentReciterName = getReciterArabicName(rec);

            // الحصول على مسار الصوت الصحيح
            const audioPath = getReciterAudioPath(rec);

            const [rAr, rEn, rMa] = await Promise.all([
                fetch(`https://api.alquran.cloud/v1/surah/${sNum}`),
                fetch(`https://api.alquran.cloud/v1/surah/${sNum}/${lang}`),
                fetch(`https://api.alquran.cloud/v1/surah/${sNum}/${tafsir}`)
            ]);
            const dAr = await rAr.json(), dEn = await rEn.json(), dMa = await rMa.json();

            clips = dAr.data.ayahs.slice(start - 1, end).map((a, i) => ({
                ar: a.text,
                trans: dEn.data.ayahs[start - 1 + i].text,
                meaning: dMa.data.ayahs[start - 1 + i].text,
                audio: `https://www.everyayah.com/data/${audioPath}/${String(sNum).padStart(3, '0')}${String(start + i).padStart(3, '0')}.mp3`
            }));
            renderTimeline(); selectClip(0);
        }

        function renderTimeline() {
            document.getElementById('clipsList').innerHTML = clips.map((c, i) => `
                <div class="ayah-card ${i === currentIdx ? 'active' : ''} ${c.syncTime !== undefined ? 'border-emerald-500 bg-emerald-950/30' : ''}" onclick="selectClip(${i})">
                    <div class="flex justify-between items-center mb-1">
                        <p class="text-[10px] font-bold text-emerald-400">آية ${i + 1}</p>
                        ${c.syncTime !== undefined ? '<span class="text-emerald-400 text-xs">✅</span>' : '<span class="text-zinc-600 text-xs">⏱️</span>'}
                    </div>
                    ${c.syncTime !== undefined ? `<p class="text-[8px] text-emerald-300 mb-1">⏰ ${c.syncTime.toFixed(2)} ثانية</p>` : ''}
                    <p class="text-[9px] truncate opacity-50" dir="rtl">${c.ar}</p>
                    <button onclick="event.stopPropagation(); currentIdx=${i}; document.getElementById('singleAudioIn').click();" class="text-[8px] bg-zinc-800 py-1 w-full rounded mt-1 border border-zinc-700 hover:bg-emerald-900 text-white">تغيير الصوت 🔊</button>
                </div>
            `).join('');

            // تحديث العداد
            const synced = clips.filter(c => c.syncTime !== undefined).length;
            document.getElementById('syncCounter').innerText = `${synced}/${clips.length}`;
        }

        function selectClip(idx) {
            isEndPhase = false; currentIdx = idx; renderTimeline(); fade = 0;
            player.src = clips[idx].customAudio || clips[idx].audio;
            player.play().catch(() => { });
        }

        function handleSingleAudio(input) { if (input.files[0]) { clips[currentIdx].customAudio = URL.createObjectURL(input.files[0]); renderTimeline(); selectClip(currentIdx); } }

        function handleFullAudio(input) {
            if (input.files[0]) {
                // إيقاف أي صوت حالي
                player.pause();
                player.currentTime = 0;

                // تحميل الصوت الجديد
                player.src = URL.createObjectURL(input.files[0]);
                player.load();

                // تحديث حالة الصوت الكامل
                hasFullAudio = true;

                // تشغيل الصوت
                player.play().then(() => {
                    document.getElementById('audioStatus').innerText = "✅ تم رفع الصوت وجاري التشغيل";
                    document.getElementById('audioStatus').className = "text-[9px] text-center text-emerald-400 mb-3 font-bold";
                }).catch(err => {
                    console.error('خطأ في تشغيل الصوت:', err);
                    document.getElementById('audioStatus').innerText = "⚠️ تم الرفع - اضغط تشغيل يدوياً";
                    document.getElementById('audioStatus').className = "text-[9px] text-center text-yellow-400 mb-3 font-bold";
                });
            }
        }

        // دوال المزامنة
        function syncNext() {
            let nextIdx = clips.findIndex((c, i) => i >= 0 && c.syncTime === undefined);
            if (nextIdx !== -1) {
                clips[nextIdx].syncTime = player.currentTime;
                currentIdx = nextIdx;
                renderTimeline();

                // رسالة توضيحية
                const remaining = clips.filter(c => c.syncTime === undefined).length;
                if (remaining > 0) {
                    document.getElementById('exportBtn').innerText = `✅ تم تسجيل الآية ${nextIdx + 1} | متبقي: ${remaining} آية`;
                } else {
                    document.getElementById('exportBtn').innerText = "🎉 تم المزامنة! حدد النهاية ثم صدّر";
                }
            } else {
                document.getElementById('exportBtn').innerText = "✅ تم مزامنة جميع الآيات";
            }
        }

        function markEnd() {
            videoEndTime = player.currentTime;
            document.getElementById('exportBtn').innerText = "🚀 جاهز للتصدير (جودة HD)";
        }

        function loadMedia(input, type) {
            if (!input.files || !input.files[0]) return;
            const file = input.files[0];
            const url = URL.createObjectURL(file);
            const fileName = file.name;

            if (file.type.startsWith('video')) {
                const v = document.createElement('video');
                v.src = url;
                v.crossOrigin = "anonymous";
                v.muted = true;
                v.loop = (type === 'bg');
                v.play();
                if (type === 'bg') bgMedia = v;
                else if (type === 'end') {
                    endMedia = v;
                    // تحديث النص داخل الزر
                    document.getElementById('endBtnText').innerText = '✅ تم رفع الفيديو';
                    document.getElementById('endFileName').innerText = fileName;
                    document.getElementById('endFileName').classList.remove('hidden');
                }
            } else if (file.type.startsWith('image')) {
                const img = new Image();
                img.src = url;
                img.crossOrigin = "anonymous";
                img.onload = () => {
                    if (type === 'bg') bgMedia = img;
                    else if (type === 'logo') logoImg = img;
                    else if (type === 'end') {
                        endMedia = img;
                        // تحديث النص داخل الزر
                        document.getElementById('endBtnText').innerText = '✅ تم رفع الصورة';
                        document.getElementById('endFileName').innerText = fileName;
                        document.getElementById('endFileName').classList.remove('hidden');
                    }
                };
            }
        }

        function loadBgAudio(input) { bgMusic.src = URL.createObjectURL(input.files[0]); bgMusic.play(); }

        // معاينة فيديو/صورة الخاتمة
        function previewEndMedia() {
            if (!endMedia) {
                alert('⚠️ يجب رفع فيديو أو صورة خاتمة أولاً!');
                return;
            }

            // تفعيل وضع الخاتمة
            isEndPhase = true;
            player.pause();

            // إذا كان فيديو، شغله
            if (endMedia.tagName === 'VIDEO') {
                endMedia.currentTime = 0;
                endMedia.muted = false;
                endMedia.play();

                // إيقاف المعاينة عند انتهاء الفيديو
                endMedia.onended = () => {
                    isEndPhase = false;
                    endMedia.muted = true;
                    alert('✅ انتهت معاينة الخاتمة');
                };
            } else {
                // إذا كان صورة، اعرضها لمدة 5 ثواني
                alert('✅ سيتم عرض صورة الخاتمة لمدة 5 ثواني');
                setTimeout(() => {
                    isEndPhase = false;
                    alert('✅ انتهت معاينة الخاتمة');
                }, 5000);
            }
        }

        // تحميل خلفية جاهزة (تدرجات وأنماط)
        function loadPresetBackground(value) {
            if (!value) {
                bgMedia = null;
                return;
            }

            // إنشاء canvas للخلفية
            const bgCanvas = document.createElement('canvas');
            bgCanvas.width = 1280;
            bgCanvas.height = 720;
            const bgCtx = bgCanvas.getContext('2d');

            switch (value) {
                case 'gradient-green':
                    const gradGreen = bgCtx.createLinearGradient(0, 0, 0, 720);
                    gradGreen.addColorStop(0, '#064e3b');
                    gradGreen.addColorStop(0.5, '#065f46');
                    gradGreen.addColorStop(1, '#047857');
                    bgCtx.fillStyle = gradGreen;
                    bgCtx.fillRect(0, 0, 1280, 720);
                    break;

                case 'gradient-blue':
                    const gradBlue = bgCtx.createLinearGradient(0, 0, 0, 720);
                    gradBlue.addColorStop(0, '#1e3a8a');
                    gradBlue.addColorStop(0.5, '#1e40af');
                    gradBlue.addColorStop(1, '#2563eb');
                    bgCtx.fillStyle = gradBlue;
                    bgCtx.fillRect(0, 0, 1280, 720);
                    break;

                case 'gradient-gold':
                    const gradGold = bgCtx.createLinearGradient(0, 0, 0, 720);
                    gradGold.addColorStop(0, '#78350f');
                    gradGold.addColorStop(0.5, '#92400e');
                    gradGold.addColorStop(1, '#b45309');
                    bgCtx.fillStyle = gradGold;
                    bgCtx.fillRect(0, 0, 1280, 720);
                    break;

                case 'gradient-purple':
                    const gradPurple = bgCtx.createLinearGradient(0, 0, 0, 720);
                    gradPurple.addColorStop(0, '#581c87');
                    gradPurple.addColorStop(0.5, '#6b21a8');
                    gradPurple.addColorStop(1, '#7e22ce');
                    bgCtx.fillStyle = gradPurple;
                    bgCtx.fillRect(0, 0, 1280, 720);
                    break;

                case 'pattern-1':
                    // خلفية بنقوش هندسية
                    bgCtx.fillStyle = '#1a1a2e';
                    bgCtx.fillRect(0, 0, 1280, 720);
                    bgCtx.strokeStyle = 'rgba(16, 185, 129, 0.2)';
                    bgCtx.lineWidth = 2;
                    for (let i = 0; i < 1280; i += 40) {
                        for (let j = 0; j < 720; j += 40) {
                            bgCtx.beginPath();
                            bgCtx.arc(i, j, 15, 0, Math.PI * 2);
                            bgCtx.stroke();
                        }
                    }
                    break;

                case 'pattern-2':
                    // خلفية بخطوط متقاطعة
                    bgCtx.fillStyle = '#0f172a';
                    bgCtx.fillRect(0, 0, 1280, 720);
                    bgCtx.strokeStyle = 'rgba(59, 130, 246, 0.15)';
                    bgCtx.lineWidth = 1;
                    for (let i = 0; i < 1280; i += 30) {
                        bgCtx.beginPath();
                        bgCtx.moveTo(i, 0);
                        bgCtx.lineTo(i, 720);
                        bgCtx.stroke();
                    }
                    for (let j = 0; j < 720; j += 30) {
                        bgCtx.beginPath();
                        bgCtx.moveTo(0, j);
                        bgCtx.lineTo(1280, j);
                        bgCtx.stroke();
                    }
                    break;
            }

            // تحويل Canvas إلى صورة
            const img = new Image();
            img.onload = () => {
                bgMedia = img;
                console.log(`✅ تم تحميل الخلفية: ${value}`);
            };
            img.src = bgCanvas.toDataURL();
        }

        // متغيرات لجلب الخلفيات العشوائية
        let currentBgType = 'image';
        let currentRandomBgUrl = null;

        // جلب خلفية عشوائية من الإنترنت
        async function fetchRandomBackground(type) {
            currentBgType = type;
            const preview = document.getElementById('randomBgPreview');
            const img = document.getElementById('randomBgImg');

            preview.classList.remove('hidden');
            img.src = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="100" height="100"%3E%3Ctext x="50%25" y="50%25" text-anchor="middle" dy=".3em" fill="%23666"%3E⏳ جاري التحميل...%3C/text%3E%3C/svg%3E';

            try {
                let url;
                if (type === 'image') {
                    // استخدام Unsplash Source API (مجاني بدون مفتاح)
                    const topics = ['nature', 'landscape', 'sky', 'ocean', 'mountain', 'forest', 'sunset'];
                    const randomTopic = topics[Math.floor(Math.random() * topics.length)];
                    url = `https://source.unsplash.com/1920x1080/?${randomTopic}&${Date.now()}`;

                    // تحميل الصورة
                    const testImg = new Image();
                    testImg.crossOrigin = 'anonymous';
                    testImg.onload = () => {
                        currentRandomBgUrl = url;
                        img.src = url;
                        console.log('✅ تم جلب صورة عشوائية');
                    };
                    testImg.onerror = () => {
                        alert('❌ فشل تحميل الصورة. حاول مرة أخرى.');
                        preview.classList.add('hidden');
                    };
                    testImg.src = url;
                } else {
                    // للفيديو: استخدام Pexels API
                    if (PEXELS_API_KEY === 'YOUR_API_KEY_HERE') {
                        alert('⚠️ لاستخدام الفيديوهات، يجب إضافة مفتاح Pexels API\n\n1. سجل مجاناً على: pexels.com/api\n2. انسخ المفتاح\n3. ضعه في المتغير PEXELS_API_KEY');
                        preview.classList.add('hidden');
                        return;
                    }

                    const response = await fetch('https://api.pexels.com/videos/search?query=nature&per_page=15', {
                        headers: { 'Authorization': PEXELS_API_KEY }
                    });
                    const data = await response.json();

                    if (data.videos && data.videos.length > 0) {
                        const randomVideo = data.videos[Math.floor(Math.random() * data.videos.length)];
                        const videoFile = randomVideo.video_files.find(f => f.quality === 'hd' || f.quality === 'sd');

                        if (videoFile) {
                            currentRandomBgUrl = videoFile.link;
                            img.src = randomVideo.image; // عرض صورة مصغرة
                            console.log('✅ تم جلب فيديو عشوائي');
                        }
                    }
                }
            } catch (error) {
                console.error('خطأ في جلب الخلفية:', error);
                alert('❌ حدث خطأ في جلب الخلفية. تحقق من الاتصال بالإنترنت.');
                preview.classList.add('hidden');
            }
        }

        // استخدام الخلفية العشوائية المحملة
        function useRandomBackground() {
            if (!currentRandomBgUrl) {
                alert('⚠️ لا توجد خلفية محملة!');
                return;
            }

            if (currentBgType === 'image') {
                const img = new Image();
                img.crossOrigin = 'anonymous';
                img.onload = () => {
                    bgMedia = img;
                    alert('✅ تم تطبيق الخلفية!');
                    console.log('✅ تم استخدام الصورة العشوائية');
                };
                img.onerror = () => {
                    alert('❌ فشل تحميل الصورة. حاول مرة أخرى.');
                };
                img.src = currentRandomBgUrl;
            } else {
                const video = document.createElement('video');
                video.src = currentRandomBgUrl;
                video.crossOrigin = 'anonymous';
                video.muted = true;
                video.loop = true;
                video.play();
                bgMedia = video;
                alert('✅ تم تطبيق الفيديو!');
                console.log('✅ تم استخدام الفيديو العشوائي');
            }
        }

        // تحميل موسيقى جاهزة
        function loadPresetMusic(value) {
            // إزالة التحديد من جميع المربعات
            document.querySelectorAll('[id^="music-"]').forEach(el => {
                el.classList.remove('border-emerald-500');
                el.classList.add('border-transparent');
            });

            // تحديد المربع المختار
            if (value) {
                const selectedBox = document.getElementById(`music-${value}`);
                if (selectedBox) {
                    selectedBox.classList.remove('border-transparent');
                    selectedBox.classList.add('border-emerald-500');
                }
            } else {
                const noneBox = document.getElementById('music-none');
                if (noneBox) {
                    noneBox.classList.remove('border-transparent');
                    noneBox.classList.add('border-emerald-500');
                }
            }

            if (!value) {
                bgMusic.pause();
                bgMusic.src = '';
                return;
            }

            // استخدام ملفات صوتية من مصادر موثوقة
            const presetUrls = {
                'calm': 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3',
                'nature': 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3',
                'ambient': 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3'
            };

            if (presetUrls[value]) {
                bgMusic.pause();
                bgMusic.src = presetUrls[value];
                bgMusic.loop = true;
                bgMusic.volume = 0.2;

                bgMusic.load();

                bgMusic.play().then(() => {
                    console.log(`✅ تم تحميل الموسيقى: ${value}`);
                }).catch(err => {
                    console.error(`❌ فشل تحميل الموسيقى: ${value}`, err);
                    alert('⚠️ فشل تحميل الموسيقى. تأكد من اتصالك بالإنترنت أو ارفع ملف صوتي من جهازك.');
                });
            }
        }

        // اختيار خلفية شاشة الخاتمة
        let selectedOutroBg = 'gradient-green';
        function selectOutroBackground(value) {
            selectedOutroBg = value;

            // إزالة التحديد من جميع المربعات
            document.querySelectorAll('[id^="outro-bg-"]').forEach(el => {
                el.classList.remove('border-emerald-500', 'border-blue-500', 'border-purple-500', 'border-yellow-500', 'border-zinc-500');
                el.classList.add('border-transparent');
            });

            // تحديد المربع المختار
            const selectedBox = document.getElementById(`outro-bg-${value.replace('gradient-', '')}`);
            if (selectedBox) {
                selectedBox.classList.remove('border-transparent');
                if (value.includes('green')) selectedBox.classList.add('border-emerald-500');
                else if (value.includes('blue')) selectedBox.classList.add('border-blue-500');
                else if (value.includes('purple')) selectedBox.classList.add('border-purple-500');
                else if (value.includes('gold')) selectedBox.classList.add('border-yellow-500');
                else selectedBox.classList.add('border-zinc-500');
            }
        }

        // دالة لرسم الخلفية (مشتركة بين العرض الرئيسي والخاتمة)
        function drawBackground(ctx, W, H) {
            if (bgMedia) {
                ctx.globalAlpha = document.getElementById('bgOpacity').value;
                ctx.drawImage(bgMedia, 0, 0, W, H);
                ctx.globalAlpha = 1;
            }
        }

        // معاينة شاشة الخاتمة
        function previewOutroScreen() {
            const enableOutro = document.getElementById('enableOutro').checked;
            if (!enableOutro) {
                alert('⚠️ يجب تفعيل شاشة الخاتمة أولاً');
                return;
            }

            const duration = parseInt(document.getElementById('outroDuration').value) || 10;

            // تفعيل وضع شاشة الخاتمة
            isOutroPhase = true;
            outroAnimProgress = 0;

            // إيقاف أي صوت يعمل
            player.pause();

            // رسالة للمستخدم
            alert(`✅ سيتم عرض شاشة الخاتمة لمدة ${duration} ثانية`);

            // إيقاف المعاينة بعد المدة المحددة
            setTimeout(() => {
                isOutroPhase = false;
                outroAnimProgress = 0;
                alert('✅ انتهت معاينة شاشة الخاتمة');
            }, duration * 1000);
        }

        // رسم خلفية شاشة الخاتمة
        function drawOutroBackground(bgType) {
            const W = canvas.width, H = canvas.height;

            switch (bgType) {
                case 'gradient-green':
                    const gradGreen = ctx.createLinearGradient(0, 0, 0, H);
                    gradGreen.addColorStop(0, '#064e3b');
                    gradGreen.addColorStop(0.5, '#065f46');
                    gradGreen.addColorStop(1, '#047857');
                    ctx.fillStyle = gradGreen;
                    ctx.fillRect(0, 0, W, H);
                    break;
                case 'gradient-blue':
                    const gradBlue = ctx.createLinearGradient(0, 0, 0, H);
                    gradBlue.addColorStop(0, '#1e3a8a');
                    gradBlue.addColorStop(0.5, '#1e40af');
                    gradBlue.addColorStop(1, '#2563eb');
                    ctx.fillStyle = gradBlue;
                    ctx.fillRect(0, 0, W, H);
                    break;
                case 'gradient-purple':
                    const gradPurple = ctx.createLinearGradient(0, 0, 0, H);
                    gradPurple.addColorStop(0, '#581c87');
                    gradPurple.addColorStop(0.5, '#6b21a8');
                    gradPurple.addColorStop(1, '#7e22ce');
                    ctx.fillStyle = gradPurple;
                    ctx.fillRect(0, 0, W, H);
                    break;
                case 'gradient-gold':
                    const gradGold = ctx.createLinearGradient(0, 0, 0, H);
                    gradGold.addColorStop(0, '#78350f');
                    gradGold.addColorStop(0.5, '#92400e');
                    gradGold.addColorStop(1, '#b45309');
                    ctx.fillStyle = gradGold;
                    ctx.fillRect(0, 0, W, H);
                    break;
                case 'dark':
                    ctx.fillStyle = '#000';
                    ctx.fillRect(0, 0, W, H);
                    break;
            }
        }

        // رسم خلفية مخصصة لشاشة الخاتمة
        function drawOutroCustomBackground(ctx, W, H, bgType) {
            switch (bgType) {
                case 'gradient-green':
                    const gradGreen = ctx.createLinearGradient(0, 0, 0, H);
                    gradGreen.addColorStop(0, '#064e3b');
                    gradGreen.addColorStop(0.5, '#065f46');
                    gradGreen.addColorStop(1, '#047857');
                    ctx.fillStyle = gradGreen;
                    ctx.fillRect(0, 0, W, H);
                    break;
                case 'gradient-blue':
                    const gradBlue = ctx.createLinearGradient(0, 0, 0, H);
                    gradBlue.addColorStop(0, '#1e3a8a');
                    gradBlue.addColorStop(0.5, '#1e40af');
                    gradBlue.addColorStop(1, '#2563eb');
                    ctx.fillStyle = gradBlue;
                    ctx.fillRect(0, 0, W, H);
                    break;
                case 'gradient-purple':
                    const gradPurple = ctx.createLinearGradient(0, 0, 0, H);
                    gradPurple.addColorStop(0, '#581c87');
                    gradPurple.addColorStop(0.5, '#6b21a8');
                    gradPurple.addColorStop(1, '#7e22ce');
                    ctx.fillStyle = gradPurple;
                    ctx.fillRect(0, 0, W, H);
                    break;
                case 'gradient-gold':
                    const gradGold = ctx.createLinearGradient(0, 0, 0, H);
                    gradGold.addColorStop(0, '#78350f');
                    gradGold.addColorStop(0.5, '#92400e');
                    gradGold.addColorStop(1, '#b45309');
                    ctx.fillStyle = gradGold;
                    ctx.fillRect(0, 0, W, H);
                    break;
                case 'dark':
                    ctx.fillStyle = '#000';
                    ctx.fillRect(0, 0, W, H);
                    break;
            }
        }

        function draw() {
            const W = canvas.width, H = canvas.height;
            bgMusic.volume = document.getElementById('bgVol').value;

            // تحديث التأثيرات من الـ UI
            transitionType = document.getElementById('transitionType').value;
            transitionSpeed = parseFloat(document.getElementById('transitionSpeed').value);
            customTitle = document.getElementById('customTitle').value;
            channelName = document.getElementById('channelName').value;
            showArabicText = document.getElementById('showArabicText').checked;
            showMeaning = document.getElementById('showMeaning').checked;
            showTranslation = document.getElementById('showTranslation').checked;
            showAyahNumber = document.getElementById('showAyahNumber').checked;
            showReciterName = document.getElementById('showReciterName').checked;
            showDate = document.getElementById('showDate').checked;

            // تحديث تقدم التأثير
            if (fade < 1) {
                fade += 0.08;
                transitionProgress = fade;
            }

            // تحديث الآية الحالية بناءً على وقت التشغيل
            if (player && !player.paused && clips.length > 0) {
                const currentTime = player.currentTime;
                let newIdx = -1;

                for (let i = clips.length - 1; i >= 0; i--) {
                    if (clips[i].syncTime !== undefined && currentTime >= clips[i].syncTime) {
                        newIdx = i;
                        break;
                    }
                }

                if (newIdx !== -1 && newIdx !== currentIdx) {
                    currentIdx = newIdx;
                    fade = 0;
                    transitionProgress = 0;
                }
            }

            ctx.filter = `brightness(${document.getElementById('fBright').value}%) contrast(${document.getElementById('fContrast').value}%) hue-rotate(${document.getElementById('fHue').value}deg)`;
            ctx.fillStyle = "#000";
            ctx.fillRect(0, 0, W, H);

            if (isOutroPhase) {
                // عرض شاشة الخاتمة النصية
                drawOutroScreen(ctx, W, H);
            } else if (isEndPhase && endMedia) {
                ctx.drawImage(endMedia, 0, 0, W, H);
            } else {
                // رسم الخلفية
                if (bgMedia) {
                    ctx.globalAlpha = document.getElementById('bgOpacity').value;
                    ctx.drawImage(bgMedia, 0, 0, W, H);
                    ctx.globalAlpha = 1;
                }

                ctx.filter = "none";

                // رسم الشعار
                if (logoImg) {
                    ctx.globalAlpha = document.getElementById('logoOpacity').value;
                    ctx.drawImage(logoImg, W - 140, 40, 100, 100);
                    ctx.globalAlpha = 1;
                }

                // رسم الآية مع التأثيرات
                if (currentIdx !== -1 && clips[currentIdx]) {
                    ctx.save();

                    // تطبيق التأثير الانتقالي
                    if (transitionType !== 'none') {
                        applyTransition(ctx, W, H, transitionProgress);
                    }

                    ctx.globalAlpha = fade;

                    // حساب المواقع الديناميكية بناءً على العناصر المرئية
                    // استخدام أصغر قيمة بين العرض والارتفاع للحصول على مسافات متناسقة
                    const minDimension = Math.min(W, H);
                    let baseY = H / 4.5; // بداية أعلى

                    // النص العربي
                    if (showArabicText) {
                        ctx.fillStyle = "white";
                        ctx.textAlign = "center";
                        ctx.font = `bold ${minDimension / 14}px 'Amiri'`;
                        const arabicLineHeight = minDimension / 11;
                        const arabicLines = wrapText(ctx, clips[currentIdx].ar, W / 2, baseY, W * 0.85, arabicLineHeight);
                        baseY += arabicLines * arabicLineHeight + (H * 0.05); // مسافة بعد النص العربي
                    }

                    // المعنى (التفسير)
                    if (showMeaning) {
                        ctx.fillStyle = "#FFD700";
                        ctx.font = `bold ${minDimension / 28}px 'Tajawal'`;
                        const meaningLineHeight = minDimension / 22;
                        const meaningLines = wrapText(ctx, "المعنى: " + clips[currentIdx].meaning, W / 2, baseY, W * 0.85, meaningLineHeight);
                        baseY += meaningLines * meaningLineHeight + (H * 0.04); // مسافة بعد التفسير
                    }

                    // الترجمة
                    if (showTranslation) {
                        ctx.fillStyle = "rgba(255,255,255,0.85)";
                        ctx.font = `${minDimension / 32}px 'Tajawal'`;
                        const transLineHeight = minDimension / 28;
                        wrapText(ctx, clips[currentIdx].trans, W / 2, baseY, W * 0.85, transLineHeight);
                    }

                    ctx.restore();
                }

                // رسم النصوص المخصصة
                drawCustomTexts(ctx, W, H);
            }

            requestAnimationFrame(draw);
        }

        // دالة تطبيق التأثيرات الانتقالية
        function applyTransition(ctx, W, H, progress) {
            const easedProgress = easeInOutCubic(progress);

            switch (transitionType) {
                case 'fade':
                    // التلاشي - يتم التحكم به عبر globalAlpha في الكود الرئيسي
                    break;

                case 'slide-right':
                    // انزلاق من اليمين
                    const slideX = W * (1 - easedProgress);
                    ctx.translate(slideX, 0);
                    break;

                case 'slide-left':
                    // انزلاق من اليسار
                    const slideXLeft = -W * (1 - easedProgress);
                    ctx.translate(slideXLeft, 0);
                    break;

                case 'zoom-in':
                    // تكبير
                    const scale = 0.5 + (easedProgress * 0.5);
                    ctx.translate(W / 2, H / 2);
                    ctx.scale(scale, scale);
                    ctx.translate(-W / 2, -H / 2);
                    break;

                case 'zoom-out':
                    // تصغير
                    const scaleOut = 1.5 - (easedProgress * 0.5);
                    ctx.translate(W / 2, H / 2);
                    ctx.scale(scaleOut, scaleOut);
                    ctx.translate(-W / 2, -H / 2);
                    break;
            }
        }

        // دالة الحركة السلسة
        function easeInOutCubic(t) {
            return t < 0.5 ? 4 * t * t * t : 1 - Math.pow(-2 * t + 2, 3) / 2;
        }

        // دالة رسم النصوص المخصصة
        function drawCustomTexts(ctx, W, H) {
            ctx.save();
            ctx.globalAlpha = 0.9;

            // استخدام أصغر قيمة بين العرض والارتفاع للحصول على أحجام خطوط متناسقة
            const minDimension = Math.min(W, H);

            // عنوان الفيديو في الأعلى
            if (customTitle) {
                ctx.fillStyle = "rgba(16, 185, 129, 0.9)";
                ctx.font = `bold ${minDimension / 25}px 'Tajawal'`;
                ctx.textAlign = "center";
                ctx.fillText(customTitle, W / 2, 50);
            }

            // اسم القناة في الأسفل
            if (channelName) {
                ctx.fillStyle = "rgba(255, 255, 255, 0.8)";
                ctx.font = `${minDimension / 30}px 'Tajawal'`;
                ctx.textAlign = "center";
                ctx.fillText(channelName, W / 2, H - 40);
            }

            // رقم الآية واسم القارئ في نفس السطر
            const bottomY = H - 40;

            // رقم الآية (يمين)
            if (showAyahNumber && currentIdx !== -1) {
                ctx.fillStyle = "rgba(255, 215, 0, 0.9)";
                ctx.font = `bold ${minDimension / 35}px 'Tajawal'`;
                ctx.textAlign = "right";
                ctx.shadowColor = 'rgba(0, 0, 0, 0.5)';
                ctx.shadowBlur = 5;
                ctx.fillText(`الآية ${currentIdx + 1}`, W - 30, bottomY);
                ctx.shadowBlur = 0;
            }

            // اسم القارئ (يسار)
            if (showReciterName && currentReciterName) {
                ctx.fillStyle = "rgba(16, 185, 129, 0.9)";
                ctx.font = `bold ${minDimension / 40}px 'Tajawal'`;
                ctx.textAlign = "left";
                ctx.shadowColor = 'rgba(0, 0, 0, 0.5)';
                ctx.shadowBlur = 5;
                ctx.fillText(`🎙️ ${currentReciterName}`, 30, bottomY);
                ctx.shadowBlur = 0;
            }

            // التاريخ (وسط أسفل)
            if (showDate) {
                const today = new Date();
                const dateStr = today.toLocaleDateString('ar-EG', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                ctx.fillStyle = "rgba(255, 255, 255, 0.6)";
                ctx.font = `${minDimension / 45}px 'Tajawal'`;
                ctx.textAlign = "center";
                ctx.shadowColor = 'rgba(0, 0, 0, 0.5)';
                ctx.shadowBlur = 5;
                ctx.fillText(dateStr, W / 2, bottomY);
                ctx.shadowBlur = 0;
            }

            ctx.restore();
        }

        // دالة رسم شاشة الخاتمة النصية
        function drawOutroScreen(ctx, W, H) {
            // قراءة النصوص من textarea
            let outroMainText = document.getElementById('outroMainText').value.trim();
            let outroSubText = document.getElementById('outroSubText').value.trim();
            let outroExtraText = document.getElementById('outroExtraText').value.trim();

            // استخدام نصوص افتراضية إذا كانت فارغة
            if (!outroMainText) outroMainText = 'شكراً للمشاهدة\nنسأل الله القبول';
            if (!outroSubText) outroSubText = 'لا تنسى الاشتراك في القناة\nوتفعيل الجرس 🔔';
            if (!outroExtraText) outroExtraText = 'جزاكم الله خيراً\nونفع بكم الإسلام والمسلمين';

            // التحقق من استخدام نفس خلفية العرض
            const useSameBackground = document.getElementById('useSameBackground').checked;

            if (useSameBackground) {
                drawBackground(ctx, W, H);
            } else {
                const bgType = selectedOutroBg;
                drawOutroCustomBackground(ctx, W, H, bgType);
            }

            // طبقة تعتيم أنيقة
            ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
            ctx.fillRect(0, 0, W, H);

            // تهيئة النجوم إذا لم تكن موجودة
            if (outroStars.length === 0) {
                initOutroStars(W, H);
            }

            // رسم النجوم المتلألئة
            outroStars.forEach(star => {
                star.x += star.speedX;
                star.y += star.speedY;
                star.twinkle += 0.08;

                if (star.x < 0) star.x = W;
                if (star.x > W) star.x = 0;
                if (star.y < 0) star.y = H;
                if (star.y > H) star.y = 0;

                const twinkleOpacity = star.opacity * (0.3 + Math.sin(star.twinkle) * 0.7);

                // نجمة مع هالة
                ctx.shadowBlur = 8;
                ctx.shadowColor = `rgba(255, 255, 255, ${twinkleOpacity})`;
                ctx.fillStyle = `rgba(255, 255, 255, ${twinkleOpacity})`;
                ctx.beginPath();
                ctx.arc(star.x, star.y, star.size, 0, Math.PI * 2);
                ctx.fill();
                ctx.shadowBlur = 0;
            });

            // تحديث تقدم الأنيميشن (أبطأ للآلة الكاتبة)
            if (outroAnimProgress < 1) {
                outroAnimProgress += 0.015; // أبطأ من قبل
            }

            ctx.save();

            // استخدام أصغر قيمة للخطوط
            const minDimension = Math.min(W, H);

            // حساب عدد الأحرف المرئية بناءً على التقدم
            const mainLines = outroMainText.split('\n');
            const subLines = outroSubText.split('\n');
            const extraLines = outroExtraText.split('\n');

            const totalMainChars = mainLines.join('').length;
            const totalSubChars = subLines.join('').length;
            const totalExtraChars = extraLines.join('').length;
            const totalChars = totalMainChars + totalSubChars + totalExtraChars;

            const visibleChars = Math.floor(outroAnimProgress * totalChars);

            let charCount = 0;
            let currentY = H / 2 - 150;

            // رسم النص الرئيسي بتأثير الآلة الكاتبة
            ctx.shadowBlur = 30;
            ctx.shadowColor = 'rgba(16, 185, 129, 0.8)';
            ctx.fillStyle = '#ffffff';
            ctx.font = `bold ${minDimension / 11}px 'Amiri'`;
            ctx.textAlign = 'center';

            mainLines.forEach((line, lineIndex) => {
                let visibleText = '';
                for (let i = 0; i < line.length; i++) {
                    if (charCount < visibleChars) {
                        visibleText += line[i];
                        charCount++;
                    }
                }
                if (visibleText) {
                    ctx.fillText(visibleText, W / 2, currentY);

                    // رسم المؤشر الوامض (cursor) في نهاية السطر الحالي
                    if (charCount === visibleChars && lineIndex === mainLines.length - 1) {
                        const cursorBlink = Math.sin(Date.now() / 200) > 0;
                        if (cursorBlink) {
                            const textWidth = ctx.measureText(visibleText).width;
                            ctx.fillRect(W / 2 + textWidth / 2 + 5, currentY - minDimension / 14, 3, minDimension / 11);
                        }
                    }
                }
                currentY += (minDimension / 11) * 1.4;
            });

            // خط فاصل (يظهر بعد النص الرئيسي)
            if (charCount >= totalMainChars) {
                currentY += 20;
                const lineProgress = Math.min((charCount - totalMainChars) / 5, 1);
                const lineWidth = W * 0.25 * lineProgress;

                const lineGrad = ctx.createLinearGradient(W / 2 - lineWidth / 2, currentY, W / 2 + lineWidth / 2, currentY);
                lineGrad.addColorStop(0, 'rgba(16, 185, 129, 0)');
                lineGrad.addColorStop(0.5, 'rgba(16, 185, 129, 0.7)');
                lineGrad.addColorStop(1, 'rgba(16, 185, 129, 0)');

                ctx.strokeStyle = lineGrad;
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(W / 2 - lineWidth / 2, currentY);
                ctx.lineTo(W / 2 + lineWidth / 2, currentY);
                ctx.stroke();

                currentY += 40;
            }

            // رسم النص الثانوي بتأثير الآلة الكاتبة
            if (charCount >= totalMainChars) {
                ctx.shadowBlur = 20;
                ctx.shadowColor = 'rgba(16, 185, 129, 0.6)';
                ctx.fillStyle = '#10b981';
                ctx.font = `bold ${minDimension / 18}px 'Tajawal'`;

                subLines.forEach((line, lineIndex) => {
                    let visibleText = '';
                    for (let i = 0; i < line.length; i++) {
                        if (charCount < visibleChars) {
                            visibleText += line[i];
                            charCount++;
                        }
                    }
                    if (visibleText) {
                        ctx.fillText(visibleText, W / 2, currentY);

                        // رسم المؤشر الوامض
                        if (charCount === visibleChars && lineIndex === subLines.length - 1) {
                            const cursorBlink = Math.sin(Date.now() / 200) > 0;
                            if (cursorBlink) {
                                const textWidth = ctx.measureText(visibleText).width;
                                ctx.fillRect(W / 2 + textWidth / 2 + 5, currentY - minDimension / 20, 3, minDimension / 18);
                            }
                        }
                    }
                    currentY += (minDimension / 18) * 1.5;
                });

                currentY += 30;
            }

            // رسم النص الإضافي بتأثير الآلة الكاتبة
            if (charCount >= totalMainChars + totalSubChars) {
                ctx.shadowBlur = 15;
                ctx.shadowColor = 'rgba(255, 215, 0, 0.7)';
                ctx.fillStyle = '#ffd700';
                ctx.font = `${minDimension / 22}px 'Tajawal'`;

                extraLines.forEach((line, lineIndex) => {
                    let visibleText = '';
                    for (let i = 0; i < line.length; i++) {
                        if (charCount < visibleChars) {
                            visibleText += line[i];
                            charCount++;
                        }
                    }
                    if (visibleText) {
                        ctx.fillText(visibleText, W / 2, currentY);

                        // رسم المؤشر الوامض
                        if (charCount === visibleChars && lineIndex === extraLines.length - 1) {
                            const cursorBlink = Math.sin(Date.now() / 200) > 0;
                            if (cursorBlink) {
                                const textWidth = ctx.measureText(visibleText).width;
                                ctx.fillRect(W / 2 + textWidth / 2 + 5, currentY - minDimension / 24, 3, minDimension / 22);
                            }
                        }
                    }
                    currentY += (minDimension / 22) * 1.6;
                });
            }

            ctx.restore();
        }

        // دالة رسم النص بتأثير الكتابة اليدوية
        function drawHandwrittenText(ctx, text, x, y, font, color, progress, maxWidth) {
            ctx.save();
            ctx.font = font;
            ctx.textAlign = 'center';
            ctx.fillStyle = color;

            // تقسيم النص إلى أسطر
            const lines = text.split('\n');
            const lineHeight = parseInt(font) * 1.5;

            // حساب إجمالي الأحرف
            const totalChars = text.replace(/\n/g, '').length;
            const visibleChars = Math.floor(totalChars * progress);

            let charCount = 0;
            let lastVisibleLine = -1;
            let lastLineVisibleChars = 0;

            // تحديد السطر الأخير المرئي وعدد أحرفه
            for (let i = 0; i < lines.length; i++) {
                if (charCount + lines[i].length <= visibleChars) {
                    lastVisibleLine = i;
                    lastLineVisibleChars = lines[i].length;
                    charCount += lines[i].length;
                } else {
                    lastVisibleLine = i;
                    lastLineVisibleChars = visibleChars - charCount;
                    break;
                }
            }

            // رسم كل سطر
            let currentY = y - ((lines.length - 1) * lineHeight / 2);
            for (let i = 0; i <= lastVisibleLine && i < lines.length; i++) {
                const lineText = i === lastVisibleLine
                    ? lines[i].substring(0, lastLineVisibleChars)
                    : lines[i];

                if (lineText.length > 0) {
                    // تأثير الظل للنص - أقوى وأوضح
                    ctx.shadowColor = 'rgba(0, 0, 0, 0.8)';
                    ctx.shadowBlur = 15;
                    ctx.shadowOffsetX = 3;
                    ctx.shadowOffsetY = 3;

                    // رسم النص المرئي بوضوح كامل
                    ctx.globalAlpha = 1;

                    // رسم النص مرتين لزيادة الوضوح
                    ctx.fillText(lineText, x, currentY);
                    ctx.shadowBlur = 0;
                    ctx.fillText(lineText, x, currentY);
                }

                currentY += lineHeight;
            }

            // إضافة "قلم" متحرك في نهاية النص (cursor effect)
            if (progress < 1 && lastVisibleLine >= 0 && lastLineVisibleChars > 0) {
                const lastLine = lines[lastVisibleLine].substring(0, lastLineVisibleChars);
                const lastLineY = y - ((lines.length - 1) * lineHeight / 2) + (lastVisibleLine * lineHeight);

                // حساب موقع نهاية النص
                const textMetrics = ctx.measureText(lastLine);
                const textWidth = textMetrics.width;

                // رسم خط وامض يحاكي القلم - أكثر وضوحاً
                const cursorAlpha = (Math.sin(Date.now() / 100) + 1) / 2; // وميض
                ctx.globalAlpha = cursorAlpha;
                ctx.strokeStyle = color;
                ctx.lineWidth = 4;
                ctx.lineCap = 'round';

                // خط عمودي صغير
                const cursorX = x + textWidth / 2 + 8;
                ctx.beginPath();
                ctx.moveTo(cursorX, lastLineY - 15);
                ctx.lineTo(cursorX, lastLineY + 8);
                ctx.stroke();

                // نقطة في نهاية القلم - أكبر وأوضح
                ctx.fillStyle = color;
                ctx.globalAlpha = cursorAlpha;
                ctx.beginPath();
                ctx.arc(cursorX, lastLineY + 8, 5, 0, Math.PI * 2);
                ctx.fill();
            }

            ctx.restore();
        }

        function wrapText(c, t, x, y, mw, lh) {
            let words = t.split(' '), line = '';
            let lineCount = 0;
            for (let n = 0; n < words.length; n++) {
                let test = line + words[n] + ' ';
                if (c.measureText(test).width > mw && n > 0) {
                    c.fillText(line, x, y);
                    line = words[n] + ' ';
                    y += lh;
                    lineCount++;
                }
                else line = test;
            }
            c.fillText(line, x, y);
            lineCount++;
            return lineCount; // إرجاع عدد الأسطر
        }

        // دالة معاينة الفيديو (بدون تسجيل)
        async function previewVideo() {
            // التحقق من وجود آيات
            if (clips.length === 0) {
                alert("⚠️ يجب جلب الآيات أولاً!");
                return;
            }

            // إعادة تعيين المتغيرات
            resetPlayback();

            const btn = document.getElementById('previewBtn');
            const originalText = btn.innerText;
            btn.disabled = true;
            btn.innerText = "⏳ جاري المعاينة...";

            try {
                // التحقق من وجود صوت كامل مرفوع
                if (hasFullAudio) {
                    // معاينة مع الصوت الكامل
                    const lastClipIndex = clips.length - 1;
                    const hasSync = clips.some(c => c.syncTime !== undefined);

                    if (hasSync && clips[lastClipIndex].syncTime !== undefined) {
                        const lastAyahStartTime = clips[lastClipIndex].syncTime;
                        let estimatedDuration = 5;

                        if (lastClipIndex > 0 && clips[lastClipIndex - 1].syncTime !== undefined) {
                            let totalDuration = 0;
                            let count = 0;
                            for (let i = 1; i < clips.length; i++) {
                                if (clips[i].syncTime !== undefined && clips[i - 1].syncTime !== undefined) {
                                    totalDuration += clips[i].syncTime - clips[i - 1].syncTime;
                                    count++;
                                }
                            }
                            if (count > 0) {
                                estimatedDuration = totalDuration / count;
                            }
                        }

                        const endTime = lastAyahStartTime + estimatedDuration;

                        // تعيين الآية الأولى وإظهارها
                        currentIdx = 0;
                        fade = 1;

                        player.currentTime = 0;
                        await player.play();

                        // إيقاف عند النهاية
                        const checkTime = setInterval(() => {
                            if (player.currentTime >= endTime || player.ended) {
                                clearInterval(checkTime);
                                player.pause();

                                // معاينة شاشة الخاتمة إذا مفعلة
                                const enableOutro = document.getElementById('enableOutro').checked;
                                if (enableOutro) {
                                    isOutroPhase = true;
                                    outroAnimProgress = 0;
                                    const outroDuration = parseInt(document.getElementById('outroDuration').value) || 10;
                                    setTimeout(() => {
                                        isOutroPhase = false;

                                        // معاينة فيديو/صورة الخاتمة إذا موجودة
                                        if (endMedia) {
                                            isEndPhase = true;
                                            btn.innerText = "⏳ معاينة فيديو الخاتمة...";

                                            if (endMedia.tagName === 'VIDEO') {
                                                endMedia.currentTime = 0;
                                                endMedia.muted = false;
                                                endMedia.play();
                                                endMedia.onended = () => {
                                                    isEndPhase = false;
                                                    endMedia.muted = true;
                                                    btn.disabled = false;
                                                    btn.innerText = originalText;
                                                    alert("✅ انتهت المعاينة!");
                                                };
                                            } else {
                                                // صورة - عرض لمدة 5 ثواني
                                                setTimeout(() => {
                                                    isEndPhase = false;
                                                    btn.disabled = false;
                                                    btn.innerText = originalText;
                                                    alert("✅ انتهت المعاينة!");
                                                }, 5000);
                                            }
                                        } else {
                                            btn.disabled = false;
                                            btn.innerText = originalText;
                                            alert("✅ انتهت المعاينة!");
                                        }
                                    }, outroDuration * 1000);
                                } else {
                                    // إذا لم تكن شاشة الخاتمة مفعلة، تحقق من فيديو/صورة الخاتمة
                                    if (endMedia) {
                                        isEndPhase = true;
                                        btn.innerText = "⏳ معاينة فيديو الخاتمة...";

                                        if (endMedia.tagName === 'VIDEO') {
                                            endMedia.currentTime = 0;
                                            endMedia.muted = false;
                                            endMedia.play();
                                            endMedia.onended = () => {
                                                isEndPhase = false;
                                                endMedia.muted = true;
                                                btn.disabled = false;
                                                btn.innerText = originalText;
                                                alert("✅ انتهت المعاينة!");
                                            };
                                        } else {
                                            // صورة - عرض لمدة 5 ثواني
                                            setTimeout(() => {
                                                isEndPhase = false;
                                                btn.disabled = false;
                                                btn.innerText = originalText;
                                                alert("✅ انتهت المعاينة!");
                                            }, 5000);
                                        }
                                    } else {
                                        btn.disabled = false;
                                        btn.innerText = originalText;
                                        alert("✅ انتهت المعاينة!");
                                    }
                                }
                            }
                        }, 100);
                    } else {
                        alert("⚠️ يجب تحديد نقاط المزامنة أولاً!");
                        btn.disabled = false;
                        btn.innerText = originalText;
                    }
                } else {
                    // معاينة مع تشغيل كل آية
                    for (let i = 0; i < clips.length; i++) {
                        btn.innerText = `⏳ معاينة... (${i + 1}/${clips.length})`;
                        currentIdx = i; // تعيين الآية الحالية
                        fade = 1; // إظهار الآية مباشرة
                        selectClip(i);
                        await new Promise(r => {
                            player.onended = r;
                            setTimeout(r, 30000);
                        });
                        await new Promise(r => setTimeout(r, 500));
                    }

                    // معاينة شاشة الخاتمة
                    const enableOutro = document.getElementById('enableOutro').checked;
                    if (enableOutro) {
                        isOutroPhase = true;
                        outroAnimProgress = 0;
                        btn.innerText = "⏳ معاينة الخاتمة النصية...";
                        const outroDuration = parseInt(document.getElementById('outroDuration').value) || 10;
                        await new Promise(r => setTimeout(r, outroDuration * 1000));
                        isOutroPhase = false;
                    }

                    // معاينة فيديو/صورة الخاتمة إذا موجودة
                    if (endMedia) {
                        isEndPhase = true;
                        btn.innerText = "⏳ معاينة فيديو الخاتمة...";

                        if (endMedia.tagName === 'VIDEO') {
                            endMedia.currentTime = 0;
                            endMedia.muted = false;
                            endMedia.play();
                            await new Promise(resolve => {
                                endMedia.onended = resolve;
                            });
                            endMedia.muted = true;
                            isEndPhase = false;
                        } else {
                            // صورة - عرض لمدة 5 ثواني
                            await new Promise(r => setTimeout(r, 5000));
                            isEndPhase = false;
                        }
                    }

                    btn.disabled = false;
                    btn.innerText = originalText;
                    alert("✅ انتهت المعاينة!");
                }
            } catch (error) {
                console.error("خطأ في المعاينة:", error);
                btn.disabled = false;
                btn.innerText = originalText;
                alert("❌ حدث خطأ في المعاينة");
            }
        }

        async function exportVideo() {
            // التحقق من وجود آيات
            if (clips.length === 0) {
                alert("⚠️ يجب جلب الآيات أولاً!");
                return;
            }

            // إعادة تعيين المتغيرات
            resetPlayback();

            const btn = document.getElementById('exportBtn');
            btn.disabled = true;
            btn.innerText = "🔴 جاري التصدير...";

            if (!audioCtx) {
                audioCtx = new AudioContext();
                dest = audioCtx.createMediaStreamDestination();
                s1 = audioCtx.createMediaElementSource(player);
                s2 = audioCtx.createMediaElementSource(bgMusic);
                s1.connect(dest); s1.connect(audioCtx.destination);
                s2.connect(dest); s2.connect(audioCtx.destination);
            }

            const stream = canvas.captureStream(60);
            const recorder = new RecordRTC(new MediaStream([...stream.getTracks(), ...dest.stream.getTracks()]), {
                type: 'video',
                mimeType: 'video/webm;codecs=vp9',
                videoBitsPerSecond: 15000000
            });

            recorder.startRecording();

            // التحقق من وجود صوت كامل مرفوع
            if (hasFullAudio) {
                // استخدام الصوت الكامل المرفوع
                console.log("🎬 بدء التصدير - استخدام الصوت الكامل المرفوع");

                // التحقق من وجود مزامنة للآيات
                const lastClipIndex = clips.length - 1;
                const hasSync = clips.some(c => c.syncTime !== undefined);

                if (hasSync && clips[lastClipIndex].syncTime !== undefined) {
                    // إذا كان هناك مزامنة، نحسب وقت النهاية
                    const lastAyahStartTime = clips[lastClipIndex].syncTime;

                    // تقدير مدة الآية الأخيرة (5 ثواني كحد أقصى أو حتى نهاية الصوت)
                    let estimatedDuration = 5;
                    if (lastClipIndex > 0 && clips[lastClipIndex - 1].syncTime !== undefined) {
                        // حساب متوسط مدة الآيات السابقة
                        let totalDuration = 0;
                        let count = 0;
                        for (let i = 1; i < clips.length; i++) {
                            if (clips[i].syncTime !== undefined && clips[i - 1].syncTime !== undefined) {
                                totalDuration += clips[i].syncTime - clips[i - 1].syncTime;
                                count++;
                            }
                        }
                        if (count > 0) {
                            estimatedDuration = totalDuration / count;
                        }
                    }

                    const endTime = lastAyahStartTime + estimatedDuration;

                    btn.innerText = `🔴 جاري التصدير... (${clips.length} آيات)`;

                    // تعيين الآية الأولى وإظهارها
                    currentIdx = 0;
                    fade = 1;

                    // تشغيل الصوت من البداية
                    player.currentTime = 0;
                    await player.play();

                    // مراقبة الوقت وإيقاف الصوت عند النهاية المحددة
                    await new Promise(resolve => {
                        const checkTime = setInterval(() => {
                            if (player.currentTime >= endTime || player.ended) {
                                clearInterval(checkTime);
                                player.pause();
                                resolve();
                            }
                        }, 100);

                        // timeout احتياطي
                        setTimeout(() => {
                            clearInterval(checkTime);
                            player.pause();
                            resolve();
                        }, (endTime + 2) * 1000);
                    });

                    console.log(`✅ انتهى التصدير عند ${endTime.toFixed(2)} ثانية`);
                } else {
                    // إذا لم يكن هناك مزامنة، نبلغ المستخدم
                    alert("⚠️ يجب تحديد نقاط المزامنة أولاً!\n\n1. شغّل الصوت\n2. اضغط 'الآية التالية' عند بداية كل آية\n3. اضغط 'تحديد النهاية' عند نهاية آخر آية");
                    btn.disabled = false;
                    btn.innerText = "🚀 تصدير الفيديو (جودة HD)";
                    return;
                }
            } else {
                // استخدام الطريقة التلقائية (تشغيل كل آية لوحدها)
                console.log("🎬 بدء التصدير - تشغيل كل آية لوحدها");
                for (let i = 0; i < clips.length; i++) {
                    console.log(`📖 تشغيل الآية ${i + 1}/${clips.length}`);
                    btn.innerText = `🔴 جاري التصدير... (${i + 1}/${clips.length})`;
                    currentIdx = i; // تعيين الآية الحالية
                    fade = 1; // إظهار الآية مباشرة
                    selectClip(i);
                    await new Promise(r => {
                        player.onended = r;
                        setTimeout(r, 30000); // timeout 30 ثانية max
                    });
                    await new Promise(r => setTimeout(r, 500));
                }
                console.log("✅ انتهى تشغيل جميع الآيات");
            }

            // شاشة الخاتمة النصية
            const enableOutro = document.getElementById('enableOutro').checked;
            if (enableOutro) {
                isOutroPhase = true;
                outroAnimProgress = 0; // إعادة تعيين التقدم
                btn.innerText = "⏳ تسجيل شاشة الخاتمة النصية...";
                const outroDuration = parseInt(document.getElementById('outroDuration').value) || 10;

                // انتظار المدة المحددة + ثانية إضافية للتأكد
                await new Promise(r => setTimeout(r, (outroDuration + 1) * 1000));

                isOutroPhase = false;
            }

            // فيديو/صورة الخاتمة
            if (endMedia) {
                isEndPhase = true;
                btn.innerText = "⏳ تسجيل فيديو الخاتمة...";
                if (endMedia.tagName === 'VIDEO') {
                    if (!sEnd) {
                        sEnd = audioCtx.createMediaElementSource(endMedia);
                        sEnd.connect(dest);
                        sEnd.connect(audioCtx.destination);
                    }
                    endMedia.muted = false;
                    endMedia.currentTime = 0;
                    await endMedia.play();
                    await new Promise(r => {
                        endMedia.onended = r;
                        setTimeout(r, (endMedia.duration * 1000) + 1000);
                    });
                } else {
                    // صورة - عرض لمدة 5 ثواني
                    await new Promise(r => setTimeout(r, 5000));
                }
                isEndPhase = false;
            }

            recorder.stopRecording(() => {
                const a = document.createElement('a');
                a.href = URL.createObjectURL(recorder.getBlob());
                a.download = `Quran_HD_Final.webm`;
                a.click();
                btn.disabled = false;
                btn.innerText = "🚀 تصدير الفيديو (جودة HD)";
                isEndPhase = false;
                isOutroPhase = false;
            });
        }

        // 🤖 التصدير الذكي - مزامنة تلقائية بالـ AI
        async function smartExport() {
            if (clips.length === 0) {
                alert("⚠️ يجب جلب الآيات أولاً!");
                return;
            }

            const btn = document.getElementById('smartExportBtn');
            btn.disabled = true;
            btn.innerText = "🤖 جاري المزامنة الذكية...";

            try {
                // التحقق من دعم Web Speech API
                if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                    alert("⚠️ المتصفح لا يدعم التعرف على الصوت. استخدم Chrome أو Edge");
                    btn.disabled = false;
                    btn.innerText = "🤖 تصدير ذكي (مزامنة تلقائية)";
                    return;
                }

                // مسح المزامنة القديمة
                clips.forEach(c => c.syncTime = undefined);
                videoEndTime = 0;

                // إنشاء Speech Recognition
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                const recognition = new SpeechRecognition();
                recognition.lang = 'ar-SA';
                recognition.continuous = true;
                recognition.interimResults = true;

                let currentClipIndex = 0;
                let recognizedText = '';

                recognition.onresult = (event) => {
                    const transcript = Array.from(event.results)
                        .map(result => result[0].transcript)
                        .join('');

                    recognizedText = transcript;
                    console.log("🎤 سمعت:", transcript);

                    // مقارنة مع نص الآية الحالية
                    if (currentClipIndex < clips.length) {
                        const currentAyah = clips[currentClipIndex].ar;
                        const similarity = calculateSimilarity(transcript, currentAyah);

                        console.log(`📊 التشابه مع الآية ${currentClipIndex + 1}: ${similarity}%`);

                        // إذا كان التشابه أكثر من 30%، سجل الوقت
                        if (similarity > 30 && clips[currentClipIndex].syncTime === undefined) {
                            clips[currentClipIndex].syncTime = player.currentTime;
                            console.log(`✅ تم تسجيل الآية ${currentClipIndex + 1} عند ${player.currentTime.toFixed(2)} ثانية`);
                            currentClipIndex++;
                            renderTimeline();

                            if (currentClipIndex >= clips.length) {
                                recognition.stop();
                            }
                        }
                    }
                };

                recognition.onerror = (event) => {
                    console.error("❌ خطأ في التعرف على الصوت:", event.error);
                };

                recognition.onend = () => {
                    console.log("🎤 انتهى التعرف على الصوت");
                };

                // بدء التشغيل والتعرف
                btn.innerText = "🎤 جاري الاستماع...";
                player.currentTime = 0;
                await player.play();
                recognition.start();

                // انتظر حتى ينتهي الصوت أو يتم مزامنة كل الآيات
                await new Promise((resolve) => {
                    const checker = setInterval(() => {
                        if (player.ended || currentClipIndex >= clips.length) {
                            clearInterval(checker);
                            recognition.stop();
                            videoEndTime = player.currentTime;
                            resolve();
                        }
                    }, 500);
                });

                player.pause();
                btn.innerText = "✅ تمت المزامنة! اضغط تصدير";
                btn.disabled = false;

                // عرض النتائج
                const syncedCount = clips.filter(c => c.syncTime !== undefined).length;
                alert(`🎉 تمت مزامنة ${syncedCount} من ${clips.length} آية!\n\nيمكنك الآن الضغط على "تصدير سريع"`);

            } catch (error) {
                console.error("❌ خطأ:", error);
                alert("❌ حدث خطأ في المزامنة الذكية");
                btn.disabled = false;
                btn.innerText = "🤖 تصدير ذكي (مزامنة تلقائية)";
            }
        }

        // دالة حساب التشابه بين نصين
        function calculateSimilarity(text1, text2) {
            // تنظيف النصوص
            const clean1 = text1.replace(/[^\u0600-\u06FF\s]/g, '').trim().toLowerCase();
            const clean2 = text2.replace(/[^\u0600-\u06FF\s]/g, '').trim().toLowerCase();

            const words1 = clean1.split(/\s+/);
            const words2 = clean2.split(/\s+/);

            // حساب الكلمات المشتركة
            let matches = 0;
            words1.forEach(word => {
                if (words2.some(w => w.includes(word) || word.includes(w))) {
                    matches++;
                }
            });

            return Math.round((matches / Math.max(words1.length, words2.length)) * 100);
        }

        // 🔄 تبسيط التصدير الذكي - استخدام مزامنة تلقائية بسيطة
        smartExport = async function () {
            if (clips.length === 0) {
                alert("⚠️ يجب جلب الآيات أولاً!");
                return;
            }

            const btn = document.getElementById('smartExportBtn');
            btn.disabled = true;
            btn.innerText = "⏱️ جاري المزامنة التلقائية...";

            try {
                clips.forEach(c => c.syncTime = undefined);
                player.currentTime = 0;
                await player.play();

                await new Promise(resolve => {
                    player.onended = resolve;
                    setTimeout(resolve, (player.duration || 60) * 1000 + 2000);
                });

                const totalDuration = player.duration || player.currentTime;
                const avgDuration = totalDuration / clips.length;
                let currentTime = 0;

                clips.forEach((clip, i) => {
                    clip.syncTime = currentTime;
                    currentTime += avgDuration;
                });

                videoEndTime = totalDuration;
                renderTimeline();
                btn.innerText = "✅ تمت المزامنة!";
                btn.disabled = false;

                alert(`🎉 تمت مزامنة ${clips.length} آية!\n\nمدة كل آية: ${avgDuration.toFixed(1)} ثانية\n\nاضغط "تصدير سريع"`);
            } catch (error) {
                alert("❌ حدث خطأ");
                btn.disabled = false;
                btn.innerText = "🤖 تصدير ذكي";
            }
        };

        draw();
    </script>
</body>

</html>
